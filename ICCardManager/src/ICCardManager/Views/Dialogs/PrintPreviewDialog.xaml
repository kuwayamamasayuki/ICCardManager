<Window x:Class="ICCardManager.Views.Dialogs.PrintPreviewDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="clr-namespace:ICCardManager.ViewModels"
        xmlns:common="clr-namespace:ICCardManager.Common"
        mc:Ignorable="d"
        d:DataContext="{d:DesignInstance Type=vm:PrintPreviewViewModel}"
        Title="{Binding DocumentTitle, StringFormat='印刷プレビュー - {0}'}"
        Height="700"
        Width="950"
        WindowStartupLocation="CenterOwner"
        ResizeMode="CanResize"
        PreviewKeyDown="Window_PreviewKeyDown"
        AutomationProperties.Name="印刷プレビューダイアログ"
        AutomationProperties.HelpText="帳票の印刷プレビューを表示します。ズームやページ送りができます。←→キーでページ移動できます。">

    <Window.InputBindings>
        <!-- テンキーのズーム操作 -->
        <KeyBinding Key="Add" Modifiers="Ctrl" Command="{Binding ZoomInCommand}"/>
        <KeyBinding Key="Subtract" Modifiers="Ctrl" Command="{Binding ZoomOutCommand}"/>
        <!-- 通常キーボードのズーム操作（OemPlus/OemMinusはShift不要版） -->
        <KeyBinding Key="OemPlus" Modifiers="Ctrl" Command="{Binding ZoomInCommand}"/>
        <KeyBinding Key="OemMinus" Modifiers="Ctrl" Command="{Binding ZoomOutCommand}"/>
    </Window.InputBindings>

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        <common:OrientationToDisplayNameConverter x:Key="OrientationConverter"/>
        <DropShadowEffect x:Key="DropShadowEffect"
                          BlurRadius="15"
                          ShadowDepth="5"
                          Opacity="0.4"/>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- ツールバー -->
        <Border Grid.Row="0" Background="{DynamicResource NeutralBackgroundBrush}" Padding="10" BorderBrush="{DynamicResource SubtleBorderBrush}" BorderThickness="0,0,0,1">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- ズームコントロール -->
                <StackPanel Grid.Column="0" Orientation="Horizontal" Margin="0,0,20,0">
                    <TextBlock Text="ズーム:"
                               VerticalAlignment="Center"
                               Margin="0,0,10,0"/>
                    <Button Content="−"
                            Command="{Binding ZoomOutCommand}"
                            Width="30"
                            Height="28"
                            FontSize="{DynamicResource BaseFontSize}"
                            FontWeight="Bold"
                            ToolTip="縮小"
                            AutomationProperties.Name="ズーム縮小"/>
                    <ComboBox ItemsSource="{Binding ZoomLevels}"
                              SelectedItem="{Binding ZoomLevel}"
                              Width="80"
                              Height="28"
                              Margin="5,0"
                              VerticalContentAlignment="Center"
                              AutomationProperties.Name="ズーム倍率">
                        <ComboBox.ItemTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding StringFormat={}{0}%}"/>
                            </DataTemplate>
                        </ComboBox.ItemTemplate>
                    </ComboBox>
                    <Button Content="＋"
                            Command="{Binding ZoomInCommand}"
                            Width="30"
                            Height="28"
                            FontSize="{DynamicResource BaseFontSize}"
                            FontWeight="Bold"
                            ToolTip="拡大"
                            AutomationProperties.Name="ズーム拡大"/>
                    <Button Content="100%"
                            Command="{Binding ResetZoomCommand}"
                            Height="28"
                            Padding="10,0"
                            Margin="10,0,0,0"
                            ToolTip="100%にリセット"
                            AutomationProperties.Name="ズームリセット"/>
                </StackPanel>

                <!-- ページナビゲーション -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" Margin="0,0,20,0">
                    <TextBlock Text="ページ:"
                               VerticalAlignment="Center"
                               Margin="0,0,10,0"/>
                    <Button Content="⏮"
                            Click="FirstPageButton_Click"
                            Width="30"
                            Height="28"
                            FontSize="{DynamicResource SmallFontSize}"
                            ToolTip="最初のページ"
                            AutomationProperties.Name="最初のページ"/>
                    <Button Content="◀"
                            Click="PreviousPageButton_Click"
                            Width="30"
                            Height="28"
                            FontSize="{DynamicResource SmallFontSize}"
                            Margin="2,0"
                            ToolTip="前のページ"
                            AutomationProperties.Name="前のページ"/>
                    <Border Background="White"
                            BorderBrush="{DynamicResource SubtleBorderBrush}"
                            BorderThickness="1"
                            Padding="10,4"
                            VerticalAlignment="Center">
                        <TextBlock x:Name="PageDisplayTextBlock"
                                   Text="1 / 1 ページ"
                                   FontWeight="Bold"
                                   AutomationProperties.LiveSetting="Polite"/>
                    </Border>
                    <Button Content="▶"
                            Click="NextPageButton_Click"
                            Width="30"
                            Height="28"
                            FontSize="{DynamicResource SmallFontSize}"
                            Margin="2,0"
                            ToolTip="次のページ"
                            AutomationProperties.Name="次のページ"/>
                    <Button Content="⏭"
                            Click="LastPageButton_Click"
                            Width="30"
                            Height="28"
                            FontSize="{DynamicResource SmallFontSize}"
                            ToolTip="最後のページ"
                            AutomationProperties.Name="最後のページ"/>
                </StackPanel>

                <!-- 用紙設定 -->
                <StackPanel Grid.Column="3" Orientation="Horizontal">
                    <TextBlock Text="用紙方向:"
                               VerticalAlignment="Center"
                               Margin="0,0,10,0"/>
                    <ComboBox ItemsSource="{Binding Orientations}"
                              SelectedItem="{Binding SelectedOrientation}"
                              Width="140"
                              Height="28"
                              VerticalContentAlignment="Center"
                              AutomationProperties.Name="用紙方向">
                        <ComboBox.ItemTemplate>
                            <DataTemplate>
                                <TextBlock>
                                    <TextBlock.Text>
                                        <Binding Converter="{StaticResource OrientationConverter}"/>
                                    </TextBlock.Text>
                                </TextBlock>
                            </DataTemplate>
                        </ComboBox.ItemTemplate>
                    </ComboBox>
                    <Button Content="印刷"
                            Command="{Binding PrintCommand}"
                            Height="28"
                            Padding="20,0"
                            Margin="15,0,0,0"
                            Background="{DynamicResource HeaderBackgroundBrush}"
                            Foreground="{DynamicResource OnPrimaryBrush}"
                            FontWeight="Bold"
                            ToolTip="印刷ダイアログを開く"
                            AutomationProperties.Name="印刷を実行"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- プレビューエリア -->
        <Border Grid.Row="1" Background="{DynamicResource MutedTextBrush}" Padding="20">
            <ScrollViewer HorizontalScrollBarVisibility="Auto"
                          VerticalScrollBarVisibility="Auto"
                          PanningMode="Both">
                <Border Background="White"
                        BorderBrush="{DynamicResource WaitingForegroundBrush}"
                        BorderThickness="1"
                        HorizontalAlignment="Center"
                        VerticalAlignment="Top"
                        Effect="{StaticResource DropShadowEffect}">
                    <!-- FlowDocumentPageViewerを使用してページ単位の表示を実現 -->
                    <FlowDocumentPageViewer x:Name="DocumentViewer"
                                            Zoom="{Binding ZoomLevel}"
                                            AutomationProperties.Name="ドキュメントプレビュー"/>
                </Border>
            </ScrollViewer>
        </Border>

        <!-- フッター -->
        <Border Grid.Row="2" Background="{DynamicResource NeutralBackgroundBrush}" Padding="15" BorderBrush="{DynamicResource SubtleBorderBrush}" BorderThickness="0,1,0,0">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- ステータスメッセージ -->
                <TextBlock Grid.Column="0"
                           Text="{Binding StatusMessage}"
                           Foreground="{DynamicResource PrimaryBrush}"
                           FontWeight="Bold"
                           VerticalAlignment="Center"
                           AutomationProperties.LiveSetting="Polite"/>

                <!-- 閉じるボタン -->
                <Button Grid.Column="1"
                        Content="閉じる"
                        Click="CloseButton_Click"
                        Padding="20,8"
                        MinWidth="100"
                        IsCancel="True"
                        AutomationProperties.Name="閉じる"
                        ToolTip="ダイアログを閉じる (Escape)"/>
            </Grid>
        </Border>

        <!-- 処理中オーバーレイ -->
        <Border Grid.RowSpan="3"
                Background="{DynamicResource OverlayBrush}"
                Visibility="{Binding IsBusy, Converter={StaticResource BoolToVisibilityConverter}}">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                <ProgressBar IsIndeterminate="True" Width="200" Height="4"/>
                <TextBlock Text="{Binding BusyMessage}"
                           Foreground="{DynamicResource OnPrimaryBrush}"
                           FontSize="{DynamicResource BaseFontSize}"
                           Margin="0,10,0,0"
                           HorizontalAlignment="Center"/>
            </StackPanel>
        </Border>
    </Grid>
</Window>
