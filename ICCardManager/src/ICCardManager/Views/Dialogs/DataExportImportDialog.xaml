<Window x:Class="ICCardManager.Views.Dialogs.DataExportImportDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="clr-namespace:ICCardManager.ViewModels"
        mc:Ignorable="d"
        d:DataContext="{d:DesignInstance Type=vm:DataExportImportViewModel}"
        Title="データエクスポート/インポート"
        Height="750"
        Width="800"
        WindowStartupLocation="CenterOwner"
        ResizeMode="CanResize"
        MinHeight="600"
        MinWidth="700"
        AutomationProperties.Name="データエクスポート/インポートダイアログ"
        AutomationProperties.HelpText="カード、職員、履歴データのCSVエクスポート・インポートができます。Escapeキーで閉じます。">

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        <vm:DataTypeToDisplayNameConverter x:Key="DataTypeConverter"/>
        <vm:ImportActionToDisplayNameConverter x:Key="ImportActionConverter"/>
        <!-- Issue #511: 追加のコンバーター -->
        <common:InverseBooleanConverter x:Key="InverseBoolConverter" xmlns:common="clr-namespace:ICCardManager.Common"/>
        <common:BoolToVisibilityConverter x:Key="InverseBoolToVisibilityConverter" xmlns:common="clr-namespace:ICCardManager.Common"/>
        <!-- Issue #638: 文字列/整数値用Visibilityコンバーター -->
        <common:StringToVisibilityConverter x:Key="StringToVisibilityConverter" xmlns:common="clr-namespace:ICCardManager.Common"/>
        <common:IntToVisibilityConverter x:Key="IntToVisibilityConverter" xmlns:common="clr-namespace:ICCardManager.Common"/>
    </Window.Resources>

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" MaxHeight="350"/>  <!-- Row 0: Export/Import設定（スクロール可能） -->
            <RowDefinition Height="Auto"/>   <!-- Row 1: アクションボタン（常に表示） -->
            <RowDefinition Height="Auto"/>   <!-- Row 2: Status message -->
            <RowDefinition Height="*" MinHeight="150"/>  <!-- Row 3: プレビュー結果（サマリー + DataGrid） -->
            <RowDefinition Height="Auto"/>   <!-- Row 4: エラー一覧 -->
            <RowDefinition Height="Auto"/>   <!-- Row 5: Close button -->
        </Grid.RowDefinitions>

        <!-- エクスポート/インポート設定（スクロール可能エリア） -->
        <ScrollViewer Grid.Row="0"
                      VerticalScrollBarVisibility="Auto"
                      Margin="0,0,0,10">
        <StackPanel>

        <!-- エクスポート -->
        <GroupBox Header="エクスポート" Margin="0,0,0,15" Padding="15">
            <StackPanel>
                <TextBlock Text="データをCSVファイルに出力します"
                           Foreground="Gray"
                           FontSize="{DynamicResource SmallFontSize}"
                           Margin="0,0,0,10"/>

                <!-- データタイプ選択 -->
                <Grid Margin="0,0,0,10">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="120"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <TextBlock Text="データ種別:"
                               VerticalAlignment="Center"
                               FontSize="{DynamicResource BaseFontSize}"/>
                    <ComboBox Grid.Column="1"
                              ItemsSource="{Binding ExportDataTypes}"
                              SelectedItem="{Binding SelectedExportType}"
                              Padding="8"
                              HorizontalAlignment="Left"
                              Width="200"
                              AutomationProperties.Name="エクスポートするデータ種別"
                              ToolTip="エクスポートするデータの種類を選択します">
                        <ComboBox.ItemTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding Converter={StaticResource DataTypeConverter}}"/>
                            </DataTemplate>
                        </ComboBox.ItemTemplate>
                    </ComboBox>
                </Grid>

                <!-- 日付範囲（履歴の場合のみ表示） -->
                <Grid Margin="0,0,0,10"
                      Visibility="{Binding IsLedgerExportSelected, Converter={StaticResource BoolToVisibilityConverter}}">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="120"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <TextBlock Text="対象期間:"
                               VerticalAlignment="Center"
                               FontSize="{DynamicResource BaseFontSize}"/>
                    <DatePicker Grid.Column="1"
                                SelectedDate="{Binding ExportStartDate}"
                                Padding="5"
                                Width="130"
                                AutomationProperties.Name="開始日"
                                ToolTip="エクスポート対象期間の開始日"/>
                    <TextBlock Grid.Column="2"
                               Text=" ～ "
                               VerticalAlignment="Center"
                               Margin="5,0"/>
                    <DatePicker Grid.Column="3"
                                SelectedDate="{Binding ExportEndDate}"
                                Padding="5"
                                Width="130"
                                AutomationProperties.Name="終了日"
                                ToolTip="エクスポート対象期間の終了日"/>
                </Grid>

                <!-- 削除済みを含む -->
                <Grid Margin="0,0,0,10">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="120"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <CheckBox Grid.Column="1"
                              Content="削除済みデータを含める"
                              IsChecked="{Binding IncludeDeletedInExport}"
                              VerticalAlignment="Center"
                              AutomationProperties.Name="削除済みデータを含める"
                              ToolTip="論理削除されたデータもエクスポートに含めます"/>
                </Grid>

                <!-- エクスポートボタン -->
                <Button Content="CSVエクスポート"
                        Command="{Binding ExportCommand}"
                        Padding="15,10"
                        HorizontalAlignment="Left"
                        Background="#4CAF50"
                        Foreground="White"
                        AutomationProperties.Name="CSVエクスポート実行"
                        ToolTip="選択したデータをCSVファイルにエクスポートします"/>

                <!-- 最後にエクスポートしたファイル -->
                <StackPanel Orientation="Horizontal"
                            Margin="0,10,0,0"
                            Visibility="{Binding LastExportedFile, Converter={StaticResource StringToVisibilityConverter}}">
                    <TextBlock Text="出力先: "
                               Foreground="Gray"
                               FontSize="{DynamicResource SmallFontSize}"
                               VerticalAlignment="Center"/>
                    <TextBlock Text="{Binding LastExportedFile}"
                               Foreground="Gray"
                               FontSize="{DynamicResource SmallFontSize}"
                               VerticalAlignment="Center"
                               TextTrimming="CharacterEllipsis"
                               MaxWidth="300"/>
                    <Button Content="開く"
                            Command="{Binding OpenExportedFileCommand}"
                            Padding="5,2"
                            Margin="10,0,0,0"
                            FontSize="{DynamicResource SmallFontSize}"/>
                    <Button Content="フォルダを開く"
                            Command="{Binding OpenExportFolderCommand}"
                            Padding="5,2"
                            Margin="5,0,0,0"
                            FontSize="{DynamicResource SmallFontSize}"/>
                </StackPanel>
            </StackPanel>
        </GroupBox>

        <!-- インポート -->
        <GroupBox Header="インポート" Margin="0,0,0,15" Padding="15">
            <StackPanel>
                <TextBlock Text="CSVファイルからデータを取り込みます"
                           Foreground="Gray"
                           FontSize="{DynamicResource SmallFontSize}"
                           Margin="0,0,0,10"/>

                <!-- データタイプ選択 -->
                <Grid Margin="0,0,0,10">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="120"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <TextBlock Text="データ種別:"
                               VerticalAlignment="Center"
                               FontSize="{DynamicResource BaseFontSize}"/>
                    <ComboBox Grid.Column="1"
                              ItemsSource="{Binding ImportDataTypes}"
                              SelectedItem="{Binding SelectedImportType}"
                              Padding="8"
                              HorizontalAlignment="Left"
                              Width="200"
                              AutomationProperties.Name="インポートするデータ種別"
                              ToolTip="インポートするデータの種類を選択します">
                        <ComboBox.ItemTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding Converter={StaticResource DataTypeConverter}}"/>
                            </DataTemplate>
                        </ComboBox.ItemTemplate>
                    </ComboBox>
                </Grid>

                <!-- 既存スキップ -->
                <Grid Margin="0,0,0,10">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="120"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <CheckBox Grid.Column="1"
                              Content="既存データはスキップする"
                              IsChecked="{Binding SkipExistingOnImport}"
                              VerticalAlignment="Center"
                              AutomationProperties.Name="既存データをスキップ"
                              ToolTip="同じIDmのデータが既に存在する場合はスキップします（オフの場合は上書き更新）"/>
                </Grid>

                <!-- Issue #511: カード指定セクション（利用履歴インポート時のみ表示） -->
                <Border BorderBrush="#E0E0E0"
                        BorderThickness="1"
                        CornerRadius="4"
                        Padding="10"
                        Margin="0,0,0,10"
                        Background="#FAFAFA"
                        Visibility="{Binding IsLedgerImportSelected, Converter={StaticResource BoolToVisibilityConverter}}">
                    <StackPanel>
                        <TextBlock Text="インポート先カード"
                                   FontWeight="Bold"
                                   FontSize="{DynamicResource BaseFontSize}"
                                   Margin="0,0,0,5"/>
                        <TextBlock Text="CSVにカードIDmが含まれない場合、ここで指定したカードの履歴としてインポートします"
                                   Foreground="Gray"
                                   FontSize="{DynamicResource SmallFontSize}"
                                   TextWrapping="Wrap"
                                   Margin="0,0,0,10"/>

                        <!-- 方法1: 一覧から選択 -->
                        <RadioButton Content="登録済みカード一覧から選択"
                                     IsChecked="{Binding UseCardListSelection}"
                                     GroupName="CardSelectionMethod"
                                     Margin="0,0,0,5"
                                     AutomationProperties.Name="登録済みカード一覧から選択"
                                     ToolTip="既に登録されているカードの一覧から選択します"/>
                        <ComboBox ItemsSource="{Binding AvailableCards}"
                                  SelectedItem="{Binding SelectedTargetCard}"
                                  IsEnabled="{Binding UseCardListSelection}"
                                  Padding="8"
                                  Margin="20,0,0,10"
                                  HorizontalAlignment="Left"
                                  Width="350"
                                  AutomationProperties.Name="インポート先カード選択"
                                  ToolTip="インポート先のカードを選択します">
                            <ComboBox.ItemTemplate>
                                <DataTemplate>
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="{Binding CardType}" FontWeight="SemiBold"/>
                                        <TextBlock Text=" " />
                                        <TextBlock Text="{Binding CardNumber}"/>
                                        <TextBlock Text=" (" Foreground="Gray"/>
                                        <TextBlock Text="{Binding CardIdm}" Foreground="Gray" FontSize="{DynamicResource SmallFontSize}"/>
                                        <TextBlock Text=")" Foreground="Gray"/>
                                    </StackPanel>
                                </DataTemplate>
                            </ComboBox.ItemTemplate>
                        </ComboBox>

                        <!-- 方法2: カードタッチ -->
                        <RadioButton Content="カードをタッチして指定"
                                     IsChecked="{Binding UseCardListSelection, Converter={StaticResource InverseBoolConverter}}"
                                     IsEnabled="{Binding IsCardReaderAvailable}"
                                     GroupName="CardSelectionMethod"
                                     Margin="0,0,0,5"
                                     AutomationProperties.Name="カードをタッチして指定"
                                     ToolTip="交通系ICカードをリーダーにタッチしてカードを指定します">
                            <RadioButton.Style>
                                <Style TargetType="RadioButton">
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsCardReaderAvailable}" Value="False">
                                            <Setter Property="Foreground" Value="Gray"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </RadioButton.Style>
                        </RadioButton>
                        <StackPanel Orientation="Horizontal" Margin="20,0,0,5">
                            <Button Content="カードをタッチ"
                                    Command="{Binding StartCardTouchCommand}"
                                    Padding="10,5"
                                    Background="#2196F3"
                                    Foreground="White"
                                    AutomationProperties.Name="カードタッチ開始"
                                    ToolTip="カードリーダーでカードを読み取ります">
                                <Button.Style>
                                    <Style TargetType="Button">
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding UseCardListSelection}" Value="True">
                                                <Setter Property="IsEnabled" Value="False"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding IsCardReaderAvailable}" Value="False">
                                                <Setter Property="IsEnabled" Value="False"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                            </Button>
                            <Button Content="キャンセル"
                                    Command="{Binding CancelCardTouchCommand}"
                                    Padding="10,5"
                                    Margin="5,0,0,0"
                                    Visibility="{Binding IsWaitingForCardTouch, Converter={StaticResource BoolToVisibilityConverter}}"
                                    AutomationProperties.Name="カードタッチキャンセル"/>
                            <TextBlock Text="{Binding TouchedCardInfo}"
                                       VerticalAlignment="Center"
                                       Margin="10,0,0,0"
                                       FontSize="{DynamicResource BaseFontSize}">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="Foreground" Value="#1565C0"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding TouchedCardInfo}" Value="未登録のカードです">
                                                <Setter Property="Foreground" Value="#D32F2F"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding TouchedCardInfo}" Value="カードをタッチしてください...">
                                                <Setter Property="Foreground" Value="Gray"/>
                                                <Setter Property="FontStyle" Value="Italic"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>
                        </StackPanel>

                        <!-- カードリーダー未接続の場合の注意 -->
                        <TextBlock Text="※ カードリーダーが接続されていません"
                                   Foreground="#D32F2F"
                                   FontSize="{DynamicResource SmallFontSize}"
                                   Margin="20,5,0,0"
                                   Visibility="{Binding IsCardReaderAvailable, Converter={StaticResource InverseBoolToVisibilityConverter}, ConverterParameter=invert}"/>

                        <!-- クリアボタン -->
                        <Button Content="指定をクリア"
                                Command="{Binding ClearTargetCardCommand}"
                                Padding="8,4"
                                Margin="0,10,0,0"
                                HorizontalAlignment="Left"
                                FontSize="{DynamicResource SmallFontSize}"
                                AutomationProperties.Name="カード指定をクリア"
                                ToolTip="選択したカードの指定を解除します"/>
                    </StackPanel>
                </Border>

                <!-- 最後にインポートしたファイル -->
                <TextBlock Text="{Binding LastImportedFile, StringFormat=インポート完了: {0}}"
                           Foreground="Gray"
                           FontSize="{DynamicResource SmallFontSize}"
                           TextTrimming="CharacterEllipsis"
                           Visibility="{Binding LastImportedFile, Converter={StaticResource StringToVisibilityConverter}}"/>
            </StackPanel>
        </GroupBox>

        </StackPanel>
        </ScrollViewer>

        <!-- アクションボタン（常に表示） -->
        <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,0,0,10">
            <Button Content="プレビュー"
                    Command="{Binding PreviewImportCommand}"
                    Padding="15,10"
                    Background="#FF9800"
                    Foreground="White"
                    AutomationProperties.Name="インポートプレビュー"
                    ToolTip="CSVファイルの内容をプレビューし、変更点を確認します"/>
            <Button Content="インポート実行"
                    Command="{Binding ExecuteImportCommand}"
                    Padding="15,10"
                    Margin="10,0,0,0"
                    Background="#4CAF50"
                    Foreground="White"
                    IsEnabled="{Binding HasPreview}"
                    AutomationProperties.Name="インポート実行"
                    ToolTip="プレビュー済みのデータをインポートします"/>
            <Button Content="直接インポート"
                    Command="{Binding ImportCommand}"
                    Padding="15,10"
                    Margin="10,0,0,0"
                    Background="#2196F3"
                    Foreground="White"
                    AutomationProperties.Name="直接CSVインポート"
                    ToolTip="プレビューなしで直接インポートします"/>
        </StackPanel>

        <!-- ステータスメッセージ -->
        <Border Grid.Row="2"
                Background="#E3F2FD"
                Padding="10"
                Margin="0,0,0,10"
                CornerRadius="5"
                Visibility="{Binding StatusMessage, Converter={StaticResource StringToVisibilityConverter}}">
            <TextBlock Text="{Binding StatusMessage}"
                       Foreground="#1565C0"
                       FontSize="{DynamicResource BaseFontSize}"
                       TextWrapping="Wrap"/>
        </Border>

        <!-- プレビュー結果セクション -->
        <Grid Grid.Row="3" Margin="0,0,0,10"
              Visibility="{Binding HasPreview, Converter={StaticResource BoolToVisibilityConverter}}">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>  <!-- サマリーバナー -->
                <RowDefinition Height="*"/>     <!-- DataGrid -->
            </Grid.RowDefinitions>

            <!-- プレビューサマリー -->
            <Border Grid.Row="0" Background="#FFF3E0" Padding="10" CornerRadius="3" Margin="0,0,0,5">
                <StackPanel>
                    <TextBlock FontWeight="Bold" FontSize="{DynamicResource BaseFontSize}">
                        <Run Text="プレビュー結果: "/>
                        <Run Text="{Binding PreviewSummary}" Foreground="#E65100"/>
                    </TextBlock>
                    <TextBlock Text="{Binding ImportPreviewFile, StringFormat=ファイル: {0}}"
                               Foreground="Gray"
                               FontSize="{DynamicResource SmallFontSize}"
                               Margin="0,5,0,0"
                               TextTrimming="CharacterEllipsis"/>
                </StackPanel>
            </Border>

            <!-- プレビューDataGrid -->
            <DataGrid Grid.Row="1"
                      ItemsSource="{Binding PreviewItems}"
                      AutoGenerateColumns="False"
                      IsReadOnly="True"
                      CanUserAddRows="False"
                      CanUserDeleteRows="False"
                      SelectionMode="Single"
                      GridLinesVisibility="Horizontal"
                      HeadersVisibility="Column"
                      BorderThickness="1"
                      BorderBrush="#DDD"
                      MinHeight="120"
                      AutomationProperties.Name="インポートプレビュー一覧">
                <DataGrid.Columns>
                    <DataGridTextColumn Header="行" Binding="{Binding LineNumber}" Width="50"/>
                    <DataGridTextColumn Header="IDm" Binding="{Binding Idm}" Width="140"/>
                    <DataGridTextColumn Header="名前" Binding="{Binding Name}" Width="120"/>
                    <DataGridTextColumn Header="追加情報" Binding="{Binding AdditionalInfo}" Width="100"/>
                    <DataGridTemplateColumn Header="アクション" Width="80">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding Action, Converter={StaticResource ImportActionConverter}}"
                                           Padding="5,2">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding Action}" Value="Insert">
                                                    <Setter Property="Foreground" Value="#4CAF50"/>
                                                    <Setter Property="FontWeight" Value="Bold"/>
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding Action}" Value="Update">
                                                    <Setter Property="Foreground" Value="#FF9800"/>
                                                    <Setter Property="FontWeight" Value="Bold"/>
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding Action}" Value="Skip">
                                                    <Setter Property="Foreground" Value="#9E9E9E"/>
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding Action}" Value="Restore">
                                                    <Setter Property="Foreground" Value="#2196F3"/>
                                                    <Setter Property="FontWeight" Value="Bold"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                    <DataGridTemplateColumn Header="変更点" Width="*">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding ChangesSummary}"
                                           Foreground="#E65100"
                                           TextTrimming="CharacterEllipsis"
                                           ToolTip="{Binding ChangesSummary}"
                                           Padding="5,2">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding HasChanges}" Value="True">
                                                    <Setter Property="FontStyle" Value="Italic"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                </DataGrid.Columns>
                <DataGrid.RowDetailsTemplate>
                    <DataTemplate>
                        <Border Background="#FFF8E1" Padding="10" Margin="0,2"
                                Visibility="{Binding HasChanges, Converter={StaticResource BoolToVisibilityConverter}}">
                            <StackPanel>
                                <TextBlock Text="変更内容の詳細:" FontWeight="Bold" Margin="0,0,0,5"/>
                                <ItemsControl ItemsSource="{Binding Changes}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding DisplayText}"
                                                       Foreground="#795548"
                                                       Margin="10,2,0,2"/>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </StackPanel>
                        </Border>
                    </DataTemplate>
                </DataGrid.RowDetailsTemplate>
            </DataGrid>
        </Grid>

        <!-- エラー一覧セクション -->
        <Border Grid.Row="4" Background="#FFF3E0" Padding="10" CornerRadius="3" Margin="0,0,0,10"
                Visibility="{Binding ImportErrors.Count, Converter={StaticResource IntToVisibilityConverter}}">
            <StackPanel>
                <TextBlock Text="エラー詳細" FontWeight="Bold" FontSize="{DynamicResource BaseFontSize}" Margin="0,0,0,5"/>
                <ListBox ItemsSource="{Binding ImportErrors}"
                         Background="#FFF3E0"
                         BorderThickness="0"
                         MaxHeight="150"
                         AutomationProperties.Name="インポートエラー一覧">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding}"
                                       Foreground="#E65100"
                                       FontSize="{DynamicResource SmallFontSize}"/>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
            </StackPanel>
        </Border>

        <!-- 閉じるボタン -->
        <StackPanel Grid.Row="5"
                    Orientation="Horizontal"
                    HorizontalAlignment="Right"
                    Margin="0,15,0,0">
            <Button Content="閉じる"
                    Click="CloseButton_Click"
                    Padding="20,10"
                    MinWidth="100"
                    IsCancel="True"
                    AutomationProperties.Name="ダイアログを閉じる"
                    ToolTip="ダイアログを閉じます (Escape)"/>
        </StackPanel>

        <!-- 処理中オーバーレイ -->
        <Border Grid.RowSpan="6"
                Background="#80000000"
                Visibility="{Binding IsBusy, Converter={StaticResource BoolToVisibilityConverter}}">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                <ProgressBar IsIndeterminate="True" Width="200" Height="4"/>
                <TextBlock Text="{Binding BusyMessage}"
                           Foreground="White"
                           FontSize="{DynamicResource BaseFontSize}"
                           Margin="0,10,0,0"
                           HorizontalAlignment="Center"/>
            </StackPanel>
        </Border>
    </Grid>
</Window>
