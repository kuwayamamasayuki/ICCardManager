<Window x:Class="ICCardManager.Views.Dialogs.CardManageDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="clr-namespace:ICCardManager.ViewModels"
        mc:Ignorable="d"
        d:DataContext="{d:DesignInstance Type=vm:CardManageViewModel}"
        Title="交通系ICカード管理"
        Height="600"
        Width="900"
        WindowStartupLocation="CenterOwner"
        ResizeMode="CanResize"
        AutomationProperties.Name="交通系ICカード管理ダイアログ"
        AutomationProperties.HelpText="交通系ICカードの登録・編集・削除ができます。カードをタッチして新規登録できます。">

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
    </Window.Resources>

    <Grid Margin="15">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="350"/>
        </Grid.ColumnDefinitions>

        <!-- 左側: カード一覧 -->
        <Grid Grid.Column="0" Margin="0,0,15,0">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- ヘッダー -->
            <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,10">
                <TextBlock Text="登録済み交通系ICカード一覧"
                           FontSize="{DynamicResource LargeFontSize}"
                           FontWeight="Bold"
                           VerticalAlignment="Center"/>
                <TextBlock Text="{Binding Cards.Count, StringFormat=' ({0}件)'}"
                           FontSize="{DynamicResource BaseFontSize}"
                           Foreground="Gray"
                           VerticalAlignment="Center"
                           Margin="5,0,0,0"/>
            </StackPanel>

            <!-- カード一覧 -->
            <DataGrid Grid.Row="1"
                      ItemsSource="{Binding Cards}"
                      SelectedItem="{Binding SelectedCard}"
                      AutoGenerateColumns="False"
                      IsReadOnly="True"
                      SelectionMode="Single"
                      CanUserAddRows="False"
                      CanUserDeleteRows="False"
                      GridLinesVisibility="Horizontal"
                      HeadersVisibility="Column"
                      RowHeaderWidth="0"
                      AutomationProperties.Name="カード一覧"
                      AutomationProperties.HelpText="登録されている交通系ICカードの一覧です。選択して編集や削除ができます。">
                <DataGrid.Columns>
                    <DataGridTextColumn Header="種別" Binding="{Binding CardType}" Width="100"/>
                    <DataGridTextColumn Header="管理番号" Binding="{Binding CardNumber}" Width="100"/>
                    <DataGridTextColumn Header="備考" Binding="{Binding Note}" Width="*"/>
                    <DataGridTemplateColumn Header="状態" Width="70">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock>
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsLent}" Value="True">
                                                    <Setter Property="Text" Value="貸出中"/>
                                                    <Setter Property="Foreground" Value="OrangeRed"/>
                                                    <Setter Property="FontWeight" Value="Bold"/>
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding IsLent}" Value="False">
                                                    <Setter Property="Text" Value="利用可"/>
                                                    <Setter Property="Foreground" Value="DarkGreen"/>
                                                    <Setter Property="FontWeight" Value="Bold"/>
                                                </DataTrigger>
                                                <!-- 選択時は白文字に -->
                                                <MultiDataTrigger>
                                                    <MultiDataTrigger.Conditions>
                                                        <Condition Binding="{Binding IsLent}" Value="False"/>
                                                        <Condition Binding="{Binding IsSelected, RelativeSource={RelativeSource AncestorType=DataGridRow}}" Value="True"/>
                                                    </MultiDataTrigger.Conditions>
                                                    <Setter Property="Foreground" Value="White"/>
                                                </MultiDataTrigger>
                                                <MultiDataTrigger>
                                                    <MultiDataTrigger.Conditions>
                                                        <Condition Binding="{Binding IsLent}" Value="True"/>
                                                        <Condition Binding="{Binding IsSelected, RelativeSource={RelativeSource AncestorType=DataGridRow}}" Value="True"/>
                                                    </MultiDataTrigger.Conditions>
                                                    <Setter Property="Foreground" Value="White"/>
                                                </MultiDataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                </DataGrid.Columns>
            </DataGrid>

            <!-- ボタン -->
            <DockPanel Grid.Row="2" Margin="0,10,0,0" LastChildFill="True">
                <!-- 完了ボタン（右端固定） -->
                <Button DockPanel.Dock="Right"
                        Content="完了"
                        Click="CloseButton_Click"
                        Padding="20,8"
                        Margin="10,0,0,5"
                        VerticalAlignment="Top"/>
                <!-- 左側のボタン群（折り返し可能） -->
                <WrapPanel Orientation="Horizontal">
                    <Button Content="新規登録"
                            Command="{Binding StartNewCardCommand}"
                            Padding="15,8"
                            Margin="0,0,10,5"
                            AutomationProperties.Name="新規カード登録"
                            AutomationProperties.HelpText="新しい交通系ICカードを登録します。カードをタッチして登録できます。"
                            ToolTip="新しいカードを登録"/>
                    <Button Content="編集"
                            Command="{Binding StartEditCommand}"
                            IsEnabled="{Binding SelectedCard, Converter={StaticResource BoolToVisibilityConverter}}"
                            Padding="15,8"
                            Margin="0,0,10,5"
                            AutomationProperties.Name="カード情報編集"
                            AutomationProperties.HelpText="選択したカードの情報を編集します"
                            ToolTip="選択したカードを編集"/>
                    <Button Content="削除"
                            Command="{Binding DeleteCommand}"
                            IsEnabled="{Binding SelectedCard, Converter={StaticResource BoolToVisibilityConverter}}"
                            Padding="15,8"
                            Margin="0,0,0,5"
                            Foreground="Red"
                            AutomationProperties.Name="カード削除"
                            AutomationProperties.HelpText="選択したカードを削除します。削除後も履歴は保持されます。"
                            ToolTip="選択したカードを削除"/>
                </WrapPanel>
            </DockPanel>
        </Grid>

        <!-- 右側: 編集フォーム -->
        <Border Grid.Column="1"
                Background="#F5F5F5"
                CornerRadius="8"
                Padding="20">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- フォームヘッダー -->
                <TextBlock Grid.Row="0"
                           FontSize="{DynamicResource LargeFontSize}"
                           FontWeight="Bold"
                           Margin="0,0,0,20">
                    <TextBlock.Style>
                        <Style TargetType="TextBlock">
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsNewCard}" Value="True">
                                    <Setter Property="Text" Value="新規登録"/>
                                </DataTrigger>
                                <DataTrigger Binding="{Binding IsNewCard}" Value="False">
                                    <Setter Property="Text" Value="交通系ICカード編集"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBlock.Style>
                </TextBlock>

                <!-- フォーム本体 -->
                <StackPanel Grid.Row="1"
                            Visibility="{Binding IsEditing, Converter={StaticResource BoolToVisibilityConverter}}">

                    <!-- カード読み取り待ち表示（新規登録時のみ） -->
                    <Border Background="#FFF3E0"
                            CornerRadius="4"
                            Padding="10"
                            Margin="0,0,0,15"
                            Visibility="{Binding IsNewCard, Converter={StaticResource BoolToVisibilityConverter}}">
                        <StackPanel>
                            <TextBlock FontWeight="Bold" Foreground="#E65100">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="Text" Value="カードをタッチしてください"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsWaitingForCard}" Value="False">
                                                <Setter Property="Text" Value="カードを読み取りました"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>
                            <!-- デバッグ用ボタン -->
                            <Button Content="[DEBUG] カード読み取りシミュレート"
                                    Command="{Binding SimulateCardReadCommand}"
                                    Margin="0,10,0,0"
                                    Padding="10,5"
                                    Visibility="{Binding IsWaitingForCard, Converter={StaticResource BoolToVisibilityConverter}}"/>
                        </StackPanel>
                    </Border>

                    <!-- カード種別 -->
                    <TextBlock Text="カード種別" FontWeight="Bold" Margin="0,0,0,5"/>
                    <ComboBox ItemsSource="{Binding CardTypes}"
                              SelectedItem="{Binding EditCardType}"
                              Padding="8"
                              Margin="0,0,0,15"
                              AutomationProperties.Name="カード種別選択"
                              AutomationProperties.HelpText="交通系ICカードの種類を選択してください"
                              ToolTip="Suica、PASMO、ICOCAなどから選択"/>

                    <!-- 管理番号 -->
                    <TextBlock Text="管理番号" FontWeight="Bold" Margin="0,0,0,5"/>
                    <TextBox Text="{Binding EditCardNumber, UpdateSourceTrigger=PropertyChanged}"
                             Padding="8"
                             Margin="0,0,0,5"
                             AutomationProperties.Name="管理番号"
                             AutomationProperties.HelpText="カードの管理番号を入力してください。空欄の場合は自動採番されます。"
                             ToolTip="管理番号（空欄で自動採番）"/>
                    <TextBlock Text="空欄の場合は自動採番されます"
                               FontSize="{DynamicResource SmallFontSize}"
                               Foreground="Gray"
                               Margin="0,0,0,15"/>

                    <!-- 備考 -->
                    <TextBlock Text="備考" FontWeight="Bold" Margin="0,0,0,5"/>
                    <TextBox Text="{Binding EditNote, UpdateSourceTrigger=PropertyChanged}"
                             Padding="8"
                             TextWrapping="Wrap"
                             AcceptsReturn="True"
                             Height="80"
                             VerticalScrollBarVisibility="Auto"
                             Margin="0,0,0,15"
                             AutomationProperties.Name="備考"
                             AutomationProperties.HelpText="メモや備考を入力してください（任意）"
                             ToolTip="備考（任意）"/>

                    <!-- ステータスメッセージ（エラー時は赤色: Issue #286） -->
                    <TextBlock Text="{Binding StatusMessage}"
                               FontWeight="Bold"
                               TextWrapping="Wrap"
                               Margin="0,0,0,10">
                        <TextBlock.Style>
                            <Style TargetType="TextBlock">
                                <Setter Property="Foreground" Value="#1976D2"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsStatusError}" Value="True">
                                        <Setter Property="Foreground" Value="#D32F2F"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </TextBlock.Style>
                    </TextBlock>
                </StackPanel>

                <!-- 未選択時の表示（編集モードでない場合のみ表示） -->
                <StackPanel Grid.Row="1"
                            VerticalAlignment="Center"
                            HorizontalAlignment="Center">
                    <StackPanel.Style>
                        <Style TargetType="StackPanel">
                            <Setter Property="Visibility" Value="Collapsed"/>
                            <Style.Triggers>
                                <MultiDataTrigger>
                                    <MultiDataTrigger.Conditions>
                                        <Condition Binding="{Binding IsEditing}" Value="False"/>
                                        <Condition Binding="{Binding SelectedCard}" Value="{x:Null}"/>
                                    </MultiDataTrigger.Conditions>
                                    <Setter Property="Visibility" Value="Visible"/>
                                </MultiDataTrigger>
                            </Style.Triggers>
                        </Style>
                    </StackPanel.Style>
                    <TextBlock Text="カードを選択するか"
                               FontSize="{DynamicResource BaseFontSize}"
                               Foreground="Gray"
                               HorizontalAlignment="Center"/>
                    <TextBlock Text="[新規登録]をクリックしてください"
                               FontSize="{DynamicResource BaseFontSize}"
                               Foreground="Gray"
                               HorizontalAlignment="Center"
                               Margin="0,5,0,0"/>
                </StackPanel>

                <!-- フォームボタン -->
                <StackPanel Grid.Row="2"
                            Orientation="Horizontal"
                            HorizontalAlignment="Right"
                            Visibility="{Binding IsEditing, Converter={StaticResource BoolToVisibilityConverter}}">
                    <Button Content="キャンセル"
                            Command="{Binding CancelEditCommand}"
                            Padding="15,8"
                            Margin="0,0,10,0"/>
                    <Button Content="保存"
                            Command="{Binding SaveCommand}"
                            Padding="15,8"
                            Background="#2196F3"
                            Foreground="White"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- 処理中オーバーレイ -->
        <Border Grid.ColumnSpan="2"
                Background="#80000000"
                Visibility="{Binding IsBusy, Converter={StaticResource BoolToVisibilityConverter}}">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                <ProgressBar IsIndeterminate="True" Width="200" Height="4"/>
                <TextBlock Text="{Binding BusyMessage}"
                           Foreground="White"
                           FontSize="{DynamicResource BaseFontSize}"
                           Margin="0,10,0,0"
                           HorizontalAlignment="Center"/>
            </StackPanel>
        </Border>
    </Grid>
</Window>
