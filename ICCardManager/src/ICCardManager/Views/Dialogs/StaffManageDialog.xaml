<Window x:Class="ICCardManager.Views.Dialogs.StaffManageDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="clr-namespace:ICCardManager.ViewModels"
        mc:Ignorable="d"
        d:DataContext="{d:DesignInstance Type=vm:StaffManageViewModel}"
        Title="職員管理"
        Height="550"
        Width="850"
        WindowStartupLocation="CenterOwner"
        ResizeMode="CanResize">

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
    </Window.Resources>

    <Grid Margin="15">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="320"/>
        </Grid.ColumnDefinitions>

        <!-- 左側: 職員一覧 -->
        <Grid Grid.Column="0" Margin="0,0,15,0">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- ヘッダー -->
            <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,10">
                <TextBlock Text="登録済み職員一覧"
                           FontSize="{DynamicResource LargeFontSize}"
                           FontWeight="Bold"
                           VerticalAlignment="Center"/>
                <TextBlock Text="{Binding StaffList.Count, StringFormat=' ({0}名)'}"
                           FontSize="{DynamicResource BaseFontSize}"
                           Foreground="Gray"
                           VerticalAlignment="Center"
                           Margin="5,0,0,0"/>
            </StackPanel>

            <!-- 職員一覧 -->
            <DataGrid Grid.Row="1"
                      ItemsSource="{Binding StaffList}"
                      SelectedItem="{Binding SelectedStaff}"
                      AutoGenerateColumns="False"
                      IsReadOnly="True"
                      SelectionMode="Single"
                      CanUserAddRows="False"
                      CanUserDeleteRows="False"
                      GridLinesVisibility="Horizontal"
                      HeadersVisibility="Column"
                      RowHeaderWidth="0">
                <DataGrid.Columns>
                    <DataGridTextColumn Header="職員番号" Binding="{Binding Number}" Width="100"/>
                    <DataGridTextColumn Header="氏名" Binding="{Binding Name}" Width="150"/>
                    <DataGridTextColumn Header="備考" Binding="{Binding Note}" Width="*"/>
                </DataGrid.Columns>
            </DataGrid>

            <!-- ボタン -->
            <DockPanel Grid.Row="2" Margin="0,10,0,0" LastChildFill="True">
                <!-- 完了ボタン（右端固定） -->
                <Button DockPanel.Dock="Right"
                        Content="完了"
                        Click="CloseButton_Click"
                        Padding="20,8"
                        Margin="10,0,0,5"
                        VerticalAlignment="Top"/>
                <!-- 左側のボタン群（折り返し可能） -->
                <WrapPanel Orientation="Horizontal">
                    <Button Content="新規登録"
                            Command="{Binding StartNewStaffCommand}"
                            Padding="15,8"
                            Margin="0,0,10,5"/>
                    <Button Content="編集"
                            Command="{Binding StartEditCommand}"
                            IsEnabled="{Binding SelectedStaff, Converter={StaticResource BoolToVisibilityConverter}}"
                            Padding="15,8"
                            Margin="0,0,10,5"/>
                    <Button Content="削除"
                            Command="{Binding DeleteCommand}"
                            IsEnabled="{Binding SelectedStaff, Converter={StaticResource BoolToVisibilityConverter}}"
                            Padding="15,8"
                            Margin="0,0,0,5"
                            Foreground="Red"/>
                </WrapPanel>
            </DockPanel>
        </Grid>

        <!-- 右側: 編集フォーム -->
        <Border Grid.Column="1"
                Background="#F5F5F5"
                CornerRadius="8"
                Padding="20">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- フォームヘッダー -->
                <TextBlock Grid.Row="0"
                           FontSize="{DynamicResource LargeFontSize}"
                           FontWeight="Bold"
                           Margin="0,0,0,20">
                    <TextBlock.Style>
                        <Style TargetType="TextBlock">
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsNewStaff}" Value="True">
                                    <Setter Property="Text" Value="新規登録"/>
                                </DataTrigger>
                                <DataTrigger Binding="{Binding IsNewStaff}" Value="False">
                                    <Setter Property="Text" Value="職員編集"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBlock.Style>
                </TextBlock>

                <!-- フォーム本体 -->
                <StackPanel Grid.Row="1"
                            Visibility="{Binding IsEditing, Converter={StaticResource BoolToVisibilityConverter}}">

                    <!-- 職員証読み取り待ち表示（新規登録時のみ） -->
                    <Border Background="#E3F2FD"
                            CornerRadius="4"
                            Padding="10"
                            Margin="0,0,0,15"
                            Visibility="{Binding IsNewStaff, Converter={StaticResource BoolToVisibilityConverter}}">
                        <StackPanel>
                            <TextBlock FontWeight="Bold" Foreground="#1565C0">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="Text" Value="職員証をタッチしてください"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsWaitingForCard}" Value="False">
                                                <Setter Property="Text" Value="職員証を読み取りました"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>
                            <!-- デバッグ用ボタン -->
                            <Button Content="[DEBUG] 職員証読み取りシミュレート"
                                    Command="{Binding SimulateCardReadCommand}"
                                    Margin="0,10,0,0"
                                    Padding="10,5"
                                    Visibility="{Binding IsWaitingForCard, Converter={StaticResource BoolToVisibilityConverter}}"/>
                        </StackPanel>
                    </Border>

                    <!-- 氏名 -->
                    <TextBlock Text="氏名 *" FontWeight="Bold" Margin="0,0,0,5"/>
                    <TextBox Text="{Binding EditName, UpdateSourceTrigger=PropertyChanged}"
                             Padding="8"
                             Margin="0,0,0,15"/>

                    <!-- 職員番号 -->
                    <TextBlock Text="職員番号" FontWeight="Bold" Margin="0,0,0,5"/>
                    <TextBox Text="{Binding EditNumber, UpdateSourceTrigger=PropertyChanged}"
                             Padding="8"
                             Margin="0,0,0,15"/>

                    <!-- 備考 -->
                    <TextBlock Text="備考" FontWeight="Bold" Margin="0,0,0,5"/>
                    <TextBox Text="{Binding EditNote, UpdateSourceTrigger=PropertyChanged}"
                             Padding="8"
                             TextWrapping="Wrap"
                             AcceptsReturn="True"
                             Height="80"
                             VerticalScrollBarVisibility="Auto"
                             Margin="0,0,0,15"/>

                    <!-- ステータスメッセージ -->
                    <TextBlock Text="{Binding StatusMessage}"
                               Foreground="#1976D2"
                               FontWeight="Bold"
                               TextWrapping="Wrap"
                               Margin="0,0,0,10"/>
                </StackPanel>

                <!-- 未選択時の表示（編集モードでない場合のみ表示） -->
                <StackPanel Grid.Row="1"
                            VerticalAlignment="Center"
                            HorizontalAlignment="Center">
                    <StackPanel.Style>
                        <Style TargetType="StackPanel">
                            <Setter Property="Visibility" Value="Collapsed"/>
                            <Style.Triggers>
                                <MultiDataTrigger>
                                    <MultiDataTrigger.Conditions>
                                        <Condition Binding="{Binding IsEditing}" Value="False"/>
                                        <Condition Binding="{Binding SelectedStaff}" Value="{x:Null}"/>
                                    </MultiDataTrigger.Conditions>
                                    <Setter Property="Visibility" Value="Visible"/>
                                </MultiDataTrigger>
                            </Style.Triggers>
                        </Style>
                    </StackPanel.Style>
                    <TextBlock Text="職員を選択するか"
                               FontSize="{DynamicResource BaseFontSize}"
                               Foreground="Gray"
                               HorizontalAlignment="Center"/>
                    <TextBlock Text="[新規登録]をクリックしてください"
                               FontSize="{DynamicResource BaseFontSize}"
                               Foreground="Gray"
                               HorizontalAlignment="Center"
                               Margin="0,5,0,0"/>
                </StackPanel>

                <!-- フォームボタン -->
                <StackPanel Grid.Row="2"
                            Orientation="Horizontal"
                            HorizontalAlignment="Right"
                            Visibility="{Binding IsEditing, Converter={StaticResource BoolToVisibilityConverter}}">
                    <Button Content="キャンセル"
                            Command="{Binding CancelEditCommand}"
                            Padding="15,8"
                            Margin="0,0,10,0"/>
                    <Button Content="保存"
                            Command="{Binding SaveCommand}"
                            Padding="15,8"
                            Background="#2196F3"
                            Foreground="White"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- 処理中オーバーレイ -->
        <Border Grid.ColumnSpan="2"
                Background="#80000000"
                Visibility="{Binding IsBusy, Converter={StaticResource BoolToVisibilityConverter}}">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                <ProgressBar IsIndeterminate="True" Width="200" Height="4"/>
                <TextBlock Text="{Binding BusyMessage}"
                           Foreground="White"
                           FontSize="{DynamicResource BaseFontSize}"
                           Margin="0,10,0,0"
                           HorizontalAlignment="Center"/>
            </StackPanel>
        </Border>
    </Grid>
</Window>
