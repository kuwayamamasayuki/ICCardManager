# プロンプト.md と実装の乖離リスト

**作成日**: 2026年1月2日
**目的**: プロンプト.md に記載された要件と実際の実装との差異を明確化し、今後のドキュメント更新や機能追加の参考とする

---

## 1. 対応済みの乖離

### 1.1 技術スタック（Issue #240で対応済み）

| 項目 | プロンプト.md / CLAUDE.md（旧） | 実装（csproj） |
|------|-------------------------------|----------------|
| 言語バージョン | C# 12 | C# 10 |
| フレームワーク | .NET 8 | .NET Framework 4.8 |

**備考**: Issue #240 / PR #241 で CLAUDE.md、README.md、開発者ガイド.md、DISTRIBUTION.md を修正済み。

---

## 2. UI/UX に関する乖離

### 2.1 メニュー構成 vs ボタンバー

| プロンプト.md | 実装 |
|--------------|------|
| メニュー形式（「設定」「システム管理」などの階層メニュー） | ボタンバー形式（ヘッダーに平置きのボタン群） |

**プロンプトの記載**:
> メニューから「設定」を選択すると、各種設定を行えます。
> メニューから「システム管理」を選択すると、管理画面に入ります。

**実装**:
```
[帳票 (F1)] [職員管理 (F2)] [交通系ICカード管理 (F3)] [データ入出力 (F4)] [操作ログ (F5)] [設定 (F6)] [終了]
```

**評価**: 実装の方がより直感的で操作しやすい。プロンプトの更新を推奨。

---

### 2.2 設定画面の構成

| プロンプト.md | 実装 |
|--------------|------|
| 「設定」画面で以下を管理: | 独立したダイアログで管理: |
| - 交通系ICカードの登録/変更/削除 | 「交通系ICカード管理」ダイアログ (F3) |
| - 職員証の登録/変更/削除 | 「職員管理」ダイアログ (F2) |
| - 残額が少ないと警告を表示する金額 | 「設定」ダイアログ (F6) 内に残存 |

**評価**: 機能が独立しており、より使いやすい設計。プロンプトの更新を推奨。

---

### 2.3 システム管理メニュー

| プロンプト.md | 実装 |
|--------------|------|
| 「システム管理」メニュー: | 独立したダイアログ: |
| - バックアップデータからの復旧 | 「データ入出力」ダイアログ (F4) |
| - 修正ログの確認 | 「操作ログ」ダイアログ (F5) |

**追加機能（実装のみ）**:
- CSVエクスポート/インポート機能（「データ入出力」ダイアログ内）

**評価**: 実装がより充実している。プロンプトの更新を推奨。

---

### 2.4 履歴表示のデフォルト件数

| プロンプト.md | 実装 |
|--------------|------|
| 1ページあたり最大100件 | デフォルト50件（20/50/100件から選択可能） |

**該当箇所**: `HistoryViewModel.cs`

```csharp
public static List<PageSizeItem> PageSizeItems { get; } = new()
{
    new PageSizeItem { Value = 20, DisplayName = "20件" },
    new PageSizeItem { Value = 50, DisplayName = "50件" },
    new PageSizeItem { Value = 100, DisplayName = "100件" },
};
```

**評価**: 柔軟性がある実装。プロンプトを実装に合わせて更新することを推奨。

---

### 2.5 月次帳票選択UI

| プロンプト.md | 実装 |
|--------------|------|
| 「先月」「今月」「その他の月」のラジオボタン形式 | 年月を直接入力 + 「今月」「先月」ショートカットボタン |

**該当箇所**: `ReportDialog.xaml`

**評価**: 実装の方がより柔軟。プロンプトの更新を推奨。

---

## 3. 機能仕様に関する乖離

### 3.1 「新規購入」摘要【未実装】

| プロンプト.md | 実装 |
|--------------|------|
| 摘要に「新規購入」を記載する機能あり | **未実装** |

**プロンプトの記載**:
> 摘要（乗降区間 または 「チャージ」 または **「新規購入」** または 「次年度へ繰越」または「（貸出中）」）

**現状**: 「新規購入」という摘要を自動生成する機能は実装されていない。

**対応案**:
- 手動で摘要を入力する機能はあるため、運用でカバー可能
- または、新規カード登録時に自動で「新規購入」レコードを作成する機能を追加

---

### 3.2 履歴行の「詳細」「修正」ボタン

| プロンプト.md | 実装 |
|--------------|------|
| 各行の右側に「詳細」「修正」ボタン | メイン画面の履歴リストには直接編集機能なし |

**プロンプトの記載**:
> 各行の右側には、「詳細」ボタン、「修正」ボタンがあります。

**現状**:
- メイン画面: 履歴は表示のみ
- 履歴照会ダイアログ (HistoryDialog): 詳細表示・編集機能あり

**評価**: メイン画面はシンプルに保ち、詳細操作は専用ダイアログで行う設計。プロンプトの更新を推奨。

---

### 3.3 初期画面の案内メッセージ

| プロンプト.md | 実装 |
|--------------|------|
| 「貸出・返却時：職員証をタッチして、その後に交通系ICカードをタッチ<br>履歴確認・修正時：交通系ICカードのみをタッチ<br>その他：メニューから機能を選択」 | 「職員証をタッチしてください」<br>「30秒以内に同じカードを再タッチすると逆の処理ができます」等 |

**評価**: 基本的なガイダンスは表示されている。「履歴確認・修正時：交通系ICカードのみをタッチ」の動作は実装済み。

---

## 4. 一致している仕様

以下の仕様はプロンプト.mdと実装が一致しています：

| 項目 | プロンプト.md | 実装 |
|------|--------------|------|
| 職員証タッチ待ちタイムアウト | 60秒 | 60秒 (`TimeoutSeconds = 60`) |
| 30秒ルール | 30秒以内の再タッチで逆処理 | 30秒 (`RetouchTimeoutSeconds = 30`) |
| バックアップ世代数 | 30世代 | 30世代 (`BackupService`) |
| VACUUM実行条件 | 毎月10日以降の最初の起動時 | 毎月10日以降の初回起動時 (`App.xaml.cs`) |
| データ保存期間 | 6年（登録から6年経過で削除） | 6年 (`CleanupOldData`) |
| 残額警告閾値 | 10,000円（設定で変更可能） | 10,000円（設定で変更可能） |
| カード種別自動判別 | IDmの先頭2バイトで判別 | `CardTypeDetector`で実装済み |
| 摘要「役務費によりチャージ」 | チャージ時に使用 | `SummaryGenerator`で実装済み |
| 年度初め/年度末処理 | 繰越処理を実装 | `ReportService`で実装済み |

---

## 5. プロンプト.md に未記載だが実装済みの機能

以下の機能は実装されているが、プロンプト.md には記載がありません：

| 機能 | 説明 |
|------|------|
| CSVエクスポート/インポート | カード・職員・履歴のCSV入出力 |
| 印刷プレビュー | 帳票の印刷プレビュー表示 |
| 用紙方向切替 | 帳票の縦横切替 |
| 音声タイプ選択 | 男性/女性/ビープ音の選択 |
| トースト通知位置設定 | 通知表示位置の設定 |
| キーボードショートカット | F1～F6のショートカット対応 |

---

## 6. 推奨アクション

### 6.1 プロンプト.md の更新

以下の項目について、実装に合わせてプロンプト.md を更新することを推奨：

1. **メニュー構成** → ボタンバー形式に変更
2. **設定画面構成** → 独立ダイアログ形式に変更
3. **履歴表示件数** → デフォルト50件、選択可能に変更
4. **月次帳票選択UI** → 年月直接入力形式に変更
5. **履歴行のボタン** → 履歴照会ダイアログでの操作に変更

### 6.2 機能追加の検討

1. **「新規購入」摘要の自動生成** - 新規カード登録時に自動レコード作成（優先度: 低）

### 6.3 ドキュメント追加

1. **追加機能の仕様書作成** - CSVエクスポート/インポート、印刷プレビュー等

---

## 7. まとめ

プロンプト.md は初期の要件定義書として作成されたものであり、開発過程でより良いUI/UX設計や追加機能が実装されています。

**主な乖離のパターン**:
1. **UI改善による乖離**: メニュー → ボタンバー、設定画面の分割など
2. **機能拡張による乖離**: CSV入出力、印刷プレビューなどの追加
3. **未実装機能**: 「新規購入」摘要の自動生成

**全体評価**:
実装は概ねプロンプト.md の意図に沿っており、多くの改善が施されています。
プロンプト.md を実装に合わせて更新することで、ドキュメントの整合性を保つことを推奨します。

---

*このドキュメントは自動生成されたものであり、詳細な確認が必要な場合があります。*
