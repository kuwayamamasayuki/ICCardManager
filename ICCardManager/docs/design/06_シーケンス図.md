# シーケンス図

## 1. 職員証タッチ～ICカードタッチのフロー

```mermaid
sequenceDiagram
    autonumber
    participant User as ユーザー
    participant PaSoRi as PaSoRi
    participant Reader as ICardReader
    participant VM as MainViewModel
    participant Sound as ISoundPlayer

    Note over User,Sound: 初期状態: WaitingForStaffCard

    User->>PaSoRi: 職員証をタッチ
    PaSoRi->>Reader: カード検出
    Reader->>VM: CardRead イベント発火(IDm)

    VM->>VM: 職員証かどうか判定
    alt 職員証の場合
        VM->>VM: 状態を WaitingForIcCard に変更
        VM->>VM: タイムアウトタイマー開始(60秒)
        VM->>VM: 画面表示更新
    else ICカードの場合（職員証なしで直接タッチ）
        VM->>VM: 履歴表示ダイアログを開く
    end

    Note over User,Sound: 状態: WaitingForIcCard

    User->>PaSoRi: ICカードをタッチ
    PaSoRi->>Reader: カード検出
    Reader->>VM: CardRead イベント発火(IDm)

    VM->>VM: 30秒ルールチェック
    alt 30秒以内の再タッチ
        VM->>VM: 逆処理を実行
    else 通常処理
        VM->>VM: カードの貸出状態を確認
        alt 未貸出（is_lent = 0）
            VM->>VM: 貸出処理を実行
            VM->>Sound: PlayLend()
        else 貸出中（is_lent = 1）
            VM->>VM: 返却処理を実行
            VM->>Sound: PlayReturn()
        end
    end

    VM->>VM: 状態を WaitingForStaffCard に戻す
    VM->>VM: 画面表示更新
```

---

## 2. 貸出処理シーケンス

```mermaid
sequenceDiagram
    autonumber
    participant VM as MainViewModel
    participant LS as LendingService
    participant SR as IStaffRepository
    participant CR as ICardRepository
    participant LR as ILedgerRepository
    participant DB as DbContext
    participant Sound as ISoundPlayer

    VM->>LS: LendAsync(staffIdm, cardIdm)

    LS->>CR: GetByIdmAsync(cardIdm)
    CR->>DB: SELECT FROM ic_card
    DB-->>CR: カード情報
    CR-->>LS: IcCard

    alt カード未登録
        LS-->>VM: Error: カードが登録されていません
    else カード貸出中
        LS-->>VM: Error: このカードは既に貸出中です
    end

    LS->>SR: GetByIdmAsync(staffIdm)
    SR->>DB: SELECT FROM staff
    DB-->>SR: 職員情報
    SR-->>LS: Staff

    alt 職員未登録
        LS-->>VM: Error: 職員証が登録されていません
    end

    LS->>DB: BeginTransaction()
    DB-->>LS: Transaction

    LS->>LR: InsertAsync(Ledger)
    Note right of LR: summary = "（貸出中）"<br/>is_lent_record = true
    LR->>DB: INSERT INTO ledger
    DB-->>LR: ledgerId
    LR-->>LS: ledgerId

    LS->>CR: UpdateLentStatusAsync(cardIdm, true, now, staffIdm)
    CR->>DB: UPDATE ic_card SET is_lent = 1
    DB-->>CR: success
    CR-->>LS: success

    LS->>DB: Commit()

    LS->>LS: LastProcessedCardIdm = cardIdm
    LS->>LS: LastProcessedTime = now
    LS->>LS: LastOperationType = Lend

    LS-->>VM: LendingResult(Success = true)

    VM->>Sound: PlayLend()
    VM->>VM: 画面表示更新（貸出完了）
```

---

## 3. 返却処理シーケンス

```mermaid
sequenceDiagram
    autonumber
    participant VM as MainViewModel
    participant Reader as ICardReader
    participant LS as LendingService
    participant SR as IStaffRepository
    participant CR as ICardRepository
    participant LR as ILedgerRepository
    participant SG as SummaryGenerator
    participant DB as DbContext
    participant Sound as ISoundPlayer

    VM->>Reader: ReadHistoryAsync(cardIdm)
    Reader-->>VM: List<LedgerDetail>

    VM->>LS: ReturnAsync(staffIdm, cardIdm, usageDetails)

    LS->>CR: GetByIdmAsync(cardIdm)
    CR-->>LS: IcCard(is_lent = true)

    LS->>SR: GetByIdmAsync(staffIdm)
    SR-->>LS: Staff

    LS->>LR: GetLentRecordAsync(cardIdm)
    LR->>DB: SELECT FROM ledger WHERE is_lent_record = 1
    DB-->>LR: 貸出レコード
    LR-->>LS: Ledger

    LS->>LS: 貸出時刻以降の利用履歴を抽出

    LS->>DB: BeginTransaction()

    loop 日付ごとにグループ化
        alt チャージあり
            LS->>LR: InsertAsync(ChargeLedger)
            Note right of LR: summary = "役務費によりチャージ"
        end

        alt 利用あり
            LS->>SG: Generate(usageDetails)
            SG-->>LS: "鉄道（A駅～B駅）"
            LS->>LR: InsertAsync(UsageLedger)
            LS->>LR: InsertDetailsAsync(ledgerId, details)
        end
    end

    LS->>LR: UpdateAsync(lentRecord)
    Note right of LR: is_lent_record = false<br/>returner_idm = staffIdm<br/>returned_at = now

    LS->>CR: UpdateLentStatusAsync(cardIdm, false, null, null)

    LS->>DB: Commit()

    LS->>LS: 残高チェック
    alt 残高 < 警告閾値
        LS->>LS: IsLowBalance = true
    end

    LS->>LS: バス利用チェック
    alt バス利用あり
        LS->>LS: HasBusUsage = true
    end

    LS-->>VM: LendingResult(Success = true)

    VM->>Sound: PlayReturn()

    alt バス利用あり
        VM->>VM: バス停入力ダイアログを表示
    end

    alt 残高警告
        VM->>Sound: PlayWarning()
        VM->>VM: 警告メッセージを表示
    end

    VM->>VM: 画面表示更新（返却完了）
```

---

## 4. 帳票出力シーケンス

```mermaid
sequenceDiagram
    autonumber
    participant User as ユーザー
    participant VM as ReportViewModel
    participant RS as ReportService
    participant CR as ICardRepository
    participant LR as ILedgerRepository
    participant XL as ClosedXML

    User->>VM: 作成ボタンクリック

    VM->>VM: 入力値検証

    loop 選択されたカードごと
        VM->>RS: CreateMonthlyReportAsync(cardIdm, year, month, outputPath)

        RS->>CR: GetByIdmAsync(cardIdm)
        CR-->>RS: IcCard

        RS->>LR: GetByMonthAsync(cardIdm, year, month)
        LR-->>RS: List<Ledger>

        RS->>RS: 貸出中レコードを除外

        RS->>XL: new XLWorkbook(TemplatePath)
        XL-->>RS: Workbook

        RS->>RS: SetHeaderInfo(worksheet, card, year, month)

        alt 4月の場合
            RS->>LR: GetCarryoverBalanceAsync(cardIdm, year - 1)
            LR-->>RS: 前年度残高
            RS->>RS: WriteCarryoverRow()
        end

        loop 履歴レコードごと
            RS->>RS: WriteDataRow(worksheet, row, ledger)
        end

        RS->>RS: WriteMonthlyTotalRow()

        alt 3月の場合
            RS->>LR: GetByDateRangeAsync(cardIdm, fiscalYearStart, fiscalYearEnd)
            LR-->>RS: 年度の全レコード
            RS->>RS: WriteCumulativeRow()
            RS->>RS: WriteCarryoverToNextYearRow()
        end

        RS->>XL: SaveAs(outputPath)

        RS-->>VM: true
    end

    VM->>VM: 完了メッセージ表示
    VM-->>User: 作成完了
```

---

## 5. 30秒ルール適用シーケンス

```mermaid
sequenceDiagram
    autonumber
    participant User as ユーザー
    participant VM as MainViewModel
    participant LS as LendingService
    participant Sound as ISoundPlayer

    Note over User,Sound: 前提: 直前に貸出処理を実行済み<br/>LastProcessedCardIdm = "CARD001"<br/>LastOperationType = Lend

    User->>VM: 同じカードを再タッチ（30秒以内）

    VM->>LS: IsRetouchWithinTimeout("CARD001")
    LS->>LS: LastProcessedCardIdm == cardIdm?
    LS->>LS: (Now - LastProcessedTime) <= 30秒?
    LS-->>VM: true

    VM->>VM: LastOperationType を確認

    alt LastOperationType == Lend
        Note over VM: 前回が貸出なので、返却処理を実行
        VM->>LS: ReturnAsync(staffIdm, cardIdm, [])
        LS-->>VM: LendingResult(Success, OperationType = Return)
        VM->>Sound: PlayReturn()
    else LastOperationType == Return
        Note over VM: 前回が返却なので、貸出処理を実行
        VM->>LS: LendAsync(staffIdm, cardIdm)
        LS-->>VM: LendingResult(Success, OperationType = Lend)
        VM->>Sound: PlayLend()
    end

    VM->>VM: 画面表示更新
```

---

## 6. カード自動登録シーケンス

```mermaid
sequenceDiagram
    autonumber
    participant VM as MainViewModel
    participant LS as LendingService
    participant CR as ICardRepository
    participant CD as CardTypeDetector
    participant DB as DbContext

    VM->>LS: LendAsync(staffIdm, cardIdm)

    LS->>CR: GetByIdmAsync(cardIdm)
    CR->>DB: SELECT FROM ic_card
    DB-->>CR: null（未登録）
    CR-->>LS: null

    Note over LS: カードが未登録の場合、自動登録を試みる

    LS->>CD: DetectFromIdm(cardIdm)
    CD->>CD: IDmの先頭2バイトを解析
    CD-->>LS: CardType.Hayakaken

    LS->>CR: GetNextCardNumber(CardType.Hayakaken)
    CR-->>LS: "H003"

    LS->>CR: InsertAsync(newCard)
    Note right of CR: CardIdm = cardIdm<br/>CardType = "はやかけん"<br/>CardNumber = "H003"
    CR->>DB: INSERT INTO ic_card
    DB-->>CR: success
    CR-->>LS: success

    Note over LS: 自動登録完了、貸出処理を続行

    LS->>LS: 通常の貸出処理を実行
    LS-->>VM: LendingResult(Success = true)
```

---

## 7. タイムアウト処理シーケンス

```mermaid
sequenceDiagram
    autonumber
    participant User as ユーザー
    participant VM as MainViewModel
    participant Timer as DispatcherTimer

    Note over User,Timer: 状態: WaitingForStaffCard

    User->>VM: 職員証をタッチ

    VM->>VM: 状態を WaitingForIcCard に変更
    VM->>Timer: Start(60秒)
    VM->>VM: RemainingSeconds = 60

    loop 毎秒
        Timer->>VM: Tick イベント
        VM->>VM: RemainingSeconds--
        VM->>VM: 画面表示更新（残り XX 秒）

        alt RemainingSeconds == 0
            VM->>Timer: Stop()
            VM->>VM: 状態を WaitingForStaffCard に戻す
            VM->>VM: 画面表示更新
            Note over VM: タイムアウト: 職員証タッチ待ちに戻る
        end
    end

    alt ユーザーがICカードをタッチ
        Timer->>Timer: Stop()
        Note over VM: 正常処理: 貸出/返却を実行
    end

    alt ユーザーがEscキーを押下
        VM->>Timer: Stop()
        VM->>VM: 状態を WaitingForStaffCard に戻す
        Note over VM: キャンセル: 職員証タッチ待ちに戻る
    end
```

---

## 8. エラー処理シーケンス

```mermaid
sequenceDiagram
    autonumber
    participant VM as MainViewModel
    participant LS as LendingService
    participant DB as DbContext
    participant Sound as ISoundPlayer

    VM->>LS: LendAsync(staffIdm, cardIdm)

    LS->>DB: BeginTransaction()
    DB-->>LS: Transaction

    LS->>LS: 処理実行中...

    alt データベースエラー発生
        LS->>DB: Rollback()
        LS-->>VM: LendingResult(Success = false, ErrorMessage = "エラーメッセージ")
    end

    VM->>Sound: PlayError()
    VM->>VM: エラーメッセージを表示
    VM->>VM: 背景色を薄い赤に変更

    Note over VM: 3秒後に自動的に通常状態に戻る

    VM->>VM: 状態を WaitingForStaffCard に戻す
    VM->>VM: 画面表示更新
```
