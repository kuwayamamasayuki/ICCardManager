# テスト設計書

## 1. テスト概要

### 1.1 テスト目的
本テスト設計書は、交通系ICカード貸出管理システムの品質を保証するためのテスト計画・テストケースを定義する。

### 1.2 テスト範囲

| テストレベル | 対象 | 担当 |
|-------------|------|------|
| 単体テスト | 各クラス・メソッド | 開発者 |
| 結合テスト | 機能間連携 | 開発者 |
| システムテスト | システム全体 | テスト担当者 |
| 受入テスト | ユーザー視点の動作確認 | 利用者 |

### 1.3 テスト環境

| 項目 | 仕様 |
|------|------|
| OS | Windows 11 |
| .NET | .NET Framework 4.8 |
| ICカードリーダー | PaSoRi (RC-S300/RC-S380) |
| テスト用ICカード | はやかけん、nimoca、SUGOCA等 |
| テスト用職員証 | FeliCa対応カード |

---

## 2. 単体テスト

### 2.1 カード種別自動判別（CardTypeDetector）

#### UT-001: 発行者コードによるカード種別判別

| No | テストケース | 入力IDm（先頭2バイト） | 期待結果 |
|----|-------------|----------------------|---------|
| 1 | Suica判別 | 01XXXXXXXXXXXXXX | CardType.Suica |
| 2 | PASMO判別 | 02XXXXXXXXXXXXXX | CardType.PASMO |
| 3 | ICOCA判別 | 03XXXXXXXXXXXXXX | CardType.ICOCA |
| 4 | PiTaPa判別 | 04XXXXXXXXXXXXXX | CardType.PiTaPa |
| 5 | nimoca判別 | 05XXXXXXXXXXXXXX | CardType.Nimoca |
| 6 | SUGOCA判別 | 06XXXXXXXXXXXXXX | CardType.SUGOCA |
| 7 | はやかけん判別 | 07XXXXXXXXXXXXXX | CardType.Hayakaken |
| 8 | Kitaca判別 | 08XXXXXXXXXXXXXX | CardType.Kitaca |
| 9 | TOICA判別 | 09XXXXXXXXXXXXXX | CardType.TOICA |
| 10 | manaca判別 | 0AXXXXXXXXXXXXXX | CardType.Manaca |
| 11 | 不明コード | FFXXXXXXXXXXXXXX | CardType.Unknown |

---

### 2.2 バス利用判別ロジック

#### UT-002: バス利用判別

| No | テストケース | 乗車駅 | 降車駅 | is_charge | 期待結果 |
|----|-------------|--------|--------|-----------|---------|
| 1 | 通常の鉄道利用 | "博多" | "天神" | false | is_bus = false |
| 2 | バス利用（空欄） | "" | "" | false | is_bus = true |
| 3 | バス利用（null） | null | null | false | is_bus = true |
| 4 | チャージ | "" | "" | true | is_bus = false |
| 5 | 片道のみ記録 | "博多" | "" | false | is_bus = false |

---

### 2.3 摘要文字列生成（SummaryGenerator）

#### UT-003: 摘要文字列生成

| No | テストケース | 入力 | 期待結果 |
|----|-------------|------|---------|
| 1 | 単純片道 | A駅→B駅 | "鉄道（A駅～B駅）" |
| 2 | 往復利用 | A駅→B駅、B駅→A駅 | "鉄道（A駅～B駅 往復）" |
| 3 | 乗継利用 | A駅→B駅、B駅→C駅 | "鉄道（A駅～C駅）" |
| 4 | 複数区間 | A駅→B駅、C駅→D駅 | "鉄道（A駅～B駅、C駅～D駅）" |
| 5 | バス併用 | A駅→B駅 + バス | "鉄道（A駅～B駅）、バス（★）" |
| 6 | バスのみ | バス利用 | "バス（★）" |
| 7 | チャージ | チャージ3000円 | "役務費によりチャージ" |

---

### 2.4 和暦変換（DateConverter）

#### UT-004: 和暦変換

| No | テストケース | 入力 | 期待結果 |
|----|-------------|------|---------|
| 1 | 令和通常日付 | 2025-11-05 | "R7.11.05" |
| 2 | 令和元年 | 2019-05-01 | "R1.05.01" |
| 3 | 平成最終日 | 2019-04-30 | "H31.04.30" |
| 4 | 1桁月日 | 2025-01-05 | "R7.01.05" |
| 5 | 年度開始日 | 2025-04-01 | "R7.04.01" |

---

### 2.5 残額計算（BalanceCalculator）

#### UT-005: 残額計算

| No | テストケース | 前残額 | 受入 | 払出 | 期待結果 |
|----|-------------|-------|------|------|---------|
| 1 | チャージのみ | 1000 | 3000 | 0 | 4000 |
| 2 | 利用のみ | 4000 | 0 | 500 | 3500 |
| 3 | チャージと利用 | 1000 | 3000 | 500 | 3500 |
| 4 | 残額ゼロ | 500 | 0 | 500 | 0 |
| 5 | 繰越計算 | 5000 | 0 | 0 | 5000 |

---

## 3. 結合テスト

### 3.1 貸出・返却フロー

#### IT-001: 正常な貸出→返却フロー

**事前条件:**
- 職員「山田太郎」が登録済み
- 交通系ICカード「001」が登録済み・未貸出状態
- カード残額: 5,000円

**手順:**
1. 職員証「山田太郎」をタッチ
2. 交通系ICカード「001」をタッチ（貸出）
3. 外出して鉄道を利用（博多→天神 片道260円）
4. 職員証「山田太郎」をタッチ
5. 交通系ICカード「001」をタッチ（返却）

**期待結果:**
- 貸出時: 「いってらっしゃい！」表示、背景黄緑
- 返却時: 「おかえりなさい！」表示、背景水色
- ledgerテーブルに履歴登録:
  - 摘要: "鉄道（博多～天神）"
  - 払出金額: 260
  - 残額: 4,740
  - 氏名: "山田太郎"

---

#### IT-002: バス利用を含む返却フロー

**事前条件:**
- 職員「鈴木花子」が登録済み
- 交通系ICカード「002」が登録済み・貸出中

**手順:**
1. バスを利用（運賃260円）
2. 職員証「鈴木花子」をタッチ
3. 交通系ICカード「002」をタッチ（返却）
4. バス停入力画面でバス停名を入力

**期待結果:**
- 返却処理完了
- バス停入力画面が表示される
- 摘要に「バス（★）」が含まれる
- バス停名入力後、摘要が更新される

---

#### IT-003: 30秒ルールによる再貸出

**事前条件:**
- 職員「田中次郎」が登録済み
- 交通系ICカード「003」が登録済み・貸出中

**手順:**
1. 返却処理を実行
2. 25秒以内に再度貸出操作を実行

**期待結果:**
- 返却処理が完了扱いになる
- 新規貸出として処理される
- バス停入力画面が開いている場合は閉じる

---

### 3.2 履歴表示・修正フロー

#### IT-004: 履歴表示と修正

**事前条件:**
- 交通系ICカード「001」に履歴が存在

**手順:**
1. 交通系ICカード「001」をタッチ（職員証なし）
2. 履歴表示画面が開く
3. 任意の行で「修正」ボタンをクリック
4. 職員証をタッチ
5. 摘要を修正して「完了」をクリック

**期待結果:**
- 履歴が正しく表示される
- 修正モード時は背景が薄い黄色
- 修正内容がDBに反映される
- operation_logに修正ログが記録される

---

### 3.3 カード・職員管理フロー

#### IT-005: 交通系ICカード登録

**事前条件:**
- 操作者の職員証が登録済み

**手順:**
1. カード管理画面を開く
2. 「追加」ボタンをクリック
3. 操作者の職員証をタッチ
4. 新規交通系ICカードをタッチ
5. 通し番号「005」を入力
6. 「登録」ボタンをクリック

**期待結果:**
- カード種別が自動判別される
- ic_cardテーブルに登録される
- operation_logに登録ログが記録される

---

#### IT-006: 職員の論理削除と履歴表示

**事前条件:**
- 職員「佐藤三郎」が登録済み
- 「佐藤三郎」による利用履歴が存在

**手順:**
1. 職員管理画面で「佐藤三郎」を削除
2. 削除後、関連する履歴を表示

**期待結果:**
- staffテーブルでis_deleted=1, deleted_atが設定
- 物理削除はされない
- 履歴表示時に「佐藤三郎」の氏名が表示される

---

## 4. システムテスト

### 4.1 画面遷移テスト

#### ST-001: メイン画面からの遷移

| No | 操作 | 遷移先 | 戻り操作 |
|----|------|--------|---------|
| 1 | F7キー押下 | カード管理画面 | Escキー |
| 2 | F8キー押下 | 職員管理画面 | Escキー |
| 3 | F9キー押下 | 設定画面 | 閉じるボタン |
| 4 | F6キー押下 | 月次帳票画面 | 閉じるボタン |

---

### 4.2 エラー処理テスト

#### ST-002: エラー処理

| No | テストケース | 操作 | 期待結果 |
|----|-------------|------|---------|
| 1 | 貸出中カード重複貸出 | 貸出中カードをタッチ | 返却処理へ移行 |
| 2 | 未登録カード | 未登録カードをタッチ | 登録確認ダイアログ表示 |
| 3 | ICカード待ち中に職員証 | 職員証をタッチ | エラー音、メッセージ表示 |
| 4 | タイムアウト | 60秒待機 | エラー音、状態リセット |
| 5 | DB書き込み失敗 | DBファイルを読み取り専用に | エラーメッセージ表示 |

---

### 4.3 残額警告テスト

#### ST-003: 残額警告

**事前条件:**
- 警告閾値: 10,000円

| No | 残額 | 期待結果 |
|----|------|---------|
| 1 | 15,000円 | 警告なし |
| 2 | 10,000円 | 警告なし（閾値以上） |
| 3 | 9,999円 | 警告表示 |
| 4 | 0円 | 警告表示 |

---

### 4.4 バックアップテスト

#### ST-004: 自動バックアップ

**手順:**
1. アプリケーションを起動
2. バックアップフォルダを確認

**期待結果:**
- backup_YYYYMMDD_HHMMSS.db 形式のファイルが作成
- 30世代を超えた場合、古いファイルが削除される

---

### 4.5 月次帳票テスト

#### ST-005: Excel出力

**事前条件:**
- 2025年4月の履歴が存在
- 2025年3月の履歴が存在

| No | テストケース | 期待結果 |
|----|-------------|---------|
| 1 | 4月の帳票 | 「前年度より繰越」行が先頭に存在 |
| 2 | 3月の帳票 | 「累計」「次年度へ繰越」行が末尾に存在 |
| 3 | 月計行 | 月の合計が正しく計算される |
| 4 | ページ番号 | ページ番号が正しく設定される |

---

## 5. 性能テスト

### 5.1 応答性能

#### PT-001: カードタッチ応答

| No | 操作 | 目標応答時間 |
|----|------|-------------|
| 1 | カードタッチ検出 | 500ms以内 |
| 2 | 貸出処理完了 | 1秒以内 |
| 3 | 返却処理完了（履歴読込含む） | 3秒以内 |
| 4 | 履歴表示画面表示 | 2秒以内 |

---

### 5.2 データ量テスト

#### PT-002: 大量データ処理

| No | テストケース | データ量 | 期待結果 |
|----|-------------|---------|---------|
| 1 | 履歴表示 | 10,000件 | ページングで100件ずつ表示 |
| 2 | 月次帳票 | 1,000件/月 | 正常に出力 |
| 3 | 検索 | 50,000件 | 2秒以内に結果表示 |

---

## 6. セキュリティテスト

### 6.1 データ保護

#### SEC-001: データ保護確認

| No | テストケース | 確認内容 |
|----|-------------|---------|
| 1 | DBファイル暗号化 | SQLiteファイルが平文で読めないこと |
| 2 | パスワード保護 | 設定画面へのアクセスに認証が必要なこと |
| 3 | 操作ログ | 全ての重要操作が記録されること |

---

## 7. 受入テスト

### 7.1 業務シナリオテスト

#### UAT-001: 通常業務フロー

**シナリオ:** 職員Aが出張のためICカードを借り、帰社後に返却する

**手順:**
1. 朝、職員AがICカード「001」を借りる
2. 電車で移動（博多→天神→赤坂）
3. バスで移動
4. 帰社後、ICカードを返却
5. バス停名を入力
6. 履歴が正しく記録されていることを確認

**確認項目:**
- [ ] 貸出時の画面表示が適切
- [ ] 返却時の画面表示が適切
- [ ] バス停入力画面が表示される
- [ ] 履歴の摘要が正しい
- [ ] 金額が正しい
- [ ] 職員名が記録されている

---

#### UAT-002: 月次処理フロー

**シナリオ:** 月末に当月の物品出納簿を作成する

**手順:**
1. 月次帳票作成画面を開く
2. 対象月を選択
3. 出力するカードを選択
4. Excelファイル作成をクリック
5. 出力されたファイルを確認

**確認項目:**
- [ ] 対象月のデータが正しく出力される
- [ ] ヘッダ情報（物品分類、品名、規格）が正しい
- [ ] 月計行の金額が正しい
- [ ] 和暦表示が正しい

---

## 8. テスト完了基準

### 8.1 必須基準

| 項目 | 基準 |
|------|------|
| 単体テスト | 全件パス |
| 結合テスト | 全件パス |
| システムテスト | 重大バグ0件、軽微バグ5件以下 |
| 受入テスト | 全シナリオパス |

### 8.2 推奨基準

| 項目 | 基準 |
|------|------|
| コードカバレッジ | 80%以上 |
| 性能テスト | 全項目が目標値以内 |

---

## 9. バグ管理

### 9.1 バグ重要度定義

| 重要度 | 定義 | 対応期限 |
|--------|------|---------|
| Critical | システム停止、データ破損 | 即時対応 |
| Major | 主要機能が使用不可 | 1日以内 |
| Minor | 回避策あり、軽微な問題 | 1週間以内 |
| Trivial | 表示上の問題等 | 次回リリース |

---

## 10. テストデータ

### 10.1 職員テストデータ

| IDm | 氏名 | 職員番号 |
|-----|------|---------|
| TEST001 | 山田太郎 | E001 |
| TEST002 | 鈴木花子 | E002 |
| TEST003 | 田中次郎 | E003 |
| TEST004 | 佐藤三郎 | E004 |

### 10.2 ICカードテストデータ

| IDm | 通し番号 | カード種別 |
|-----|---------|-----------|
| 07FE11111111 | 001 | はやかけん |
| 05FE22222222 | 002 | nimoca |
| 06FE33333333 | 003 | SUGOCA |

### 10.3 履歴テストデータ

テスト用の履歴データは、以下のパターンを網羅するように作成:
- 鉄道利用（片道、往復、乗継、複数区間）
- バス利用
- チャージ
- 複数日にまたがる利用
- 月をまたぐ利用
- 年度をまたぐ利用
