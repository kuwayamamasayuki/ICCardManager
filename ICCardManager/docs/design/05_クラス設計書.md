# クラス設計書

## 1. クラス図

```mermaid
classDiagram
    %% Models
    class Staff {
        +string StaffIdm
        +string Name
        +string? Number
        +string? Note
        +bool IsDeleted
        +DateTime? DeletedAt
    }

    class IcCard {
        +string CardIdm
        +string CardType
        +string CardNumber
        +string? Note
        +bool IsDeleted
        +DateTime? DeletedAt
        +bool IsLent
        +DateTime? LastLentAt
        +string? LastLentStaff
    }

    class Ledger {
        +int Id
        +string CardIdm
        +string? LenderIdm
        +DateTime Date
        +string Summary
        +int Income
        +int Expense
        +int Balance
        +string? StaffName
        +string? Note
        +string? ReturnerIdm
        +DateTime? LentAt
        +DateTime? ReturnedAt
        +bool IsLentRecord
        +List~LedgerDetail~ Details
    }

    class LedgerDetail {
        +int LedgerId
        +DateTime? UseDate
        +string? EntryStation
        +string? ExitStation
        +string? BusStops
        +int? Amount
        +int? Balance
        +bool IsCharge
        +bool IsBus
        +Ledger? Ledger
    }

    class AppSettings {
        +int WarningBalance
        +string FontSize
        +bool SoundEnabled
    }

    %% Relationships
    Ledger "1" --> "*" LedgerDetail : Details
    IcCard "1" --> "*" Ledger : CardIdm
    Staff "1" --> "*" Ledger : LenderIdm
```

---

## 2. レイヤー構成図

```mermaid
graph TB
    subgraph "Presentation Layer"
        VIEW[Views/XAML]
        VM[ViewModels]
    end

    subgraph "Business Logic Layer"
        SVC_LEND[LendingService]
        SVC_REPORT[ReportService]
        SVC_BACKUP[BackupService]
        SVC_SUMMARY[SummaryGenerator]
        SVC_CARDTYPE[CardTypeDetector]
        SVC_OPLOG[OperationLogger]
    end

    subgraph "Data Access Layer"
        REPO_STAFF[IStaffRepository]
        REPO_CARD[ICardRepository]
        REPO_LEDGER[ILedgerRepository]
        REPO_SETTINGS[ISettingsRepository]
        REPO_OPLOG[IOperationLogRepository]
        DBCTX[DbContext]
    end

    subgraph "Infrastructure Layer"
        READER[ICardReader]
        SOUND[ISoundPlayer]
    end

    subgraph "External"
        DB[(SQLite)]
        PASORI[PaSoRi]
        SPEAKER[スピーカー]
    end

    VIEW --> VM
    VM --> SVC_LEND
    VM --> SVC_REPORT
    SVC_LEND --> REPO_STAFF
    SVC_LEND --> REPO_CARD
    SVC_LEND --> REPO_LEDGER
    SVC_LEND --> SVC_SUMMARY
    SVC_REPORT --> REPO_LEDGER
    SVC_REPORT --> REPO_CARD

    REPO_STAFF --> DBCTX
    REPO_CARD --> DBCTX
    REPO_LEDGER --> DBCTX
    REPO_SETTINGS --> DBCTX
    REPO_OPLOG --> DBCTX
    DBCTX --> DB

    VM --> READER
    VM --> SOUND
    READER --> PASORI
    SOUND --> SPEAKER
```

---

## 3. 主要クラスの責務

### 3.1 Models（エンティティ）

| クラス | 責務 | 対応テーブル |
|--------|------|--------------|
| Staff | 職員情報を保持 | staff |
| IcCard | ICカード情報を保持 | ic_card |
| Ledger | 利用履歴概要を保持 | ledger |
| LedgerDetail | 利用履歴詳細を保持 | ledger_detail |
| OperationLog | 操作ログを保持 | operation_log |
| AppSettings | アプリケーション設定を保持 | settings |

### 3.2 ViewModels

| クラス | 責務 |
|--------|------|
| ViewModelBase | ViewModelの基底クラス（IsBusy, BusyMessage） |
| MainViewModel | メイン画面のロジック、状態管理 |
| StaffManageViewModel | 職員管理ダイアログのロジック |
| CardManageViewModel | カード管理ダイアログのロジック |
| SettingsViewModel | 設定ダイアログのロジック |
| ReportViewModel | 帳票作成ダイアログのロジック |
| HistoryViewModel | 履歴表示ダイアログのロジック |

### 3.3 Services

| クラス | 責務 |
|--------|------|
| LendingService | 貸出・返却処理、30秒ルール管理 |
| ReportService | 月次帳票の作成（Excel出力） |
| BackupService | データベースのバックアップ |
| SummaryGenerator | 摘要文字列の生成 |
| CardTypeDetector | IDmからカード種別を判別 |
| OperationLogger | 操作ログの記録 |

### 3.4 Repositories

| インターフェース | 実装クラス | 責務 |
|------------------|------------|------|
| IStaffRepository | StaffRepository | 職員データのCRUD |
| ICardRepository | CardRepository | ICカードデータのCRUD |
| ILedgerRepository | LedgerRepository | 利用履歴のCRUD |
| ISettingsRepository | SettingsRepository | 設定データのCRUD |
| IOperationLogRepository | OperationLogRepository | 操作ログのCRUD |

### 3.5 Infrastructure

| インターフェース | 実装クラス | 責務 |
|------------------|------------|------|
| ICardReader | PcScCardReader | PC/SC APIでのカード読み取り |
| ICardReader | MockCardReader | テスト用モックリーダー |
| ISoundPlayer | SoundPlayer | 音声フィードバックの再生 |

---

## 4. 依存関係図

```mermaid
graph LR
    subgraph "ViewModels"
        MVM[MainViewModel]
    end

    subgraph "Services"
        LS[LendingService]
        RS[ReportService]
        SG[SummaryGenerator]
        CD[CardTypeDetector]
    end

    subgraph "Repositories"
        SR[IStaffRepository]
        CR[ICardRepository]
        LR[ILedgerRepository]
        STR[ISettingsRepository]
    end

    subgraph "Infrastructure"
        ICR[ICardReader]
        ISP[ISoundPlayer]
    end

    subgraph "Data"
        DBC[DbContext]
    end

    MVM --> LS
    MVM --> RS
    MVM --> ICR
    MVM --> ISP

    LS --> SR
    LS --> CR
    LS --> LR
    LS --> STR
    LS --> SG
    LS --> DBC

    RS --> CR
    RS --> LR

    SR --> DBC
    CR --> DBC
    LR --> DBC
    STR --> DBC
```

---

## 5. クラス詳細

### 5.1 LendingService

```mermaid
classDiagram
    class LendingService {
        -DbContext _dbContext
        -ICardRepository _cardRepository
        -IStaffRepository _staffRepository
        -ILedgerRepository _ledgerRepository
        -ISettingsRepository _settingsRepository
        -SummaryGenerator _summaryGenerator
        +string? LastProcessedCardIdm
        +DateTime? LastProcessedTime
        +LendingOperationType? LastOperationType
        +LendAsync(staffIdm, cardIdm) Task~LendingResult~
        +ReturnAsync(staffIdm, cardIdm, usageDetails) Task~LendingResult~
        +IsRetouchWithinTimeout(cardIdm) bool
        +ClearHistory() void
        -CreateUsageLedgersAsync(cardIdm, staffName, details) Task~List~Ledger~~
        -GetLastBalanceAsync(cardIdm) Task~int~
    }

    class LendingResult {
        +bool Success
        +LendingOperationType OperationType
        +string? ErrorMessage
        +int Balance
        +bool IsLowBalance
        +bool HasBusUsage
        +List~Ledger~ CreatedLedgers
    }

    class LendingOperationType {
        <<enumeration>>
        Lend
        Return
    }

    LendingService --> LendingResult
    LendingService --> LendingOperationType
```

### 5.2 SummaryGenerator

```mermaid
classDiagram
    class SummaryGenerator {
        +GenerateByDate(details) List~DailySummary~
        +Generate(details) string
        -GenerateUsageSummary(usageDetails) string
        -GenerateRailwaySummary(trips) string
        -GenerateBusSummary(trips) string
        -DetectRoundTrips(routes) List~tuple~
        -GetRemainingRoutes(allRoutes, roundTrips) List~tuple~
        -ConsolidateRoutes(routes) List~tuple~
        +GetLendingSummary()$ string
        +GetChargeSummary()$ string
        +GetCarryoverFromPreviousYearSummary()$ string
        +GetCarryoverToNextYearSummary()$ string
        +GetMonthlySummary(month)$ string
        +GetCumulativeSummary()$ string
    }

    class DailySummary {
        +DateTime Date
        +string Summary
        +bool IsCharge
    }

    SummaryGenerator --> DailySummary
```

### 5.3 CardTypeDetector

```mermaid
classDiagram
    class CardTypeDetector {
        -Dictionary~string, CardType~ IssuerCodeMap$
        +Detect(idm) CardType
        +DetectFromIdm(idm)$ CardType
        +GetDisplayName(cardType)$ string
    }

    class CardType {
        <<enumeration>>
        Suica
        PASMO
        ICOCA
        PiTaPa
        Nimoca
        SUGOCA
        Hayakaken
        Kitaca
        TOICA
        Manaca
        Unknown
    }

    CardTypeDetector --> CardType
```

### 5.4 ReportService

```mermaid
classDiagram
    class ReportService {
        -ICardRepository _cardRepository
        -ILedgerRepository _ledgerRepository
        -string TemplatePath
        +CreateMonthlyReportAsync(cardIdm, year, month, outputPath) Task~bool~
        +CreateMonthlyReportsAsync(cardIdms, year, month, outputFolder) Task~List~string~~
        -SetHeaderInfo(worksheet, card, year, month) void
        -WriteCarryoverRow(worksheet, row, balance) int
        -WriteDataRow(worksheet, row, ledger) int
        -WriteMonthlyTotalRow(worksheet, row, month, income, expense, balance, isMarch) int
        -WriteCumulativeRow(worksheet, row, income, expense, balance) int
        -WriteCarryoverToNextYearRow(worksheet, row, balance) int
    }
```

### 5.5 DbContext

```mermaid
classDiagram
    class DbContext {
        -string _connectionString
        -SqliteConnection? _connection
        -bool _disposed
        +string DatabasePath
        #DbContext()
        +DbContext(databasePath)
        +GetConnection() SqliteConnection
        +InitializeDatabase() void
        +CleanupOldData() int
        +Vacuum() void
        +BeginTransaction() SqliteTransaction
        +Dispose() void
        #Dispose(disposing) void
        -GetDefaultDatabasePath()$ string
        -GetSchemaScript()$ string
        -GetInlineSchema()$ string
    }
```

---

## 6. DIコンテナ設定

### 6.1 サービス登録（想定）

```csharp
// App.xaml.cs または Startup.cs
services.AddSingleton<DbContext>();
services.AddSingleton<ICardRepository, CardRepository>();
services.AddSingleton<IStaffRepository, StaffRepository>();
services.AddSingleton<ILedgerRepository, LedgerRepository>();
services.AddSingleton<ISettingsRepository, SettingsRepository>();
services.AddSingleton<IOperationLogRepository, OperationLogRepository>();

services.AddSingleton<SummaryGenerator>();
services.AddSingleton<LendingService>();
services.AddSingleton<ReportService>();
services.AddSingleton<BackupService>();
services.AddSingleton<OperationLogger>();

services.AddSingleton<ICardReader, PcScCardReader>();
services.AddSingleton<ISoundPlayer, SoundPlayer>();

services.AddTransient<MainViewModel>();
services.AddTransient<StaffManageViewModel>();
services.AddTransient<CardManageViewModel>();
services.AddTransient<SettingsViewModel>();
services.AddTransient<ReportViewModel>();
```

### 6.2 ライフタイム

| ライフタイム | クラス | 理由 |
|--------------|--------|------|
| Singleton | DbContext | DB接続を共有 |
| Singleton | Repositories | 状態を持たないが、DbContextを共有 |
| Singleton | Services | 状態を持つ（LastProcessedCardIdm等） |
| Singleton | ICardReader | ハードウェアリソースを管理 |
| Singleton | ISoundPlayer | リソース管理 |
| Transient | ViewModels | 画面ごとに新規インスタンス |

---

## 7. 共通ユーティリティ

### 7.1 WarekiConverter

```mermaid
classDiagram
    class WarekiConverter {
        +ToWareki(date)$ string
        +ToWarekiYearMonth(date)$ string
        +ToWarekiYear(date)$ string
        -GetEraName(date)$ string
        -GetEraYear(date)$ int
    }
```

### 7.2 Enums

```csharp
// アプリケーション状態
public enum AppState
{
    WaitingForStaffCard,  // 職員証タッチ待ち
    WaitingForIcCard,     // ICカードタッチ待ち
    Processing            // 処理中
}

// カード種別
public enum CardType
{
    Suica, PASMO, ICOCA, PiTaPa,
    Nimoca, SUGOCA, Hayakaken,
    Kitaca, TOICA, Manaca, Unknown
}

// 文字サイズ
public enum FontSizeOption
{
    Small, Medium, Large, ExtraLarge
}
```

---

## 8. インターフェース定義

### 8.1 ICardReader

```csharp
public interface ICardReader : IDisposable
{
    event EventHandler<CardReadEventArgs>? CardRead;
    event EventHandler<Exception>? Error;
    Task StartReadingAsync();
    Task StopReadingAsync();
    bool IsReading { get; }
    Task<IEnumerable<LedgerDetail>> ReadHistoryAsync(string idm);
    Task<int?> ReadBalanceAsync(string idm);
}
```

### 8.2 ISoundPlayer

```csharp
public interface ISoundPlayer
{
    void PlayLend();
    void PlayReturn();
    void PlayError();
    void PlayWarning();
    bool IsEnabled { get; set; }
}
```

### 8.3 IRepository

```csharp
// 例: ICardRepository
public interface ICardRepository
{
    Task<IcCard?> GetByIdmAsync(string cardIdm, bool includeDeleted = false);
    Task<IEnumerable<IcCard>> GetAllAsync(bool includeDeleted = false);
    Task<IEnumerable<IcCard>> GetLentCardsAsync();
    Task<bool> InsertAsync(IcCard card);
    Task<bool> UpdateAsync(IcCard card);
    Task<bool> UpdateLentStatusAsync(string cardIdm, bool isLent, DateTime? lentAt, string? staffIdm);
    Task<bool> DeleteAsync(string cardIdm); // 論理削除
}
```
