# 交通系ICカード管理システム 管理者マニュアル

**バージョン**: 1.1
**最終更新日**: 2026年2月

---

## 目次

1. [はじめに](#1-はじめに)
2. [システムのインストール](#2-システムのインストール)
3. [初期設定](#3-初期設定)
4. [職員管理](#4-職員管理)
5. [ICカード管理](#5-icカード管理)
6. [データ管理](#6-データ管理)
7. [システム設定](#7-システム設定)
8. [セキュリティ](#8-セキュリティ)
9. [メンテナンス](#9-メンテナンス)
10. [トラブルシューティング](#10-トラブルシューティング)

---

## 1. はじめに

### 1.1 本マニュアルについて

本マニュアルは、交通系ICカード管理システムの管理者向けドキュメントです。システムのインストール、初期設定、職員・ICカードの管理、データ管理などの管理業務について説明します。

### 1.2 管理者の役割

管理者は以下の業務を担当します。

| 業務 | 説明 |
|------|------|
| システム管理 | インストール、設定、バックアップ |
| 職員管理 | 職員の登録・編集・削除 |
| カード管理 | ICカードの登録・編集・削除 |
| データ管理 | バックアップ、エクスポート、古いデータの削除 |

### 1.3 システム要件

| 項目 | 要件 |
|------|------|
| OS | Windows 10/11 (64-bit) |
| CPU | x64プロセッサ |
| メモリ | 4GB以上 |
| ストレージ | 100MB以上の空き容量 |
| ICカードリーダー | Sony PaSoRi (RC-S380等) |
| ネットワーク | 不要（スタンドアロン動作） |

---

## 2. システムのインストール

### 2.1 インストーラーを使用する場合

1. `ICCardManager_Setup_x.x.x.exe` を実行します
2. インストールウィザードの指示に従います
3. インストール先を指定します（デフォルト: `C:\Program Files\ICCardManager`）
4. インストールオプションを選択します（下記参照）
5. 「インストール」をクリックします

#### インストールオプション

| オプション | 説明 | デフォルト |
|------------|------|------------|
| デスクトップにアイコンを作成 | デスクトップにショートカットを作成します | オフ |
| **Windowsログイン時に自動起動する（常駐）** | Windowsにログインすると自動的にアプリケーションが起動します | **オン** |

> **注意**: 常駐オプションをオンにすると、PCを起動してユーザーがログインした際に自動的にアプリケーションが起動します。常時ICカードの読み取りを行う運用に適しています。手動で起動したい場合はオフにしてください。

### 2.2 PaSoRiドライバのインストール

1. [ソニー公式サイト](https://www.sony.co.jp/Products/felica/consumer/support/download/)からドライバをダウンロード
2. ダウンロードしたインストーラーを実行
3. パソコンを再起動

### 2.3 初回起動

1. `ICCardManager.exe` を実行
2. Windows SmartScreen警告が表示された場合は「詳細情報」→「実行」をクリック
3. データベースファイル `iccard.db` が自動作成されます

---

## 3. 初期設定

### 3.1 設定画面を開く

1. メイン画面の「設定」ボタン（F5）をクリック
2. 設定ダイアログが開きます

### 3.2 基本設定

| 設定項目 | 説明 | デフォルト値 |
|----------|------|--------------|
| 残額警告 | 警告を表示する残高の閾値（0～20,000円） | 10,000円 |
| 文字サイズ | 画面の文字サイズ | 中 |
| 音声設定 | 操作時の音声（効果音のみ/音声・男性/音声・女性/無し） | 効果音のみ |
| 通知設定 | ポップアップの表示位置（右上/左上/右下/左下） | 右上 |

### 3.3 バックアップ設定

バックアップの保存先を設定できます。

| 設定項目 | 説明 | デフォルト値 |
|----------|------|--------------|
| バックアップ保存先 | バックアップファイルの保存フォルダ | アプリケーションフォルダ |

> **重要**: デフォルトではローカルPC上にバックアップが保存されます。火災や機器故障などの災害に備え、**ファイルサーバなどの外部ストレージ**にバックアップ先を設定することを強く推奨します。

**バックアップの世代管理:**
- システムは起動時に自動でバックアップを作成します
- 古いバックアップは自動的に削除され、最新の数世代のみ保持されます
- 定期的に手動でバックアップを取得し、別の場所に保管することも推奨します

### 3.4 データ保存場所

データベースファイルは以下の場所に保存されます。

```
%PROGRAMDATA%\ICCardManager\iccard.db
```

例: `C:\ProgramData\ICCardManager\iccard.db`

> **補足**: この場所はすべてのユーザーで共有されるため、異なるWindowsユーザーでログインしても同じデータにアクセスできます。

---

## 4. 職員管理

### 4.1 職員管理画面を開く

1. メイン画面の「職員管理」ボタンをクリック
2. または「管理」メニューから「職員管理」を選択

![職員管理画面](../screenshots/staff.png)

### 4.2 職員の登録

1. 「新規登録」ボタンをクリック
2. 職員情報を入力

   | 項目 | 必須 | 説明 |
   |------|------|------|
   | 氏名 | ○ | 職員の氏名 |
   | 職員番号 | - | 職員番号（組織で定められた番号） |
   | 備考 | - | 任意のメモ |

3. 職員証をICカードリーダーにタッチ（自動でIDmが取得されます）
4. 「保存」ボタンをクリック

### 4.3 職員情報の編集

1. 一覧から編集する職員を選択
2. 「編集」ボタンをクリック
3. 情報を修正
4. 「保存」ボタンをクリック

### 4.4 職員の削除

1. 一覧から削除する職員を選択
2. 「削除」ボタンをクリック
3. 確認ダイアログで「はい」をクリック

> **注意**: 削除された職員は論理削除されます。過去の履歴は保持され、履歴照会で氏名が表示されます。

### 4.5 職員証の再登録

職員証を紛失・変更した場合：

1. 該当する職員を選択
2. 「編集」→「職員証を登録」をクリック
3. 新しい職員証をタッチ
4. 「保存」をクリック

---

## 5. ICカード管理

### 5.1 ICカード管理画面を開く

1. メイン画面の「カード管理」ボタンをクリック
2. または「管理」メニューから「カード管理」を選択

![カード管理画面](../screenshots/card.png)

### 5.2 ICカードの登録

1. 「新規登録」ボタンをクリック
2. ICカードをリーダーにタッチ（IDmと残高が自動取得されます）
3. カード情報を入力

   | 項目 | 必須 | 説明 |
   |------|------|------|
   | カード種別 | ○ | ドロップダウンから選択 |
   | 管理番号 | ○ | 例: 001, 002（未入力の場合は自動採番） |
   | 備考 | - | 任意のメモ |

4. 「保存」ボタンをクリック

> **補足**: カード種別はドロップダウンから選択します（はやかけん、nimoca、SUGOCA、Suica、PASMO、ICOCA、PiTaPa、Kitaca、TOICA、manaca、その他）。デフォルトは「nimoca」が選択されていますので、登録するカードに合わせて適切な種別を選択してください。

> **注意**: カードの残高はタッチ時に自動で読み取られます。手動で入力する必要はありません。

### 5.3 ICカード情報の編集

1. 一覧から編集するカードを選択
2. 「編集」ボタンをクリック
3. 情報を修正
4. 「保存」ボタンをクリック

### 5.4 ICカードの削除

1. 一覧から削除するカードを選択
2. 「削除」ボタンをクリック
3. 確認ダイアログで「はい」をクリック

> **注意**: 削除されたカードは論理削除されます。過去の履歴は保持されます。

### 5.5 ICカードの払い戻し

交通系ICカードを払い戻す場合は、以下の手順で操作します。

1. 一覧から払い戻すカードを選択
2. 「払い戻し」ボタンをクリック
3. 確認ダイアログで現在の残高を確認し、「はい」をクリック

> **重要**: 払い戻し処理を行うと、以下の処理が実行されます。
> - 残高が払出金額として記録されます（物品出納簿に反映）
> - カードの残高は0になります
> - カードは論理削除されます（手元にないため）
>
> 払い戻し後もカードの過去の履歴は保持されます。

---

## 6. データ管理

### 6.1 バックアップ

#### 手動バックアップ

1. 「ツール」メニュー →「バックアップ」を選択
2. 保存先を指定
3. 「保存」をクリック

バックアップファイル: `iccard_backup_YYYYMMDD_HHMMSS.db`

#### 自動バックアップ

設定画面で自動バックアップを有効にできます。

| 設定 | 説明 |
|------|------|
| 有効/無効 | 自動バックアップのオン/オフ |
| 保存先 | バックアップファイルの保存場所 |
| 保持数 | 保持するバックアップの世代数 |

### 6.2 リストア（復元）

1. 「ツール」メニュー →「リストア」を選択
2. バックアップファイルを選択
3. 確認ダイアログで「はい」をクリック

> **警告**: リストアを実行すると、現在のデータは上書きされます。

### 6.3 データエクスポート

#### 履歴のCSVエクスポート

1. 「履歴」画面を開く
2. エクスポートする期間・条件を指定
3. 「エクスポート」ボタンをクリック
4. 保存先を指定

#### 月次帳票のExcel出力

1. 「帳票出力」画面を開く
2. 対象月とカードを選択
3. 「出力」ボタンをクリック

### 6.4 古いデータの削除

システムは6年経過したデータ（ledgerテーブル）を起動時に自動削除します。これは監査対応の保存期間に基づいています。

> **注意**: 職員データとカードデータは自動削除されません（論理削除のみ）。

---

## 7. システム設定

### 7.1 設定ファイル

設定は `appsettings.json` ファイルで管理されます。

**保存場所:**
- インストーラー使用時: `C:\Program Files\ICCardManager\appsettings.json`
- 手動インストール時: アプリケーションの実行ファイルと同じフォルダ

> **注意**: 設定ファイルを直接編集する場合は、アプリケーションを終了してから編集してください。

```json
{
  "WarningBalance": 10000,
  "BackupPath": "",
  "FontSize": "Medium",
  "SoundMode": "Beep",
  "ToastPosition": "TopRight",
  "MainWindowSettings": {
    "Left": null,
    "Top": null,
    "Width": null,
    "Height": null,
    "IsMaximized": false
  },
  "LastVacuumDate": null
}
```

### 7.2 設定項目一覧

| 項目 | 説明 | 設定値 |
|------|------|--------|
| WarningBalance | 残額警告閾値 | 0～20000（円） |
| BackupPath | バックアップ保存先 | フォルダパス（空欄時はアプリフォルダ） |
| FontSize | 文字サイズ | Small / Medium / Large / ExtraLarge |
| SoundMode | 音声モード | Beep（効果音）/ VoiceMale（男性音声）/ VoiceFemale（女性音声）/ None（無音） |
| ToastPosition | ポップアップ位置 | TopRight / TopLeft / BottomRight / BottomLeft |
| MainWindowSettings | ウィンドウ位置・サイズ | アプリが自動保存（編集不要） |
| LastVacuumDate | DB最適化日時 | アプリが自動設定（編集不要） |

---

## 8. セキュリティ

### 8.1 アクセス制御

本システムはスタンドアロン動作のため、OSレベルでのアクセス制御を推奨します。

- 管理者用PCでのみ管理機能を使用
- Windows ユーザーアカウントでアクセス制限

### 8.2 データ保護

| 項目 | 対策 |
|------|------|
| データベース | ローカルファイル（暗号化なし） |
| バックアップ | 定期的なバックアップを推奨 |
| 個人情報 | 職員氏名を含むため取り扱い注意 |

### 8.3 監査ログ

操作ログは `operation_log` テーブルに記録されます。

記録される操作：
- 貸出・返却
- 職員・カードの登録・編集・削除
- バックアップ・リストア

---

## 9. メンテナンス

### 9.1 定期メンテナンス

| 頻度 | 作業内容 |
|------|----------|
| 日次 | （自動）バックアップ |
| 月次 | 帳票出力、残額確認 |
| 年次 | 古いデータの確認、ディスク容量確認 |

### 9.2 データベースサイズ

通常の使用では、データベースファイルは数十MB程度です。
極端に大きくなった場合は、古いデータの削除やバックアップ後の再インストールを検討してください。

### 9.3 ログファイル

アプリケーションログは以下に出力されます。

```
%PROGRAMDATA%\ICCardManager\logs\
```

問題発生時の調査に使用します。

---

## 10. トラブルシューティング

### 10.1 起動時の問題

| 症状 | 原因 | 対処法 |
|------|------|--------|
| 起動しない | .NET Runtimeなし | 自己完結型のため通常は発生しない。再インストールを試行 |
| エラーメッセージ | データベース破損 | バックアップからリストア |
| 動作が遅い | ディスク容量不足 | 不要ファイルの削除 |

### 10.2 ICカードリーダーの問題

| 症状 | 原因 | 対処法 |
|------|------|--------|
| 認識されない | ドライバ未インストール | PaSoRiドライバをインストール |
| 認識されない | 他アプリが使用中 | FeliCaポートソフトウェア等を終了 |
| 反応しない | USB接続不良 | ケーブルを差し直す |

### 10.3 データの問題

| 症状 | 原因 | 対処法 |
|------|------|--------|
| データが消えた | 誤操作 | バックアップからリストア |
| 履歴が表示されない | 検索条件 | 期間・条件を確認 |
| 帳票が出力できない | 書き込み権限なし | 出力先フォルダの権限を確認 |

### 10.4 バックアップ・リストア

#### バックアップが作成されない

1. 保存先フォルダが存在するか確認
2. 書き込み権限があるか確認
3. ディスク空き容量を確認

#### リストアに失敗する

1. バックアップファイルが破損していないか確認
2. 別のバックアップファイルを試す
3. アプリケーションを再起動して再試行

---

## 11. 特殊なケースの取り扱い

### 11.1 残高不足時の現金支払い

ICカードの残高が運賃に不足している場合、降車時に不足分を現金で支払うことがあります。この場合、システムは自動的に以下のように処理します。

#### 状況の例

- カード残高: 200円
- 運賃: 210円
- 不足額: 10円（現金で支払い）

#### システムの処理

FeliCa履歴には「10円チャージ」「210円利用」の2件が記録されますが、システムは以下のように**1件の履歴**として出力します。

| 項目 | 値 |
|------|-----|
| 摘要 | 鉄道（A駅～B駅） |
| 払出金額 | 200円（カードの元残高） |
| 残額 | 0円 |
| 備考 | 支払額210円のうち不足額10円は現金で支払（旅費支給） |

> **ポイント**: 不足分の10円は現金で支払ったため、カードからの払出としては計上されません。備考欄に現金支払いの旨が記載されるため、旅費精算の際に参照してください。

---

## 付録

### A. ショートカットキー

| キー | 機能 |
|------|------|
| F1 | 帳票出力画面を開く |
| F2 | 職員管理画面を開く |
| F3 | カード管理画面を開く |
| F4 | データ入出力画面を開く |
| F5 | 設定画面を開く |
| F6 | システム管理画面を開く |
| Esc | 操作をキャンセル |
| Space | カード一覧で選択したカードの履歴を表示 |

### B. 用語集

| 用語 | 説明 |
|------|------|
| IDm | FeliCaカードの固有識別番号 |
| 論理削除 | データを物理的に削除せず、削除フラグを立てる方式 |
| 物品出納簿 | 物品の受入・払出を記録する帳票 |

---

*本マニュアルは予告なく変更される場合があります。*
