# 交通系ICカード管理システム 管理者マニュアル

**バージョン**: 1.0
**最終更新日**: 2025年12月

---

## 目次

1. [はじめに](#1-はじめに)
2. [システムのインストール](#2-システムのインストール)
3. [初期設定](#3-初期設定)
4. [職員管理](#4-職員管理)
5. [ICカード管理](#5-icカード管理)
6. [チャージ管理](#6-チャージ管理)
7. [データ管理](#7-データ管理)
8. [システム設定](#8-システム設定)
9. [セキュリティ](#9-セキュリティ)
10. [メンテナンス](#10-メンテナンス)
11. [トラブルシューティング](#11-トラブルシューティング)

---

## 1. はじめに

### 1.1 本マニュアルについて

本マニュアルは、交通系ICカード管理システムの管理者向けドキュメントです。システムのインストール、初期設定、職員・ICカードの管理、データ管理などの管理業務について説明します。

### 1.2 管理者の役割

管理者は以下の業務を担当します。

| 業務 | 説明 |
|------|------|
| システム管理 | インストール、設定、バックアップ |
| 職員管理 | 職員の登録・編集・削除 |
| カード管理 | ICカードの登録・編集・削除 |
| チャージ管理 | ICカードへのチャージ記録 |
| データ管理 | バックアップ、エクスポート、古いデータの削除 |

### 1.3 システム要件

| 項目 | 要件 |
|------|------|
| OS | Windows 10/11 (64-bit) |
| CPU | x64プロセッサ |
| メモリ | 4GB以上 |
| ストレージ | 100MB以上の空き容量 |
| ICカードリーダー | Sony PaSoRi (RC-S380等) |
| ネットワーク | 不要（スタンドアロン動作） |

---

## 2. システムのインストール

### 2.1 インストーラーを使用する場合

1. `ICCardManager_Setup_x.x.x.exe` を実行します
2. インストールウィザードの指示に従います
3. インストール先を指定します（デフォルト: `C:\Program Files\ICCardManager`）
4. 「インストール」をクリックします

### 2.2 ZIPファイルを使用する場合

1. 配布されたZIPファイルを任意のフォルダに展開します
   ```
   推奨: C:\ICCardManager\ または D:\ICCardManager\
   ```

2. フォルダ構成を確認します
   ```
   ICCardManager/
   ├── ICCardManager.exe      # メインアプリケーション
   ├── appsettings.json       # 設定ファイル（オプション）
   └── Resources/
       ├── Sounds/            # 通知音
       └── Templates/         # 帳票テンプレート
   ```

### 2.3 PaSoRiドライバのインストール

1. [ソニー公式サイト](https://www.sony.co.jp/Products/felica/consumer/support/download/)からドライバをダウンロード
2. ダウンロードしたインストーラーを実行
3. パソコンを再起動

### 2.4 初回起動

1. `ICCardManager.exe` を実行
2. Windows SmartScreen警告が表示された場合は「詳細情報」→「実行」をクリック
3. データベースファイル `iccard.db` が自動作成されます

---

## 3. 初期設定

### 3.1 設定画面を開く

1. メイン画面の「設定」ボタンをクリック
2. または「ツール」メニューから「設定」を選択

### 3.2 基本設定

| 設定項目 | 説明 | デフォルト値 |
|----------|------|--------------|
| 文字サイズ | 画面の文字サイズ | 中 |
| 残額警告閾値 | 警告を表示する残額 | 1,000円 |
| 操作音 | 操作音のオン/オフ | オン |

### 3.3 データ保存場所

データベースファイルは以下の場所に保存されます。

```
%LOCALAPPDATA%\ICCardManager\iccard.db
```

例: `C:\Users\<ユーザー名>\AppData\Local\ICCardManager\iccard.db`

---

## 4. 職員管理

### 4.1 職員管理画面を開く

1. メイン画面の「職員管理」ボタンをクリック
2. または「管理」メニューから「職員管理」を選択

### 4.2 職員の登録

1. 「新規登録」ボタンをクリック
2. 職員情報を入力

   | 項目 | 必須 | 説明 |
   |------|------|------|
   | 氏名 | ○ | 職員の氏名 |
   | 職員番号 | - | 任意の管理番号 |
   | 所属 | - | 部署名など |

3. 「職員証を登録」ボタンをクリック
4. 職員証をICカードリーダーにタッチ
5. 「保存」ボタンをクリック

### 4.3 職員情報の編集

1. 一覧から編集する職員を選択
2. 「編集」ボタンをクリック
3. 情報を修正
4. 「保存」ボタンをクリック

### 4.4 職員の削除

1. 一覧から削除する職員を選択
2. 「削除」ボタンをクリック
3. 確認ダイアログで「はい」をクリック

> **注意**: 削除された職員は論理削除されます。過去の履歴は保持され、履歴照会で氏名が表示されます。

### 4.5 職員証の再登録

職員証を紛失・変更した場合：

1. 該当する職員を選択
2. 「編集」→「職員証を登録」をクリック
3. 新しい職員証をタッチ
4. 「保存」をクリック

---

## 5. ICカード管理

### 5.1 ICカード管理画面を開く

1. メイン画面の「カード管理」ボタンをクリック
2. または「管理」メニューから「カード管理」を選択

### 5.2 ICカードの登録

1. 「新規登録」ボタンをクリック
2. ICカードをリーダーにタッチ（IDmが自動取得されます）
3. カード情報を入力

   | 項目 | 必須 | 説明 |
   |------|------|------|
   | カード種別 | ○ | 自動判別（手動変更可） |
   | 管理番号 | ○ | 例: 001, 002 |
   | 初期残額 | - | 登録時の残額 |
   | 備考 | - | 任意のメモ |

4. 「保存」ボタンをクリック

### 5.3 カード種別の自動判別

システムはIDmの先頭2バイト（発行者コード）からカード種別を自動判別します。

| コード | カード種別 |
|--------|------------|
| 01 | Suica |
| 02 | PASMO |
| 03 | ICOCA |
| 04 | PiTaPa |
| 05 | nimoca |
| 06 | SUGOCA |
| 07 | はやかけん |
| 08 | Kitaca |
| 09 | TOICA |
| 0A | manaca |

判別できない場合は「その他」として登録され、手動で変更できます。

### 5.4 ICカード情報の編集

1. 一覧から編集するカードを選択
2. 「編集」ボタンをクリック
3. 情報を修正
4. 「保存」ボタンをクリック

### 5.5 ICカードの削除

1. 一覧から削除するカードを選択
2. 「削除」ボタンをクリック
3. 確認ダイアログで「はい」をクリック

> **注意**: 削除されたカードは論理削除されます。過去の履歴は保持されます。

---

## 6. チャージ管理

### 6.1 チャージの記録

ICカードにチャージした場合、以下の手順で記録します。

1. 「履歴」画面を開く
2. 「チャージ記録」ボタンをクリック
3. 対象のカードを選択
4. チャージ金額を入力
5. 「保存」ボタンをクリック

### 6.2 チャージ記録の内容

| 項目 | 説明 |
|------|------|
| 日付 | チャージした日付 |
| カード | 対象のICカード |
| 金額 | チャージ金額 |
| 残額 | チャージ後の残額 |

### 6.3 帳票への反映

チャージ記録は月次帳票（物品出納簿）に「受入金額」として反映されます。

---

## 7. データ管理

### 7.1 バックアップ

#### 手動バックアップ

1. 「ツール」メニュー →「バックアップ」を選択
2. 保存先を指定
3. 「保存」をクリック

バックアップファイル: `iccard_backup_YYYYMMDD_HHMMSS.db`

#### 自動バックアップ

設定画面で自動バックアップを有効にできます。

| 設定 | 説明 |
|------|------|
| 有効/無効 | 自動バックアップのオン/オフ |
| 保存先 | バックアップファイルの保存場所 |
| 保持数 | 保持するバックアップの世代数 |

### 7.2 リストア（復元）

1. 「ツール」メニュー →「リストア」を選択
2. バックアップファイルを選択
3. 確認ダイアログで「はい」をクリック

> **警告**: リストアを実行すると、現在のデータは上書きされます。

### 7.3 データエクスポート

#### 履歴のCSVエクスポート

1. 「履歴」画面を開く
2. エクスポートする期間・条件を指定
3. 「エクスポート」ボタンをクリック
4. 保存先を指定

#### 月次帳票のExcel出力

1. 「帳票出力」画面を開く
2. 対象月とカードを選択
3. 「出力」ボタンをクリック

### 7.4 古いデータの削除

システムは6年経過したデータ（ledgerテーブル）を起動時に自動削除します。これは監査対応の保存期間に基づいています。

> **注意**: 職員データとカードデータは自動削除されません（論理削除のみ）。

---

## 8. システム設定

### 8.1 設定ファイル

設定は `appsettings.json` ファイルで管理されます。

```json
{
  "Settings": {
    "FontSize": "Medium",
    "WarningBalance": 1000,
    "SoundEnabled": true,
    "AutoBackup": {
      "Enabled": true,
      "Path": "C:\\Backup\\ICCardManager",
      "RetentionCount": 5
    }
  }
}
```

### 8.2 設定項目一覧

| 項目 | 説明 | 設定値 |
|------|------|--------|
| FontSize | 文字サイズ | Small / Medium / Large / ExtraLarge |
| WarningBalance | 残額警告閾値 | 0～10000 |
| SoundEnabled | 操作音 | true / false |
| AutoBackup.Enabled | 自動バックアップ | true / false |
| AutoBackup.Path | バックアップ保存先 | フォルダパス |
| AutoBackup.RetentionCount | 保持世代数 | 1～10 |

---

## 9. セキュリティ

### 9.1 アクセス制御

本システムはスタンドアロン動作のため、OSレベルでのアクセス制御を推奨します。

- 管理者用PCでのみ管理機能を使用
- Windows ユーザーアカウントでアクセス制限

### 9.2 データ保護

| 項目 | 対策 |
|------|------|
| データベース | ローカルファイル（暗号化なし） |
| バックアップ | 定期的なバックアップを推奨 |
| 個人情報 | 職員氏名を含むため取り扱い注意 |

### 9.3 監査ログ

操作ログは `operation_log` テーブルに記録されます。

記録される操作：
- 貸出・返却
- 職員・カードの登録・編集・削除
- チャージ記録
- バックアップ・リストア

---

## 10. メンテナンス

### 10.1 定期メンテナンス

| 頻度 | 作業内容 |
|------|----------|
| 日次 | （自動）バックアップ |
| 月次 | 帳票出力、残額確認 |
| 年次 | 古いデータの確認、ディスク容量確認 |

### 10.2 データベースサイズ

通常の使用では、データベースファイルは数十MB程度です。
極端に大きくなった場合は、サポートにお問い合わせください。

### 10.3 ログファイル

アプリケーションログは以下に出力されます。

```
%LOCALAPPDATA%\ICCardManager\logs\
```

問題発生時の調査に使用します。

---

## 11. トラブルシューティング

### 11.1 起動時の問題

| 症状 | 原因 | 対処法 |
|------|------|--------|
| 起動しない | .NET Runtimeなし | 自己完結型のため通常は発生しない。再インストールを試行 |
| エラーメッセージ | データベース破損 | バックアップからリストア |
| 動作が遅い | ディスク容量不足 | 不要ファイルの削除 |

### 11.2 ICカードリーダーの問題

| 症状 | 原因 | 対処法 |
|------|------|--------|
| 認識されない | ドライバ未インストール | PaSoRiドライバをインストール |
| 認識されない | 他アプリが使用中 | FeliCaポートソフトウェア等を終了 |
| 反応しない | USB接続不良 | ケーブルを差し直す |

### 11.3 データの問題

| 症状 | 原因 | 対処法 |
|------|------|--------|
| データが消えた | 誤操作 | バックアップからリストア |
| 履歴が表示されない | 検索条件 | 期間・条件を確認 |
| 帳票が出力できない | 書き込み権限なし | 出力先フォルダの権限を確認 |

### 11.4 バックアップ・リストア

#### バックアップが作成されない

1. 保存先フォルダが存在するか確認
2. 書き込み権限があるか確認
3. ディスク空き容量を確認

#### リストアに失敗する

1. バックアップファイルが破損していないか確認
2. 別のバックアップファイルを試す
3. アプリケーションを再起動して再試行

### 11.5 サポート連絡先

問題が解決しない場合は、以下の情報を添えてサポートにお問い合わせください。

- エラーメッセージのスクリーンショット
- 操作手順
- ログファイル（`%LOCALAPPDATA%\ICCardManager\logs\`）

---

## 付録

### A. データベース構造

| テーブル | 説明 |
|----------|------|
| staff | 職員マスタ |
| ic_card | ICカードマスタ |
| ledger | 出納記録 |
| operation_log | 操作ログ |

### B. ショートカットキー

| キー | 機能 |
|------|------|
| F1 | ヘルプ |
| F5 | 画面更新 |
| Ctrl+B | バックアップ |
| Ctrl+E | エクスポート |

### C. 用語集

| 用語 | 説明 |
|------|------|
| IDm | FeliCaカードの固有識別番号 |
| 論理削除 | データを物理的に削除せず、削除フラグを立てる方式 |
| 物品出納簿 | 物品の受入・払出を記録する帳票 |

---

*本マニュアルは予告なく変更される場合があります。*
