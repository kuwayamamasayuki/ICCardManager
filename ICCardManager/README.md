# ICCardManager - 交通系ICカード管理システム

複数の交通系ICカード（はやかけん、nimoca、SUGOCA等）を複数職員でシェア利用する際の出納記録を管理するWindowsデスクトップアプリケーションです。

![メイン画面](docs/screenshots/main.png)

## 主な機能

| 機能 | 説明 |
|------|------|
| 🎫 **貸出・返却管理** | 職員証タッチ → 交通系ICカードタッチで簡単操作 |
| 📊 **物品出納簿自動生成** | 月次帳票をExcel形式で出力 |
| 🔍 **利用履歴照会** | 過去の利用記録を検索・閲覧 |
| ⚡ **30秒ルール** | 誤操作時に30秒以内の再タッチで取消可能 |
| 🚌 **バス利用対応** | バス停名の手入力・オートコンプリート |
| ♿ **アクセシビリティ** | 音・色・アイコン・テキストの多重通知 |

### スクリーンショット

<details>
<summary>貸出・返却画面</summary>

| 貸出時 | 返却時 |
|--------|--------|
| ![貸出](docs/screenshots/lend.png) | ![返却](docs/screenshots/return.png) |

</details>

<details>
<summary>各種管理画面</summary>

| 履歴照会 | カード管理 | 職員管理 |
|----------|------------|----------|
| ![履歴](docs/screenshots/history.png) | ![カード](docs/screenshots/card.png) | ![職員](docs/screenshots/staff.png) |

</details>

## 動作環境

### ハードウェア要件

| 項目 | 要件 |
|------|------|
| OS | Windows 10/11 |
| CPU | x86/x64プロセッサ |
| メモリ | 4GB以上 |
| ストレージ | 100MB以上の空き容量 |
| ICカードリーダー | Sony PaSoRi (RC-S380等) |

### ソフトウェア要件

| 項目 | 要件 |
|------|------|
| .NET Framework | 4.8（通常Windows 10/11にプリインストール済み） |
| PaSoRiドライバ | [ソニー公式サイト](https://www.sony.co.jp/Products/felica/consumer/support/download/)よりダウンロード |
| Excel | 出力ファイルの閲覧に必要 |

> **Note**: インターネット非接続環境で動作します。クラウドサービスは利用しません。

## セットアップ

### インストール手順

1. 配布されたインストーラー（`ICCardManager_Setup_x.x.x.exe`）を実行
2. 画面の指示に従ってインストール
3. インストール完了後、デスクトップのショートカットまたはスタートメニューからアプリを起動

> **Note**: インストール先はデフォルトで `C:\Program Files\ICCardManager\` になります。

### 初回起動時の注意

- **Windows SmartScreen警告**: インストーラー実行時に「詳細情報」→「実行」をクリック
- **データベース**: 初回起動時に `C:\ProgramData\ICCardManager\iccard.db` が自動作成されます

### 初期設定

1. **職員の登録**: 「職員管理」から職員証を登録
2. **交通系ICカードの登録**: 「カード管理」から交通系ICカードを登録
3. **残額警告の設定**: 「設定」から警告閾値を設定（デフォルト: 10,000円）

## 使い方

### 基本的な操作フロー

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  職員証     │ ──> │ 交通系ICカード│ ──> │  処理完了   │
│  タッチ     │     │  タッチ     │     │  (貸出/返却)│
└─────────────┘     └─────────────┘     └─────────────┘
     ↑                                        │
     └────────────────────────────────────────┘
                    60秒でタイムアウト
```

### 貸出・返却の判定

| 状態 | 操作結果 |
|------|----------|
| カードが未貸出 | → 貸出処理 |
| カードが貸出中 | → 返却処理（利用履歴を記録） |

### 30秒ルール（誤操作防止）

30秒以内に同じカードを再タッチすると、直前の操作を取り消せます。

| 直前の操作 | 再タッチ結果 |
|------------|--------------|
| 貸出 | → 貸出取消（返却） |
| 返却 | → 返却取消（再貸出） |

### 画面説明

| 画面 | 機能 |
|------|------|
| メイン画面 | 貸出・返却操作、状態表示 |
| 履歴照会 | 期間・カード・職員で絞り込み検索 |
| カード管理 | 交通系ICカードの登録・編集・削除 |
| 職員管理 | 職員の登録・編集・削除 |
| 帳票出力 | 月次物品出納簿の生成 |
| 設定 | 文字サイズ、残額警告、バックアップ設定 |

### 月次帳票（物品出納簿）

1. 「帳票出力」ボタンをクリック
2. 対象月とカードを選択
3. 「出力」ボタンでExcelファイルを生成

## 開発者向け情報

### 技術スタック

| カテゴリ | 技術 | バージョン |
|----------|------|------------|
| 言語 | C# | 10 |
| フレームワーク | .NET Framework | 4.8 |
| UI | WPF | - |
| アーキテクチャ | MVVM | - |
| データベース | SQLite | 3.x |
| ICカード | PC/SC API | - |
| Excel出力 | ClosedXML | 0.102.x |
| MVVMツールキット | CommunityToolkit.Mvvm | 8.x |

### ディレクトリ構成

```
ICCardManager/
├── src/
│   └── ICCardManager/
│       ├── Views/           # XAML (View層)
│       ├── ViewModels/      # ViewModel層
│       ├── Models/          # エンティティ
│       ├── Services/        # ビジネスロジック
│       ├── Data/            # データアクセス層
│       └── Resources/       # リソースファイル
├── tests/
│   └── ICCardManager.Tests/ # 単体テスト
└── docs/                    # 設計書
```

### ビルドコマンド

```bash
# 開発ビルド
dotnet build

# リリースビルド（配布用）
dotnet publish src/ICCardManager/ICCardManager.csproj -c Release

# 出力先: src/ICCardManager/bin/Release/net48/
```

### インストーラーのビルド

配布用インストーラーを作成できます。

#### 前提条件

- [Inno Setup 6](https://jrsoftware.org/isinfo.php) がインストールされていること

#### ビルド手順

```powershell
# PowerShellスクリプトを使用（推奨）
cd installer
.\build-installer.ps1

# または、バッチファイルを使用
.\build-installer.bat

# ビルド済みのpublishフォルダを使用する場合
.\build-installer.ps1 -SkipBuild

# バージョンを指定する場合
.\build-installer.ps1 -Version "1.3.0"
```

#### 出力ファイル

```
installer/output/ICCardManager_Setup_1.0.0.exe
```

### テスト実行

```bash
# 全テスト実行
dotnet test

# 詳細ログ付き
dotnet test --logger "console;verbosity=detailed"

# 特定のテストクラスのみ
dotnet test --filter "FullyQualifiedName~SummaryGeneratorTests"
```

### 開発用設定

開発時の注意事項は [CLAUDE.md](CLAUDE.md) を参照してください。

## ドキュメント

| ドキュメント | 説明 |
|--------------|------|
| [設計書一式](docs/design/) | システム設計書（概要、DB、画面、機能、クラス、シーケンス図） |
| [ユーザーマニュアル](docs/manual/ユーザーマニュアル.md) | 一般ユーザー向け操作マニュアル |
| [管理者マニュアル](docs/manual/管理者マニュアル.md) | システム管理者向けマニュアル |
| [開発者ガイド](docs/manual/開発者ガイド.md) | 開発・運用・保守向けガイド |
| [配布手順書](docs/DISTRIBUTION.md) | ビルド・配布手順 |

## トラブルシューティング

<details>
<summary>ICカードリーダーが認識されない</summary>

1. PaSoRiドライバが正しくインストールされているか確認
2. デバイスマネージャーでICカードリーダーが認識されているか確認
3. 他のICカード関連アプリ（FeliCaポートソフトウェア等）を終了

</details>

<details>
<summary>アプリケーションが起動しない</summary>

1. インストーラーを使用して再インストール
2. アンチウイルスソフトの除外設定にインストールフォルダを追加
3. 右クリック → 「管理者として実行」を試行

</details>

<details>
<summary>帳票出力でエラーが発生する</summary>

1. インストールフォルダ内の `Resources/Templates/物品出納簿テンプレート.xlsx` が存在するか確認
2. 出力先フォルダに書き込み権限があるか確認

</details>

<details>
<summary>アンインストール方法</summary>

1. 「設定」→「アプリ」→「交通系ICカード管理システム」を選択
2. 「アンインストール」をクリック
3. アンインストール完了時に、ユーザーデータ・バックアップ・ログの削除を選択可能

</details>

## ライセンス

[MIT License](LICENSE)

## 更新履歴

### v1.14.0 (2026-02-21)

**バグ修正**
- 新規登録時の繰越額が履歴逆算値で上書きされるバグを修正（#819）

**新機能**
- FlaUIによるWPF UIテスト自動化基盤を追加（起動テスト6件・ダイアログ遷移テスト3件）
- CIでUIテストを自動除外する設定を追加

### v1.13.2 (2026-02-20)

**改善**
- インストーラービルドスクリプト（.bat）にDebugDataViewerのクリーンビルドを追加（#816）

### v1.13.1 (2026-02-20)

**バグ修正**
- チャージ・新規購入・ポイント還元・払戻しの氏名欄を空欄にする（#807）
- 物品出納簿の頁番号が翌月以降で正しく連続しない問題を修正（#809）
- エクスポート後にインポート側のデータ種別が見えなくなる問題を修正（#805）
- 帳票作成ボタン押下時に前回のStatusMessageをクリアする（#812）
- 残高不整合の自動修正を削除し、警告表示のみに変更（#785）

### v1.13.0 (2026-02-19)

**新機能**
- 操作ログエクスポートをCSVからExcel形式に変更（#786）

**バグ修正**
- 同一日のチャージ・利用の表示順を残高チェーンで正しく決定（#784）
- メイン画面・履歴画面のDataGridにも残高チェーン再構築を適用（#784）
- 起動時にic_card.is_lentとledger.is_lent_recordの整合性を修復（#790）
- 操作ログの表示順を古い順に変更し、初期表示で最新ログを表示（#787）
- DEBUGテストデータの残高チェーン不整合を修正（#803）

**ドキュメント**
- 管理者マニュアルの職員証再登録手順を実装に合わせて修正（#783）
- 管理者マニュアルのカード登録設定テーブルに「繰越額」を追記（#782）
- 管理者マニュアルのインポート記載を実装と一致させる（#781）
- ユーザー・管理者マニュアルの設定画面に「部署設定」を追記（#780）
- 管理者マニュアルに「利用履歴詳細」のエクスポート/インポートを追記（#779）
- ユーザーマニュアルのCSVインポート記載に管理者マニュアルへの参照を追加（#788）

**その他**
- リリースビルド時にマニュアルへバージョンを自動注入する仕組みを追加

### v1.12.0 (2026-02-18)

**新機能**
- データ入出力に利用履歴詳細のエクスポート/インポートを追加（#751）
- 削除ボタンを履歴一覧から編集ダイアログへ移動（#750）
- 部署選択をアプリ初回起動時からインストーラーに移動（#742）

**バグ修正**
- チェック済み行の背景色を水色でハイライト表示（#772）
- AlternatingRowBackground/DataGrid選択ハイライトの優先度問題を修正（#772）
- 利用履歴詳細インポートで変更なしデータをスキップ表示に修正（#751）
- ハードコードされた色コードをDynamicResourceに統一（#721）
- カード登録時の繰越額をユーザーが手入力できるように変更（#756）
- 物品出納簿のドキュメントプロパティ日時を出力時に更新（#752）
- インポート時の残高整合性チェックでスキップ行が除外される問題を修正（#754）
- インポート後に履歴一覧・ダッシュボードを即座に更新（#744）
- 履歴一覧の受入金額を緑色から黒色に変更（#749）
- 月次繰越行の受入金額欄を空欄に修正（#753）

**アクセシビリティ**
- Popupコントロール・DatePickerのアクセシビリティを改善（#720）
- ハードコードされたフォントサイズをDynamicResourceに統一（#719）

**ドキュメント修正**
- ユーザーマニュアルに職員証認識後の画面スクリーンショットを追加（#747）
- 物品出納簿のExcel出力スクリーンショットをユーザーマニュアルに追加（#746）
- スクリーンショットREADMEを現状の18枚構成に更新（#776）
- ユーザーマニュアルに「別々の履歴に分割」と「摘要のみ更新」の説明を追記（#755）
- 管理者マニュアルのCSVインポート手順から実画面にない記述を修正（#757）

**その他**
- 企業会計部局テンプレートから記載例ワークシートを削除（#745）

### v1.11.1 (2026-02-17)

**バグ修正**
- 起動時の CS4014 警告メッセージを修正（#736）

**コード品質改善**
- 使われていないメソッド12個を削除（#733）

### v1.11.0 (2026-02-17)

**新機能**
- 市長事務部局／企業会計部局の選択機能を追加（#659）
  - チャージ時の摘要を部署種別に応じて自動切替（役務費／旅費）
  - 帳票テンプレートを部署種別に応じて自動切替
  - 初回起動時に部署選択ダイアログを表示
  - 設定画面から部署種別を変更可能

**バグ修正**
- Releaseビルドで起動エラー時のスタックトレースを非表示にする（#716）
- Su-001のライフサイクル整合性とデポジット除外を修正（#731）

**パフォーマンス改善**
- .Result呼び出しをasync/awaitに置換してデッドロックリスクを解消（#717）

**アクセシビリティ**
- VirtualCardDialogにAutomationPropertiesを追加（#718）

**ドキュメント修正**
- スクリーンショット16枚を追加・更新しマニュアルの画像参照を修正（#729）
- 画面設計書のダイアログ名修正と不足ダイアログ追加（#714）
- システム概要設計書のOS要件・CPU要件を実装に合わせて修正（#713）

### v1.10.0 (2026-02-16)

**新機能**
- 職員一覧・カード一覧で新規登録・更新・復元後に該当行をハイライト表示（#707）
- バス停名入力後にハイライト表示してから一覧削除するよう改善（#709）

### v1.9.0 (2026-02-15)

**新機能**
- 履歴画面に行の挿入・削除・修正機能を追加（#635）
- システム警告をクリック可能にし対象カード履歴へ遷移（#672）
- デバッグモードで職員証認証ダイアログに仮想タッチボタンを追加（#688）

**バグ修正**
- 貸出時にカード残高が0になる問題を修正（#656）
- バス停名入力後・履歴変更後に警告メッセージの件数を更新する（#660）
- 設定の残額警告閾値変更後にシステム警告メッセージを更新する（#661）
- カード一覧のデフォルトソートを「カード名順」に変更（#662）
- デフォルトのウィンドウサイズを拡大しボタンが一行に収まるよう修正（#663）
- 繰越登録時の履歴不完全メッセージに実際の最古月を表示（#664）
- カード管理画面の新規登録時に履歴を事前読み取りする（#665）
- 履歴画面の払出金額の文字色を赤から黒に変更（#671）
- XMLドキュメントの不足paramタグを追加しCS1573警告を解消（#701）
- バス停名未入力一覧に利用日フィルタを追加し、フィルタ条件を維持するよう改善（#703）
- 「変更」と「修正」ボタンを統合し一本化（#705）

**ドキュメント修正**
- ユーザーマニュアルにヘルプボタン（F7）の説明を追加（#668）
- 管理者マニュアルの「管理」メニュー参照を修正し、カード登録手順を補完（#669）
- 管理者マニュアルのシステム設定セクションをappsettings.jsonの実際の内容に合わせて修正（#670）
- ユーザーマニュアルに乗車履歴の自動統合の説明を追加（#691）
- マニュアルのページ方向をA4横に変更（#692）
- 管理者マニュアルに手動バックアップは通常不要である旨を追記（#693）
- マニュアル「はじめに」を追加（#694）
- FAQ Q5に20件超の履歴追加方法を追記（#644）

### v1.8.0 (2026-02-13)

**新機能**
- 開発ビルド用の仮想ICカードタッチ機能を追加（#640）
- 新規購入カードに購入日を指定可能にする（#658）

**バグ修正**
- 新規購入カードの登録日が月初めになるバグを修正（#657）

**ドキュメント修正**
- ユーザーマニュアルにシステム警告エリアの説明を追加（#666）

### v1.7.0 (2026-02-12)

**新機能**
- メインウィンドウにヘルプボタンを追加し、マニュアルを直接開けるようにする（#641）
- 履歴詳細画面の分割で「摘要のみ更新」か「別々の履歴に分割」を選択可能にする（#634）
- 利用履歴の変更で利用者を空欄にできるようにする（#636）
- マニュアルのPDF変換スクリプトを追加（#642）
- インストーラー作成時にdocx/PDFマニュアルを自動生成（#643）

**バグ修正**
- 認証ダイアログのサイズが文字サイズに追従しない問題を修正（#631）
- 履歴詳細画面の分割操作が摘要に反映されない問題を修正（#633）
- 物品出納簿の上書き時に備考欄が消える問題を修正（#637）
- データインポートのプレビューが表示されない問題を修正（#638）
- 履歴インポートで金額変更が検出されずスキップされる問題を修正（#639）

### v1.6.0 (2026-02-10)

**新機能**
- カード登録時に当月履歴を自動読み取りしてledgerに登録する機能を追加（#596）
- カード返却時に今月の履歴完全性をチェックし、不足の可能性がある場合に警告を表示（#596）
- CSVインポート実行後に完了ダイアログを表示（#598）
- CSVインポートプレビューを表形式で直接表示するよう改善（#597）

**バグ修正**
- カード種別選択ダイアログのサイズが文字サイズに追従しない問題を修正（#628）
- プレビュー表示とExcelファイルの内容が一致しない問題を修正（#603）
- 履歴エクスポート時に同一カードの履歴をまとめて出力するよう修正（#592）
- 帳票上書き時にデータ行の太字書式をリセットするよう修正（#591）
- 設定変更後にカード一覧の残額警告表示が即時更新されない問題を修正（#604）
- 認証ダイアログのメッセージに操作理由と読点を追加（#602）
- 「ICカード」表記を「交通系ICカード」に統一（#594）
- 繰越レコードの日付を繰越月の翌月1日に修正（#599）
- バス停名入力画面でバス停名の入力ができないバグを修正（#593）
- 新規購入が同一日のチャージより後に表示されるバグを修正（#590）
- マニュアルの表が印刷時に罫線が消えるバグを修正（#600）

**ドキュメント修正**
- DB設計書・画面設計書・クラス設計書を実装に合わせて更新（#570-#575）
- ユーザーマニュアル・管理者マニュアルの記載を修正（#568, #601）
- READMEのpublish出力パス・テスト数等を修正（#559, #561）

### v1.5.1 (2026-02-09)

**機能改善**
- カード一覧部のタイトルを「カード残高」から「カード一覧」に変更（#552）

**ドキュメント修正**
- 管理者マニュアルに利用開始時の交通系ICカード登録手順を追加（#553）
- 管理者マニュアルにデータインポートのセクションを追加（#554）
- README.mdのプラットフォームアーキテクチャ記載を修正（#558）
- ユーザーマニュアルの存在しないメニュー参照を修正（#562）
- ユーザーマニュアルの残額警告デフォルト値と範囲を修正（#563）
- ユーザーマニュアルのカード管理ボタンラベルを修正（#564）
- ユーザーマニュアルの音声設定を4モード対応に拡充（#565）
- ユーザーマニュアルにトースト通知位置・バックアップ設定を追記（#566）
- 管理者マニュアルのバックアップファイル名を修正（#567）
- DB設計書のDBファイル保存場所を修正（#569）

### v1.5.0 (2026-02-06)

**新機能**
- 履歴一覧から複数エントリの統合機能を追加（チェックボックスで選択→統合ボタン）
- 統合の取り消し機能を追加（DB永続化された履歴から任意の統合を選んで元に戻せる）
- 統合履歴選択ダイアログを追加（一覧から取り消したい統合を選択）
- 履歴統合のユニットテスト31件を追加（LedgerMergeServiceTests）
- 払戻済カード状態の追加
- 操作ログに変更内容の詳細表示を追加
- 履歴編集画面で利用者の変更を可能に

**改善**
- 統合対象の選択をCtrl+クリックからチェックボックス方式に変更（初心者にもわかりやすく）
- 統合完了・取消完了の通知をトースト通知からMessageBoxに変更（操作中の画面で確認しやすく）
- 元に戻せる統合履歴がない場合は「統合を元に戻す」ボタンをグレーアウト
- カード一覧の幅を広げて金額・貸出者を表示
- カード一覧とシステム警告の高さ比率を7:3に調整
- ヘッダーボタンをWrapPanelで折り返し対応に変更

**バグ修正**
- チャージと利用の履歴を統合できないようバリデーションを追加
- SummaryGenerator: グループID付き往復検出の修正（「A～A」→「A～B 往復」）
- 統合→分割後の履歴ソート順を修正（balance DESCをタイブレーカーに追加）
- System.Text.Json 4.7でDictionary&lt;int,int&gt;がシリアライズできない問題を修正
- 統合説明テキストにシャローコピー由来のバグがあった問題を修正
- 物品出納簿の上書き時にフッターが消える問題を修正
- 貸出処理時にカード残高を読み取るよう修正
- 西鉄バス利用時のバス判定を修正
- カード登録モード選択ダイアログのUI修正
- サイドバー幅をフォントサイズに応じて動的調整

### v1.4.0 (2026-02-06)

**新機能**
- 乗り継ぎ駅のエイリアスマッピング機能を追加（博多↔筑紫口等の同一乗り継ぎ駅を認識）
- 利用履歴CSVインポート時にカードIDm空欄を許可
- データエクスポート完了時に保存完了メッセージを表示
- デバッグ用データビューアにDBファイル選択機能を追加
- 年度途中に本アプリを導入した場合の新規登録に対応
- 物品出納簿に12行ごとの改ページ機能を追加（ヘッダー・備考欄も各ページにコピー）

**改善**
- 起動時間を短縮
- 乗車履歴統合・分割UIを大幅改善（分割線クリック方式、アルファベットラベル追加）

**バグ修正**
- 空港グループを乗り継ぎ同一視から除外
- 物品出納簿の金額セルの表示形式を会計形式に修正
- バックアップからのリストアが失敗する問題を修正
- アンインストーラーのファイル名をわかりやすく変更
- 新規購入より前の月の物品出納簿を作成しないよう修正

### v1.3.0 (2026-02-05)

**新機能**
- 物品出納簿を年度ファイル・月別シート構成に変更（年度ごとに1ファイル、月ごとにシート）
- 乗車履歴の統合・分割機能を追加（複数の乗車履歴を1つの行程にまとめる）

**改善**
- 利用履歴詳細画面の金額表示を正の値に変更（符号なし表示）
- 同一日ではチャージを利用より先に表示
- 月次繰越の受入欄を空欄に変更
- 新規購入カードの繰越行を非表示にする
- インストーラービルド時にマニュアルを自動変換

**バグ修正**
- 貸出タッチ忘れ時の履歴が記録されない問題を修正
- カード登録後にダッシュボードを更新するよう修正
- カード種別選択前に残高を読み取るように修正

### v1.2.0 (2026-02-04)

**新機能**
- 重要な操作（履歴編集・職員削除・カード削除）の前に職員証タッチによる認証を必須化
- ステータスバーにアプリケーションのバージョン番号を表示
- インストーラーにWindows起動時の常駐オプションを追加

**バグ修正**
- 履歴詳細の表示順を正しい時系列順に修正（チャージを含む場合も対応）

### v1.1.0 (2026-02-03)

**新機能**
- 残高整合性チェック機能を追加（交通系ICカードの実残高と記録の不一致を検出）
- 開発者向けスクリーンショット撮影ツールを追加

**改善**
- ユーザーマニュアル・管理者マニュアルの内容を充実

### v1.0.8 (2026-02-01)

**ドキュメント**
- 配布手順書をインストーラー対応に更新
- 機能設計書の誤記を修正

### v1.0.7 (2026-01-31)

**新機能**
- アンインストール時にユーザーデータ・バックアップ・ログの削除を選択可能に
- インストーラーのバージョンをアプリ本体と自動同期

### v1.0.6 (2026-01-31)

**改善**
- ビルド時の警告を解消

### v1.0.5 (2026-01-31)

**改善**
- デフォルトの文字サイズですべてのボタンが画面内に収まるように調整

### v1.0.4 (2026-01-31)

**バグ修正**
- マイグレーションテストの不具合を修正

### v1.0.3 (2026-01-31)

**改善**
- 履歴の表示順を物品出納簿に合わせて古い順（昇順）に変更

### v1.0.2 (2026-01-31)

**新機能**
- 残高不足時の現金補填に対応（備考に不足額を自動記録）

### v1.0.1 (2026-01-30)

**新機能**
- ポイント還元によるチャージに対応
- 交通系ICカードの払い戻し処理に対応

### v1.0.0 (2025-12)

- 初版リリース
