# プロンプト主文

以下の要件を満たすシステムを設計してください。
設計の結果は、適宜分割し、マークダウン形式のファイルとして保存してください。

## 目的

A枚の交通系ICカードをB人でシェアして使っています（A<B。概ねAは1〜5程度。Bは5〜30程度。）。
これらの交通系ICカードの使用記録を管理する必要があります。
現在は、次に記載する記録項目をExcelに手で入力していますが、これを極力簡単にすることが主たる目的です。
できるだけ自動化することを目指しますが、同時に、バス停名の入力や運用誤り時の訂正など、手動で対応できる柔軟さも必要です。

## 管理内容

### 記録すべき項目

1. 交通系ICカードの種類
1. 交通系ICカードの通し番号

それぞれの交通系ICカードについて、

1. 出納年月日
1. 摘要（乗降区間 または 「チャージ」 または 「新規購入」 または 「次年度へ繰越」または「（貸出中）」）
1. 受入金額（チャージ金額のこと）
1. 払出金額（利用金額のこと）
1. 残額
1. 氏名
1. 備考

### 月次帳票

任意のタイミング（通常は、月末または月初の月一回）で、任意の月の一か月分のまとめを出力します。
月次帳票の名称は「物品出納簿」と言います。
通常は「先月」または「今月」の一覧表を作成することが多いので、「先月」「今月」ボタンで素早く選択できるようにする必要がありますが、それ以外の任意の月も年月を直接入力して選択できる必要があります。

## 前提

### 交通系ICカード内履歴の利用

乗降区間は交通系ICカード内の履歴を読み取ることで確認できます。
交通系ICカード内には履歴が20件までしか残りませんが、通常、一度の貸出において20件を超える利用はありません。
ただし、ごくまれに21件以上の利用がある場合があるので、その場合には、手動で入力できる必要があります。
またバスでの利用については乗降区間は交通系ICカード内の履歴からはわからないので、そこは職員が手入力することとします。

### 職員証

各職員は一人一枚ずつ職員証を所持しています。
職員証はFeliCaタイプであり、一枚一枚固有のIDmを有しています。
職員の識別には、この職員証のIDmを利用します。

### 利用可能なハードウェア

交通系ICカード内及び職員証内の情報を読み出すためのパソコンとICカードリーダーは利用可能です。

### 利用環境

インターネットから隔離された閉じたネットワーク内で使用することとなるので、クラウドサービスの利用などはできません。
ただし、Microsoft 365 E3は、特別に穴をあけて利用できるようになっています。

### データの保存期間

管理する交通系ICカードの使用履歴については、監査対応のため５年度分は保存しておく必要があります。
このため、登録から６年間経過したデータは自動で削除することとします。
これにより、保存しておくべきデータは最大でも数千件と考えて良いです。

### セキュリティ

#### 職員の識別

DBの内容を変更するすべての操作について、職員証による職員の識別を行います。
ただし、パスワード等による本人認証までは行いません。職員証を所持していることで本人であると判断します。これはセキュリティ的に完璧とは言えないことはわかっていますが、利便性とのバランスを考慮した結果です。

#### 機密性

職員の氏名や職員番号、各カードのIDmについては機密情報として扱う必要はありません。

#### ログ

すべての手動操作（登録/修正/削除）を自動ログ記録することとします。

### アクセシビリティ

誰にとってもわかりやすい表現が望ましいです。
テキストだけでなく、音や色でも識別できることが望ましいです。
音や色のみで情報を認識させるのは避けるべきです。



## 主要なコンポーネント

### ハードウェア

1. パソコン(Windows 11)（Windows以外への移植性を気にする必要はありません。）
1. ICカードリーダ(PaSoRi対応)

### ソフトウェア

1. 職員証や交通系ICカードのタッチ、月次帳票印刷指示などの処理を待つプログラム
1. 月次帳票のテンプレート
1. 職員証や交通系ICカード及びそれらの利用履歴を管理するDB。以下のテーブルや項目を含むがこれらだけに限定されない。
    1. 職員証のIDm及びそれに紐づく職員等を管理するテーブル
        1. 職員証IDm
        1. 職員氏名
        1. 職員番号
        1. 備考
    1. 交通系ICカードのIDm及びそれに紐づく通し番号等を管理するテーブル。
        1. 交通系ICカードIDm
        1. 通し番号
        1. 備考
    1. 利用履歴の概要を管理するテーブル（一回の貸し出しあたり1レコード）
        1. 交通系ICカードIDm
        1. 出納年月日時分秒
        1. 摘要
        1. 受入金額
        1. 払出金額
        1. 残額
        1. 貸出者IDm
        1. 備考
        1. 返却者IDm
    1. 利用履歴の詳細を管理するテーブル（一回の貸し出しにおける交通系ICカードの利用を記録するテーブル）
        1. 利用年月日時分秒
        1. 乗車駅／チャージ
        1. 降車駅
        1. 利用／チャージ額
        1. 残額
    1. 操作の履歴を記録するテーブル
        1. 操作年月日時分秒
        1. 操作者IDm
        1. 操作対象
        1. 操作前内容
        1. 操作後内容

### ドキュメント

1. 一般ユーザ（職員）向けのマニュアル

ソフトウェアの利用の仕方、バス停情報の入力の仕方、貸出処理漏れや返却処理漏れがあった場合の対応の仕方などが記載されている。

1. 管理者向けのマニュアル

インストールの仕方、アンインストールの仕方、ソフトウェアの各コンポーネントの説明、改造する場合のポイントなどが記載されている。

## 動作フロー

### 初期画面

1. 起動直後の画面には、画面上部にボタンバー（F1〜F6ショートカット対応）、ウィンドウ中央部に状態に応じたガイダンスメッセージが表示されます。
1. 初期状態（職員証タッチ待ち）では、「職員証をタッチしてください」と表示されます。
1. 画面下部には、「30秒以内に同じカードを再タッチすると逆の処理（貸出→返却、返却→貸出）ができます」という案内が常時表示されています。
1. 利用バス停名の入力がなされていない履歴がある場合には、警告メッセージが表示されます。
1. 残額が一定金額（設定で変更可能です。）未満の交通系ICカードがある場合にも、警告メッセージが表示されます。

### 履歴表示部

1. 職員証のタッチなしに交通系ICカードがタッチされると、ウィンドウ中央に大きく当該交通系ICカードの直近の利用履歴が、新しい方が上に表示されます。1ページあたりの表示件数は初期値50件で、20件／50件／100件から選択可能です。
1. 履歴のヘッダとして表示される内容は、以下のとおりです。
    1. 物品の分類：「雑品（金券類）」（固定文字列）
    1. 品名：読み取った交通系ICカードの種類により、「はやかけん」、「nimoca」又は「SUGOCA」など
    1. 規格：読み取った交通系ICカードの通し番号
    1. 単位：「円」（固定文字列）
    1. 頁：ページ番号
1. 履歴の各行に表示される内容は、以下のとおりです。
    1. 出納年月日
    1. 摘要（注：乗降区間 または 「チャージ」 または 「新規購入」 または 「次年度へ繰越」または「（貸出中）」）
    1. 受入金額（注：チャージ金額のこと）
    1. 払出金額（注：利用金額のこと）
    1. 残額
    1. 氏名
    1. 備考
1. 各行の右側には、「詳細」ボタン、「修正」ボタンがあります。
1. 「詳細」ボタンをクリックすると、その行に記載されている履歴の詳細が表示されます。
1. 「修正」ボタンをクリックすると、その行の記載内容の修正が可能となります。

### ボタンバー（画面上部）

画面上部には以下のボタンが配置されており、各機能にアクセスできます。キーボードショートカット（F1～F6）も利用可能です。

| ボタン | ショートカット | 機能 |
|--------|---------------|------|
| 帳票 | F1 | 月次帳票（物品出納簿）の作成・プレビュー・印刷 |
| 職員管理 | F2 | 職員証の登録／変更／削除 |
| 交通系ICカード管理 | F3 | 交通系ICカードの登録／変更／削除 |
| データ入出力 | F4 | CSVエクスポート/インポート |
| 設定 | F5 | 残額警告閾値、文字サイズ、音声設定など |
| システム管理 | F6 | 操作ログ、手動バックアップ、リストア（データ復元） |
| 終了 | - | アプリケーションの終了 |

### 貸出時

職員は、職員証をICカードリーダにかざします。
適切に職員証が認識されるとピッと音がします。
続いて、職員は、「職員証を確認しました。」「交通系ICカードをかざしてください。」のメッセージが出ていることを目視で確認したうえで、交通系ICカードをICカードリーダにかざします。
適切に交通系ICカードが認識されるとピッと音がするとともに、画面上に「いってらっしゃい！」と表示されます。

交通系ICカードをかざした際に、残額が10,000円（この金額は設定で変更可能です。）未満の場合は「残額が10,000円未満になっています。」という警告メッセージが表示されます。

前回返却時に返却処理が正しくなされなかったために貸出中状態となっている交通系ICカードを貸し出そうとした場合には返却処理とみなされてしまい「おかえりなさい！」と表示されますが、30秒以内にもう一度同じ交通系ICカードをタッチした場合には、貸出処理を行います。この場合、返却者が本来の返却者ではなく貸出を行おうとしている職員になってしまうこと、また、バス利用があった場合に返却処理中に行うバス停名の入力処理が行われないため、必要に応じて、後でデータを修正してください。
この、貸し出しのタイミングなのに「おかえりなさい！」と表示された場合はやり直すという点については、ユーザマニュアルにわかりやすく記載することとします。

誤って職員証を二回かざした場合や、職員証よりも先に交通系ICカードをかざした場合、未登録のカードをかざした場合、職員証をかざした後１分以上交通系ICカードをかざさなかった場合などには、ピーとエラー音が鳴るとともに、適切なメッセージ（かざすカードの変更やカードの登録など）が表示されます。

### 返却時

職員は、職員証をICカードリーダにかざします。
適切に職員証が認識されるとピッと音がします。
続いて、職員は、「職員証を確認しました。」「交通系ICカードをかざしてください」のメッセージが出ていることを目視で確認したうえで、交通系ICカードをICカードリーダにかざします。
適切に交通系ICカードが認識されるとピピッと音がするとともに、画面上に「おかえりなさい！」と表示されます。（貸出時の「いってらっしゃい！」とは異なる音と色が用いられ、区別がつきやすいようになっています。）

交通系ICカードをかざした際に、残額が10,000円（この金額は設定で変更可能です。）未満の場合は「残額が10,000円未満になっています。」という警告メッセージが表示されます。

前回貸出時に貸出処理が正しくなされなかったために未貸出状態となっている交通系ICカードを返却しようとした場合には貸出処理とみなされてしまい「いってらっしゃい！」と表示されるので、30秒以内にもう一度同じ交通系ICカードをタッチすると、返却処理が行われます。（30秒以内に再タッチできなかった場合は、改めて職員証のタッチから行う必要があります。）

誤って職員証を二回かざした場合や、職員証よりも先に交通系ICカードをかざした場合、未登録のカードをかざした場合などには、ピーとエラー音が鳴るとともに、適切なメッセージ（かざすカードの変更やカードの登録など）が表示されます。

### バス停名の入力／修正

返却時、バスの利用の場合には乗降バス停名を手入力する画面が表示されますので、手入力します。
後から修正も可能ですので、いったん空欄のまま完了とすることも可能です。
バス停名の入力／修正／削除は誰でも実施することができ、必ずしも交通系ICカードを利用した本人である必要はありません。ただし、誰が入力／修正／削除を行ったかを確認できるようにするため、職員証をタッチして職員を識別します。
バス停名の入力／修正／削除を後から行う場合には、履歴横の「修正」ボタンをクリックします。

### 月次帳票の作成

ボタンバーの「帳票」ボタン（F1）をクリックすると、月次帳票作成ダイアログが開きます。
「先月」「今月」ボタンで選択するか、対象年月を入力します。
「Excelファイル作成」ボタンをクリックすると、月次帳票がExcel形式で作成され表示されます。
帳票の記載内容については機能詳細のところで詳述します。

### 交通系ICカードの管理

ボタンバーの「交通系ICカード管理」ボタン（F3）をクリックすると、交通系ICカードの情報を管理するダイアログが開きます。
交通系ICカードの登録／修正／削除ができます。

交通系ICカードの登録は、交通系ICカードをICカードリーダにかざし、読み込んだIDmと紐づく交通系ICカードの通し番号を入力します。
備考があれば備考欄に入力します。
必要に応じて登録内容を修正したり、登録した交通系ICカードを削除することができます。

### 職員証の管理

ボタンバーの「職員管理」ボタン（F2）をクリックすると、職員証の情報を管理するダイアログが開きます。
職員証の登録／修正／削除ができます。

職員証の登録は、職員証をICカードリーダにかざし、読み込んだIDmと紐づく職員の氏名及び職員番号を入力します。
備考があれば備考欄に入力します。
必要に応じて登録内容を修正したり、登録した職員証を削除することができます。





## 機能詳細

### 履歴表示機能

1. 画面に、利用履歴概要テーブルから読み取った履歴を表示します。初期表示は１ページあたり50件とし、ユーザの操作により20件／50件／100件から選択できるようにします。また、ページ切り替えによりそれ以前の履歴も表示させることができるようにします。
1. 履歴のヘッダに表示する内容は以下のとおりです。
    1. 物品の分類：「雑品（金券類）」（固定文字列）
    1. 品名：読み取った交通系ICカードの種類により、「はやかけん」、「nimoca」又は「SUGOCA」など
    1. 規格：読み取った交通系ICカードの通し番号
    1. 単位：「円」（固定文字列）
    1. 頁：ページ番号
1. 履歴の各行に表示する内容は、以下のとおりです。
    1. 出納年月日
    1. 摘要（乗降区間 または 「チャージ」 または 「新規購入」 または 「次年度へ繰越」または「（貸出中）」）
    1. 受入金額（チャージ金額のこと）
    1. 払出金額（利用金額のこと）
    1. 残額
    1. 氏名（DBには貸出者IDmとして職員証のIDmが登録されているので、これを職員の氏名に変換して表示します。）
    1. 備考
1. 各行の右側には、「詳細」ボタン、「修正」ボタンを表示します。ただし、詳細がない場合（鉄道やバスの利用またはチャージが1回分しかない場合）は、「詳細」ボタンはグレーアウトし、クリックできないようにします。
1. 「詳細」ボタンがクリックされたら、別ウィンドウを開き、その行に記載されている履歴の詳細を表示します。
    履歴の詳細とは、例えば、乗車が、祇園→天神、天神→祇園という場合、履歴画面には「鉄道（祇園〜天神 往復）」という1行の表示となりますが、これに対して、詳細として「祇園→天神」、「天神→祇園」の2行を表示するということです。
    履歴の詳細として表示する内容は、以下のとおりです。
    1. 鉄道やバスの利用の場合
        1. 利用年月日時分
        1. 乗車駅
        1. 降車駅
        1. 利用金額
        1. 残額
    1. チャージの場合
        1. チャージ年月日時分
        1. チャージ金額
        1. 残額

    なお、チャージの場合、チャージ金額を、鉄道やバスの利用の場合の利用金額欄に記載し、鉄道やバスの利用の場合の乗車駅、降車駅の欄は空欄とします。
1. 「修正」ボタンがクリックされたら、その行の記載内容の修正を可能とします。
    1. 職員証のタッチを促し、タッチされた職員証のIDmにより職員を識別します。
    1. 当該行の背景色を通常と異なるやや目立つ色にします。
    1. 当該行の右側の「詳細」及び「修正」ボタンを消去し、「完了」と「キャンセル」ボタンを表示します。
    1. 修正を行う項目をマウスまたはカーソル移動キーで選択させます。
    1. 内容の修正を待ちます。
    1. 項目の修正が終わった（別の項目が選択された）ら、修正された項目は赤色太文字として目立たせます。（項目が選択されたが実際には修正がなされなかった場合は目立たせる必要はありません。）
    1. 「完了」ボタンがクリックされた場合は、修正後内容及び修正した職員証のIDmをDBに登録します。
    1. 「キャンセル」ボタンがクリック場合は、修正内容を破棄し、背景色や右側のボタン表示も元に戻します。
1. 各項目の幅は、ウィンドウの大きさに応じて適切な大きさになるようにします。

### 貸出時／返却時処理

ユーザーからの職員証や交通系ICカードのタッチを待ち、タッチされたカードの種類や状態に応じて適切な処理を行う機能です。

#### 待ち受け処理

状態を「職員証タッチ待ち」状態とし、カードのタッチやメニュー項目（「バス停名入力／修正」や「カード管理」など）のクリックを待ち受けます。
カードがタッチされたら、タッチされたカードのIDmを読み取り、当該IDmが次のいずれに該当するかにより、それぞれ記載の処理を行います。
なお、例えばバス停名の入力中や履歴の確認中など、職員が何らかの操作を行っている際にも以下の処理を行う必要があります。「いってらっしゃい！」などのメッセージは画面の端の方（例えば右上）に表示させたり、入力中の項目のフォーカスを移動させないなど、職員の操作の邪魔になりにくいよう考慮する必要があります。

1. 読み取ったIDmが登録済みの職員証であった場合
    1. 現在の状態が「職員証タッチ待ち」である場合
        1. 職員証のIDmを記録する。
        1. 「ピッ」と音を鳴らす。
        1. 状態を「交通系ICカードタッチ待ち」状態として、次のカードのタッチを待つ。
    1. 現在の状態が「交通系ICカードタッチ待ち」である場合
        1. 「ピー」と音を鳴らす。
        1. 「交通系ICカードをタッチしてください。」というメッセージを表示する。
        1. タッチした職員証が誤ったものであった場合（他人の職員証をタッチしてしまったなど）や、意図せずタッチしてしまった場合もあり得るため、必ずしも交通系ICカードのタッチを必要とせず、キャンセルして、待ち受け状態に戻るための手段も用意する必要があります。
    1. 現在の状態がそれ以外の場合
        何もせず、次のタッチやボタンのクリックを待つ。
1. 読み取ったIDmが登録済みの交通系ICカードであった場合
    1. 現在の状態が「職員証タッチ待ち」である場合
        1. 当該交通系ICカードの履歴を表示します。
    1. 現在の状態が「交通系ICカードタッチ待ち」である場合
        1. 当該IDmの交通系ICカードの状態が次のいずれに該当するかにより、それぞれ記載の処理を行います。
            1. 現在の状態が「未貸出」状態のとき
                後述の貸出機能処理を行う。
            1. 現在の状態が「貸出中」状態のとき
                後述の返却機能処理を行う。
        1. 状態を「職員証タッチ待ち」状態として、次のカードのタッチを待つ。
    1. 現在の状態がそれ以外の場合
        何もせず、次のタッチやボタンのクリックを待つ。
1. 読み取ったIDmが未登録のカードであった場合
    1. 未登録カードである旨のメッセージを表示するとともに、職員証又は交通系ICカードとして新規登録するかどうかを確認するメッセージを表示する。
        1. 新規登録する場合
            後述のICカード管理処理を行います。
            次のカードのタッチやクリックを待つ状態に戻ります。
        1. 新規登録しない場合
            状態は何も変更せず、次のカードのタッチやボタンのクリックを待つ。
1. メニューがクリックされた場合は、当該メニュー項目の内容に応じて、それぞれ記載の処理を行います。

#### 貸出機能

1. 現在時刻を貸出時刻として記録する。
1. 利用履歴概要テーブルに、以下のとおり新規レコードを追加する。
    1. 交通系ICカードIDm：読み取った交通系ICカードのIDm
    1. 出納年月日：　貸出時刻
    1. 摘要：　「（貸出中）」
    1. 受入金額：　０
    1. 払出金額：　０
    1. 残額：　０
    1. 貸出者IDm：　読みとった職員証のIDm
    1. 備考：　空文字
    1. 返却者IDm：　空文字
1. 当該交通系ICカードの状態を「貸出中」状態にする。
1. 画面に「🚃→ いってらっしゃい！」と２秒間表示する。背景色は薄いオレンジ(#FFE0B2)とします。
1. エラーが発生しなければ「ピッ」と音を鳴らす。
1. 途中でエラーが発生した場合は「ピー」とエラー音を鳴らし、状況に応じた適切なメッセージを表示する。
1. 交通系ICカードがタッチされてから30秒以内に再度同じ交通系ICカードがタッチされた場合には、貸出処理終了後、引き続き、返却処理を行う。

#### 返却機能

1. 読み取った職員証のIDmを返却者IDmとして記録する。
1. 当該交通系ICカードの履歴（最大20件）を読み込む。
1. 当該交通系ICカードのIDmを用いて、履歴概要テーブルから、貸出時のレコードを特定し、「貸出者IDm」を読み取る。
1. 貸出時刻以降の履歴について、
    1. DBの利用履歴詳細に登録する。
    1. 利用日ごとに、電車やバス利用のエントリとチャージのエントリとを分ける。
        1. 電車やバスの利用について
            1. 月次帳票の摘要欄に用いる文字列（「祇園～天神　往復」など）を作成する。
            1. 当該日の利用金額を算出する。
            1. 利用履歴概要テーブルに、以下のとおり新規レコードを追加する。
                1. 交通系ICカードIDm：　読み取った交通系ICカードのIDm
                1. 出納年月日：　利用日
                1. 摘要：　作成した文字列
                1. 受入金額：　0
                1. 払出金額：　利用金額
                1. 残額：　当該エントリの最後の残額
                1. 貸出者IDm：　上で読み取った「貸出者IDm」
                1. 備考：　空文字列
                1. 返却者IDm：　返却者IDm
        1. チャージについて
            1. 当該日のチャージ合計金額を算出する。
            1. 利用履歴概要テーブルに、以下のとおり新規レコードを追加する。
                1. 交通系ICカードIDm：　読み取った交通系ICカードのIDm
                1. 出納年月日：　チャージ日
                1. 摘要：　「役務費によりチャージ」
                1. 受入金額：　チャージ額
                1. 払出金額：　0
                1. 残額：　当該エントリの残額
                1. 貸出者IDm：　空文字列
                1. 備考：　空文字列
                1. 返却者IDm：　返却者IDm
1. 当該交通系ICカードの状態を「未貸出」状態にする。
1. 画面に「🏠← おかえりなさい！」と２秒間表示する。背景色は薄い水色(#B3E5FC)とします。
1. エラーが発生しなければ「ピピッ」と音を鳴らす。（貸出時とは音を変え、貸出か返却化を識別しやすくしています。）
1. バス利用があった場合には、バスの利用区間を入力する画面を表示し、入力を促す。
1. 途中でエラーが発生した場合は「ピー」とエラー音を鳴らし、状況に応じた適切なメッセージを表示する。
1. 交通系ICカードがタッチされてから30秒以内に再度同じ交通系ICカードがタッチされた場合には、バス利用区間の入力画面を表示中であればそれを閉じ、返却処理を完了し、貸出処理へ進む。



#### 交通系ICカードの登録／修正／削除

ボタンバーの「交通系ICカード管理」ボタン（F3）がクリックされたら、交通系ICカードを管理するダイアログを開きます。

1. 職員証のタッチを促し、タッチされた職員証のIDmを一時保存します。
1. 交通系ICカードをICカードリーダにかざすようメッセージを表示します。
1. 通し番号の入力を促すメッセージを表示し、入力を待ちます。
1. 読み取った交通系ICカードのIDm、通し番号及び職員証IDmを、DBに登録します。
1. 備考欄も設け、備考を入力できるようにします。

必要に応じて登録内容を修正したり、登録した交通系ICカード情報の削除もできるようにします。

#### 職員証の登録／修正／削除

ボタンバーの「職員管理」ボタン（F2）がクリックされたら、職員証を管理するダイアログを開きます。

1. 操作を行う職員の職員証のタッチを促し、タッチされた職員証のIDmを一時保存します。ここで、未登録の職員証がタッチされ場合には、その職員証を登録するものとして、次の、職員証のタッチを待つステップをスキップします。
1. 登録する職員証をICカードリーダにタッチするようメッセージを表示し、タッチを待ちます。
1. 職員氏名及び職員番号の入力を促すメッセージを表示し、入力を待ちます。
1. 読み取った職員証のIDm、職員氏名、職員番号及び職員証IDmを、DBに登録します。
1. 備考欄も設け、備考を入力できるようにします。

必要に応じて登録内容を修正したり、登録した職員証情報の削除もできるようにします。


#### 月次帳票作成機能

1. ボタンバーの「帳票」ボタン（F1）がクリックされたら、月次帳票作成ダイアログを開きます。
1. 「先月」「今月」ボタンで素早く対象月を選択できるようにします。それ以外の月については、年月を直接入力できるようにします。
1. 「Excelファイル作成」ボタンがクリックされたら、月次帳票をExcel形式で作成し表示します。
1. 「印刷プレビュー」ボタンで、作成した帳票の印刷プレビューを表示できます。プレビュー画面から直接印刷することも可能です。
1. 用紙方向（縦／横）を切り替えることができます。
1. 月次帳票のテンプレートは「物品出納簿テンプレート.xlsx」です。
このファイルの１行目及び２行目は各ページの行ヘッダとして利用され、３行目の部分を複製しそこに履歴を記載するようにしてください。
また、頁の欄に自動的にページ番号が表示されるようにしてください（行の高さはユーザにより変更される可能性があるため、１ページ当たりの行数は固定ではないことに注意してください。）。
1. 摘要欄が「（貸出中）」となっているものは無視します。

##### ヘッダ

各ページのヘッダとして次の情報を表示します。

1. 物品の分類：「雑品（金券類）」
1. 品名：読み取った交通系ICカードの種類により、「はやかけん」、「nimoca」又はOCA」
1. 規格：読み取った交通系ICカードの通し番号
1. 単位：「円」
1. 頁：ページ番号★

##### 出納年月日欄

同一日内に利用とチャージががある場合は利用で一行、チャージで一行とします。

##### 摘要欄

1. バスのみの利用の場合は、返却直後の状態では「バス（★）」（★の部分は文字色を変えて目立たせます。）と表示し、職員がバスの利用区間を入力した後には、職員が手入力した文字列を表示します。
1. 鉄道利用の場合は以下のとおりです。
    1. 履歴が、A駅→B駅という一件だけの場合
        「鉄道（A駅～B駅）」
    1. 履歴が、A駅→B駅、B駅→A駅、すなわち二つの駅の往復のみの場合
        「鉄道（A駅～B駅　往復）」
       なお、往復かどうかの判断は、単にA駅→B駅、B駅→A駅というパターンだけでなく、A駅→B駅→C駅、C駅→B駅→A駅のようなパターンもあり得ます。この場合は「鉄道（A駅～C駅　往復）」という記載とします。
       また、間にチャージが入る場合もあるが、利用区間の判断にはチャージは無視します。
    1. 履歴が、A駅→B駅、B駅→C駅、C駅→D駅のように、乗り継ぎがある場合
        「鉄道（A駅～D駅）」のように、途中の乗り継ぎ駅は省略し、最初と最後の駅名のみを表示します。
    1. 履歴が、A駅→B駅、C駅→D駅、E駅→F駅のように二件以上ある場合
        「鉄道（A駅～B駅、C駅～D駅、E駅～F駅）」のように省略せず記載します。なお、この場合も前項の乗り継ぎの部分は省略することとします。
    1. 鉄道とバスの併用の場合には、バスの利用区間の手入力が必要であることがわかりやすいよう、「鉄道（A駅～B駅）、バス（★）」又は「バス（★）、鉄道（A駅～B駅）」のように表示します。
1. 新規購入時には「新規購入」と記載します。
1. チャージの場合は、「役務費によりチャージ」と記載します。

##### 受入金額欄

###### 新規登録時

交通系ICカード内の残額を記載する。

###### チャージ時

チャージした金額を記載する。

##### 払出金額欄

鉄道やバスによる利用額を記載する。

##### 残額欄

交通系ICカード内の残額を記載する。

##### 氏名欄

###### 新規登録時及びチャージ時

空欄とする。

###### 鉄道やバスの利用時

貸出処理を行った職員の氏名を記載する。

##### 備考欄

常に空欄とします。
この欄は、人間が必要に応じて内容を記載するための欄です。

##### 月末処理

当該月の最後に、以下の行を追加します。

1. 出納年月日欄は空欄とする。
1. 摘要欄に「〇月計」と記載する。〇には当該月の数字が入る。
1. 受入金額欄は当該月の受入金額欄の合計金額を記載する。
1. 払出金額欄は当該月の払出金額欄の合計金額を記載する。
1. 残額欄は当該月末時点での残額を記載する。ただし、３月末の場合は、残額欄は空欄とします。
1. 氏名欄は空欄とする。
1. 備考欄は空欄とする。

##### 年度末処理

年度末に残額がある場合には、月末行に加えて、次のように二行を追加する処理を行います。

1. 一行目
    1. 出納年月日欄は空欄とする。
    1. 摘要欄に「累計」と記載する。
    1. 受入金額欄は当該年度の受入金額欄の合計金額を記載する。
    1. 払出金額欄は当該年度の払出金額欄の合計金額を記載する。
    1. 残額欄は当該年度末時点での残額を記載する。
    1. 氏名欄は空欄とする。
    1. 備考欄は空欄とする。
1．二行目
    1. 出納年月日欄は空欄とする。
    1. 摘要欄に「次年度へ繰越」と記載する。
    1. 受入金額欄は空欄とする。
    1. 払出金額欄にその時点での残額を記載する。
    1. 残額欄に0と記載する。
    1. 氏名欄は空欄とする。
    1. 備考欄は空欄とする。


##### 年度初め処理

4月については、年度はじめの処理として、一行目に以下の記載を追加します。

1. 出納年月日欄は当該年の4月1日とする。
1. 摘要欄に「前年度より繰越」と記載する。
1. 受入金額欄はその時点での残額とする。
1. 払出金額欄は空欄とする。
1. 残額欄はその時点での残額とする。
1. 氏名欄は空欄とする。
1. 備考欄は空欄とする。



##### 具体例

###### 条件

1. 交通系ICカードの種類：はやかけん
1. 交通系ICカードの通し番号：No.3
1. 貸出日：令和７年11月４日
1. 貸出者：福岡太郎
1. 返却日：令和７年11月５日
1. 返却者：博多次郎
1. 利用区間
    1. 2025/11/04   福岡市地下鉄　祇園　→　福岡市地下鉄　福岡空港   利用額：260円   残額：15,100円  利用者：福岡太郎
    1. 2025/11/04   東京モノレール　羽田第一ターミナル　→　東京モノレール　モノレール浜松町   利用額：519円   残額：14,581円  利用者：福岡太郎
    1. 2025/11/04   JR東日本　浜松町　→　JR東日本　東京   利用額：178円   残額：14,403円  利用者：福岡太郎
    1. 2025/11/05   JR東日本　東京　→　JR東日本　浜松町   利用額：178円   残額：14,225円  利用者：福岡太郎
    1. 2025/11/05   東京モノレール　モノレール浜松町　→　東京モノレール　羽田第一ターミナル   利用額：519円   残額：13,706円  利用者：福岡太郎
    1. 2025/11/05   福岡市地下鉄　福岡空港　→　福岡市地下鉄　祇園   利用額：260円   残額：13,446円  利用者：福岡太郎
1. 返却時の交通系ICカード内の履歴20件
    1. 2025/10/28   福岡市地下鉄　薬院　→　福岡市地下鉄　博多   利用額：210円   残額：10,000円  利用者：福岡太郎
    1. 2025/10/30   福岡市地下鉄　博多　→　福岡市地下鉄　薬院   利用額：210円   残額：9,790円  利用者：福岡太郎
    1. 2025/10/30   西鉄電車　薬院　→　西鉄電車　大橋   利用額：220円   残額：9,570円   利用者：福岡太郎
    1. 2025/10/30   西鉄電車　大橋　→　西鉄電車　薬院   利用額：220円   残額：9,350円   利用者：福岡太郎
    1. 2025/10/30   福岡市地下鉄　薬院　→　福岡市地下鉄　博多   利用額：210円   残額：9,140円  利用者：福岡太郎
    1. 2025/10/31   西鉄バス　駅前一丁目　→　西鉄バス　薬院駅前 利用額：150円   残額：8,990円   利用者：博多次郎
    1. 2025/10/31   西鉄バス　薬院駅前　→　西鉄バス　六本松 利用額：210円   残額：8,780円   利用者：博多次郎
    1. 2025/10/31   西鉄バス　六本松　→　西鉄バス　薬院駅前 利用額：210円   残額：8,570円   利用者：博多次郎
    1. 2025/10/31   西鉄バス　薬院駅前　→　西鉄バス　駅前一丁目 利用額：150円   残額：8,420円   利用者：博多次郎
    1. 2025/10/31   チャージ：10,000円  残額：18,420円
    1. 2025/10/31   福岡市地下鉄　祇園　→　福岡市地下鉄　福岡空港   利用額：260円   残額：18,160円  利用者：福岡三郎
    1. 2025/10/31   西鉄バス　福岡空港前　→　西鉄バス　席田   利用額：210円   残額：17,950円  利用者：福岡三郎
    1. 2025/10/31   西鉄バス　席田会館前　→　西鉄バス　福岡空港前   利用額：210円   残額：17,740円  利用者：福岡三郎
    1. 2025/10/31   福岡市地下鉄　福岡空港　→　福岡市地下鉄　祇園   利用額：260円   残額：17,480円  利用者：福岡三郎
    1. 2025/11/1    福岡市地下鉄　祇園　→　JR九州　筑前前原    利用額：640円   残額：16,840円  利用者：福岡太郎
    1. 2025/11/1    JR九州　筑前前原　→　福岡市地下鉄　祇園    利用額：640円   残額：16,200円  利用者：福岡太郎
    1. 2025/11/2    福岡市地下鉄　祇園　→　福岡市地下鉄　貝塚    利用額：260円   残額：15,940円  利用者：博多次郎
    1. 2025/11/2    西鉄電車　貝塚　→　西鉄電車　西鉄香椎    利用額：160円   残額：15,780円  利用者：博多次郎
    1. 2025/11/2    西鉄電車　西鉄香椎　→　西鉄電車　貝塚    利用額：260円   残額：15,520円  利用者：博多次郎
    1. 2025/11/2    福岡市地下鉄　貝塚　→　福岡市地下鉄　祇園    利用額：160円   残額：15,360円  利用者：博多次郎

1. 貸出時の残額：15,360円
1. 返却時の残額：13,446円

###### 具体的な物品出納簿の記載内容(過去の履歴分を含む)

|物品の分類|雑品（金券類）|品名|はやかけん|規格|No.3|単位|円|頁||
| ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |

|出納年月日|摘要|受入金額|払出金額|残額|氏名|備考|
| ---- | ---- | ---- | ---- | ---- | ---- | ---- |
|令和７年10月28日|鉄道（博多～薬院 往復）||420|10,000|福岡太郎||
|令和７年10月30日|鉄道（博多～薬院、薬院～大橋 往復）||420|9,140|福岡太郎||
|令和７年10月31日|バス（駅前一丁目～六本松 往復）||720|8,420|博多次郎||
|令和７年10月31日|役務費によりチャージ|10,000||18,420|||
|令和７年10月31日|鉄道（祇園～福岡空港 往復）、バス（福岡空港前～席田　往復）||940|17,480|福岡三郎||
|令和７年11月１日|鉄道（祇園～筑前前原 往復）||1,280|16,200|福岡太郎||
|令和７年11月２日|鉄道（祇園～貝塚、貝塚～西鉄香椎 往復）||840|15,360|博多次郎||
|令和７年11月４日|鉄道（祇園～福岡空港、羽田第一ターミナル～モノレール浜松町、浜松町～東京||957|14,403|福岡太郎||
|令和７年11月５日|鉄道（東京～浜松町、モノレール浜松町～羽田第一ターミナル、福岡空港～祇園）||957|13,446|福岡太郎||

※１　１行目の10/28 博多～薬院が往復となっているのは、履歴が20件しか保存されないのでここには記載されていないが、これは、博多→薬院の帰りであり、実際には往復しているからである。

※２ ３行目のバス利用の摘要欄については、ユーザーが手入力したものである。

※３　５行目の鉄道利用とバス利用の混在の場合、摘要欄はいったんは鉄道の乗降についてのみ記載し、後からユーザーがバス利用分を手入力する。

※４　７行目は、福岡市地下鉄と西鉄貝塚線との２ラッチ接続による利用である。乗り継ぎ割引が適用されるため、このように、行きと帰りとで同一区間でも金額が異なる場合がある。

### データ入出力機能

ボタンバーの「データ入出力」ボタン（F4）をクリックすると、データ入出力ダイアログが開きます。

#### CSVエクスポート

以下のデータをCSV形式でエクスポートできます。

1. 交通系ICカード一覧
1. 職員一覧
1. 利用履歴

##### 利用履歴CSVフォーマット

```
日時,カードIDm,管理番号,摘要,受入金額,払出金額,残額,利用者,備考
```

- **日時**: yyyy-MM-dd HH:mm:ss形式（時刻情報を含む）
- **カードIDm**: ICカードのIDm（16進数16文字）
- **管理番号**: カードの管理番号（ユーザーが識別しやすい番号）
- **摘要**: 利用内容（鉄道、バス、チャージなど）
- **受入金額**: チャージ額（空欄可）
- **払出金額**: 利用額（空欄可）
- **残額**: 取引後の残額
- **利用者**: 利用者氏名
- **備考**: 備考欄

#### CSVインポート

以下のデータをCSV形式でインポートできます。

1. 交通系ICカード一覧
1. 職員一覧
1. 利用履歴

※インポート時は既存データとの整合性チェックを行い、重複するIDmのデータがある場合は警告を表示します。
※利用履歴のインポート時、管理番号は参照用です。実際のデータ識別はカードIDmで行います。

### 起動時処理機能

起動時に、バス停名未入力の警告やデータのバックアップなどを行います。

#### バス停名未入力の警告

履歴の中にバス停名未入力のものがあれば、警告メッセージを表示します。

#### 残額が一定額未満であることの警告

管理している交通系ICカードの中に、残額が一定額未満であるものがあれば、警告メッセージを表示します。

#### 古いデータの削除

登録から６年間経過したデータは自動で削除します。

#### データのバックアップ

DBデータのバックアップを指定したフォルダに保存します。
バックアップは30世代まで保存することとし、それ以上前のものは削除します。

#### 月次パフォーマンス最適化

毎月10日以降の最初の起動時に、DBのVACUUM処理を行いパフォーマンスの最適化を図ります。

### システム管理機能

ボタンバーの「システム管理」ボタン（F6）をクリックすると、システム管理ダイアログが開きます。

操作ログの確認、データベースの手動バックアップとリストア（データ復元）を行うことができます。

#### 操作ログ

すべての手動操作（登録／修正／削除）の履歴を検索・確認できます。

1. 操作日時による期間指定検索
1. 操作者（職員）による絞り込み
1. 操作種別（登録／修正／削除）による絞り込み
1. 操作対象（職員証／交通系ICカード／利用履歴）による絞り込み

各操作ログには、操作日時、操作者、操作種別、操作対象、操作前の内容、操作後の内容が記録されています。

#### 手動バックアップ

1. 任意のタイミングでデータベースのバックアップを作成できます
1. バックアップファイルの保存先を選択できます
1. ファイル名には自動で日時が付与されます

#### バックアップ一覧

1. 保存されているバックアップファイルの一覧を表示します
1. ファイル名、作成日時、ファイルサイズを確認できます

#### リストア（データ復元）

1. バックアップ一覧から選択、または任意のファイルを指定してリストアできます
1. リストア実行前に確認ダイアログが表示されます
1. リストア前に現在のデータベースは自動でバックアップされます
1. リストア完了後はアプリケーションの再起動が必要です
1. リストア前バックアップは設定で指定されたバックアップフォルダに保存されます
1. リストア前バックアップが失敗した場合は警告が表示され、続行するか選択できます

※リストア操作はDBファイル自体を置き換えるため、操作ログには記録されません。
※自動バックアップ（起動時に30世代まで保存）は引き続き「設定」で指定したフォルダに保存されます。

### 設定

ボタンバーの「設定」ボタン（F5）をクリックすると、設定ダイアログが開きます。
以下の情報を設定できます。

1. 残額が指定金額未満である場合に警告メッセージを表示する金額
1. DBデータのバックアップ先
1. 文字の大きさ（小、中、大、特大）
1. 音声タイプ（男性音声、女性音声、ビープ音から選択）
1. トースト通知の表示位置（画面の左上、右上、左下、右下から選択）

※交通系ICカードの登録や職員証の登録は、それぞれ独立したダイアログ（「交通系ICカード管理」F3、「職員管理」F2）で行います。



## テスト／検証

以下の場合についてテストを行う。

### 正常貸し出し

登録済みの職員証のタッチから登録済みの交通系ICカードのタッチという、正常なパターン

### 未登録カードがあった場合

#### 職員証が未登録であった場合

未登録の職員証がタッチされた場合

#### 交通系ICカードが未登録であった場合

未登録の交通系ICカードがタッチされた場合

### 手順がおかしい場合

#### 職員証をタッチする前に交通系ICカードをタッチした場合

職員証をタッチする前に交通系ICカードをタッチした場合に、正しいメッセージを表示し、正しい手順に戻せるかどうか。

#### 同じ職員証を2回連続してタッチした場合

同じ職員証を2回連続してタッチした場合、正しいメッセージを表示し、正しい手順に戻せるかどうか。

#### 異なる職員証を続けてタッチした場合

異なる職員証を続けてタッチした場合に、正しいメッセージを表示し、正しい手順に戻せるかどうか。

#### 30秒以内に同じ交通系ICカードをタッチした場合

##### 貸出処理のとき

期待したとおり、返却処理に移行するか。

##### 返却処理のとき

期待したとおり、貸出処理に移行するか。

### カードの読み取りが失敗した場合

職員証や交通系ICカードの読み取りが失敗した場合に、正しいメッセージを表示し、正しい手順に戻せるかどうか。

### 乗降区間

#### A駅→B駅というシンプルな場合

「鉄道（A駅～B駅）」という適切な乗降区間表示となるか。

#### A駅→B駅、B駅→A駅というA駅とB駅の往復の場合

「鉄道（A駅～B駅　往復）」という適切な乗降区間表示となるか。

#### A駅→B駅、B駅→C駅という三駅間での移動の場合

「鉄道（A駅～C駅）」という適切な乗降区間表示となるか。

#### A駅→B駅、C駅→D駅という三駅間での移動の場合

「鉄道（A駅～B駅、C駅～D駅）」という適切な乗降区間表示となるか。

#### A駅→B駅、C駅→D駅、E駅→F駅という六駅間での移動の場合

「鉄道（A駅～B駅、C駅～D駅、E駅～F駅）」という適切な乗降区間表示となるか。

#### A駅→B駅、C駅→D駅、D駅→E駅という五駅間での移動の場合

「鉄道（A駅～B駅、C駅～E駅）」という適切な乗降区間表示となるか。

### 鉄道の利用とバスの利用とが混在する場合

「鉄道（A駅～B駅）、バス（★）」という適切な乗降区間表示となるか。

### 月を跨いで貸出／返却が行われた場合

月を跨いで貸出／返却が行われた場合にも、貸出日や返却日にかかわらず、実際の利用日に応じて、適切な月次帳票の記載となるか。

### 年度末処理

年度末の処理が期待したとおりに行われるか。

### 年度初め処理

年度初めの処理が期待したとおりに行われるか。

### 何年も利用して、履歴が数千件も溜まった場合のパフォーマンス

応答時間が２秒以内に収まるか。
