# シーケンス図

## 1. 貸出処理シーケンス

```
┌────────┐  ┌──────────┐  ┌─────────────┐  ┌─────────────┐  ┌──────────┐  ┌────────────┐
│ 職員   │  │CardReader│  │MainViewModel│  │LendingServ │  │CardRepo  │  │LedgerRepo  │
└───┬────┘  └────┬─────┘  └──────┬──────┘  └──────┬──────┘  └────┬─────┘  └─────┬──────┘
    │            │               │               │               │              │
    │ 職員証タッチ│               │               │               │              │
    │───────────▶│               │               │               │              │
    │            │OnCardDetected │               │               │              │
    │            │──────────────▶│               │               │              │
    │            │               │               │               │              │
    │            │               │ GetByIdm(idm) │               │              │
    │            │               │──────────────────────────────▶│              │
    │            │               │◀──────────────────────────────│              │
    │            │               │    Staff                      │              │
    │            │               │               │               │              │
    │            │               │ CurrentState = WaitingForIcCard               │
    │            │               │ StatusMessage = "交通系ICカードをかざして..."  │
    │            │               │               │               │              │
    │ ICカードタッチ              │               │               │              │
    │───────────▶│               │               │               │              │
    │            │OnCardDetected │               │               │              │
    │            │──────────────▶│               │               │              │
    │            │               │               │               │              │
    │            │               │ GetByIdm(idm) │               │              │
    │            │               │───────────────────────────────▶              │
    │            │               │◀───────────────────────────────              │
    │            │               │    IcCard (is_lent=false)     │              │
    │            │               │               │               │              │
    │            │               │ProcessLending │               │              │
    │            │               │──────────────▶│               │              │
    │            │               │               │               │              │
    │            │               │               │ Update(card)  │              │
    │            │               │               │ is_lent=true  │              │
    │            │               │               │──────────────▶│              │
    │            │               │               │◀──────────────│              │
    │            │               │               │               │              │
    │            │               │               │ Add(ledger)   │              │
    │            │               │               │ summary="(貸出中)"           │
    │            │               │               │──────────────────────────────▶
    │            │               │               │◀──────────────────────────────
    │            │               │               │               │              │
    │            │               │◀──────────────│               │              │
    │            │               │   Success     │               │              │
    │            │               │               │               │              │
    │            │               │ PlayBeepShort()               │              │
    │            │               │ ShowNotification("いってらっしゃい!", 緑, 2秒)  │
    │            │               │               │               │              │
    │  画面表示  │               │               │               │              │
    │◀───────────────────────────│               │               │              │
    │            │               │               │               │              │
```

## 2. 返却処理シーケンス

```
┌────────┐  ┌──────────┐  ┌─────────────┐  ┌─────────────┐  ┌──────────┐  ┌────────────┐
│ 職員   │  │CardReader│  │MainViewModel│  │LendingServ │  │CardRepo  │  │LedgerRepo  │
└───┬────┘  └────┬─────┘  └──────┬──────┘  └──────┬──────┘  └────┬─────┘  └─────┬──────┘
    │            │               │               │               │              │
    │ 職員証タッチ│               │               │               │              │
    │───────────▶│               │               │               │              │
    │            │OnCardDetected │               │               │              │
    │            │──────────────▶│               │               │              │
    │            │               │ (職員証認識処理、省略)         │              │
    │            │               │               │               │              │
    │ ICカードタッチ              │               │               │              │
    │───────────▶│               │               │               │              │
    │            │OnCardDetected │               │               │              │
    │            │──────────────▶│               │               │              │
    │            │               │               │               │              │
    │            │               │ GetByIdm(idm) │               │              │
    │            │               │───────────────────────────────▶              │
    │            │               │◀───────────────────────────────              │
    │            │               │    IcCard (is_lent=true)      │              │
    │            │               │               │               │              │
    │            │               │ProcessReturn  │               │               │
    │            │               │──────────────▶│               │              │
    │            │               │               │               │              │
    │            │               │               │ ReadHistory() │              │
    │            │               │               │──────────────▶│              │
    │            │               │               │◀──────────────│              │
    │            │               │               │ List<History> │              │
    │            │               │               │               │              │
    │            │               │               │GetLentRecord  │              │
    │            │               │               │──────────────────────────────▶
    │            │               │               │◀──────────────────────────────
    │            │               │               │    Ledger     │              │
    │            │               │               │               │              │
    │            │               │               │────────────────────────────┐ │
    │            │               │               │ 履歴を日付ごとにグループ化 │ │
    │            │               │               │ 摘要文字列生成             │ │
    │            │               │               │◀───────────────────────────┘ │
    │            │               │               │               │              │
    │            │               │               │ Add(ledger) x N              │
    │            │               │               │──────────────────────────────▶
    │            │               │               │◀──────────────────────────────
    │            │               │               │               │              │
    │            │               │               │ Update(card)  │              │
    │            │               │               │ is_lent=false │              │
    │            │               │               │──────────────▶│              │
    │            │               │               │◀──────────────│              │
    │            │               │               │               │              │
    │            │               │◀──────────────│               │              │
    │            │               │ (hasBus, result)              │              │
    │            │               │               │               │              │
    │            │               │ PlayBeepDouble()              │              │
    │            │               │ ShowNotification("おかえりなさい!", 水色, 2秒) │
    │            │               │               │               │              │
    │  画面表示  │               │               │               │              │
    │◀───────────────────────────│               │               │              │
    │            │               │               │               │              │
    │            │               │ [hasBus = true]               │              │
    │            │               │ ShowBusStopDialog()           │              │
    │            │               │               │               │              │
    │ バス停入力 │               │               │               │              │
    │───────────────────────────▶│               │               │              │
    │            │               │               │               │              │
```

## 3. 履歴表示シーケンス

```
┌────────┐  ┌──────────┐  ┌─────────────┐  ┌──────────┐  ┌────────────┐
│ 職員   │  │CardReader│  │MainViewModel│  │CardRepo  │  │LedgerRepo  │
└───┬────┘  └────┬─────┘  └──────┬──────┘  └────┬─────┘  └─────┬──────┘
    │            │               │               │              │
    │ ICカードタッチ (職員証なし) │               │              │
    │───────────▶│               │               │              │
    │            │OnCardDetected │               │              │
    │            │──────────────▶│               │              │
    │            │               │               │              │
    │            │               │ CurrentState = WaitingForStaffCard           │
    │            │               │ (職員証待ち状態)              │              │
    │            │               │               │              │
    │            │               │ GetByIdm(idm) │              │
    │            │               │──────────────▶│              │
    │            │               │◀──────────────│              │
    │            │               │    IcCard     │              │
    │            │               │               │              │
    │            │               │ GetByCardIdm(idm, page=1, size=100)          │
    │            │               │──────────────────────────────▶│
    │            │               │◀──────────────────────────────│
    │            │               │    List<Ledger>              │
    │            │               │               │              │
    │            │               │ OpenHistoryView(card, ledgers)│
    │            │               │               │              │
    │  履歴表示  │               │               │              │
    │◀───────────────────────────│               │              │
    │            │               │               │              │
```

## 4. 履歴修正シーケンス

```
┌────────┐  ┌─────────────┐  ┌────────────────┐  ┌─────────────┐  ┌────────────┐
│ 職員   │  │HistoryView │  │HistoryViewModel│  │OperationLog│  │LedgerRepo  │
└───┬────┘  └──────┬──────┘  └───────┬────────┘  └──────┬──────┘  └─────┬──────┘
    │              │                 │                  │               │
    │ 修正ボタン   │                 │                  │               │
    │─────────────▶│                 │                  │               │
    │              │ EditCommand     │                  │               │
    │              │────────────────▶│                  │               │
    │              │                 │                  │               │
    │              │ ShowStaffCardDialog               │               │
    │              │◀────────────────│                  │               │
    │              │                 │                  │               │
    │ 職員証タッチ │                 │                  │               │
    │─────────────▶│                 │                  │               │
    │              │────────────────▶│                  │               │
    │              │                 │ IsEditing = true │               │
    │              │                 │                  │               │
    │◀─────────────│ 編集モード表示  │                  │               │
    │              │                 │                  │               │
    │ 内容修正     │                 │                  │               │
    │─────────────▶│                 │                  │               │
    │              │────────────────▶│                  │               │
    │              │                 │ (値をバインド)   │               │
    │              │                 │                  │               │
    │ 完了ボタン   │                 │                  │               │
    │─────────────▶│                 │                  │               │
    │              │ SaveEditCommand │                  │               │
    │              │────────────────▶│                  │               │
    │              │                 │                  │               │
    │              │                 │ Log(...)         │               │
    │              │                 │─────────────────▶│               │
    │              │                 │◀─────────────────│               │
    │              │                 │                  │               │
    │              │                 │ Update(ledger)   │               │
    │              │                 │─────────────────────────────────▶│
    │              │                 │◀─────────────────────────────────│
    │              │                 │                  │               │
    │              │                 │ IsEditing = false│               │
    │              │◀────────────────│                  │               │
    │◀─────────────│ 通常表示に戻る  │                  │               │
    │              │                 │                  │               │
```

## 5. 月次帳票作成シーケンス

```
┌────────┐  ┌────────────┐  ┌───────────────┐  ┌─────────────┐  ┌────────────┐
│ 職員   │  │ReportDialog│  │ReportViewModel│  │ReportService│  │LedgerRepo  │
└───┬────┘  └─────┬──────┘  └───────┬───────┘  └──────┬──────┘  └─────┬──────┘
    │             │                 │                 │               │
    │ 月選択      │                 │                 │               │
    │────────────▶│                 │                 │               │
    │             │────────────────▶│                 │               │
    │             │                 │ SelectedMonth   │               │
    │             │                 │                 │               │
    │ カード選択  │                 │                 │               │
    │────────────▶│                 │                 │               │
    │             │────────────────▶│                 │               │
    │             │                 │ SelectedCards   │               │
    │             │                 │                 │               │
    │ Excel作成   │                 │                 │               │
    │────────────▶│                 │                 │               │
    │             │ GenerateCommand │                 │               │
    │             │────────────────▶│                 │               │
    │             │                 │                 │               │
    │             │                 │GenerateMonthly  │               │
    │             │                 │Report(...)      │               │
    │             │                 │────────────────▶│               │
    │             │                 │                 │               │
    │             │                 │                 │GetByDateRange│
    │             │                 │                 │──────────────▶│
    │             │                 │                 │◀──────────────│
    │             │                 │                 │ List<Ledger> │
    │             │                 │                 │               │
    │             │                 │                 │───────────┐   │
    │             │                 │                 │ テンプレート読込│
    │             │                 │                 │ データ出力  │   │
    │             │                 │                 │ 月末行追加  │   │
    │             │                 │                 │ (年度末処理)│   │
    │             │                 │                 │◀──────────┘   │
    │             │                 │                 │               │
    │             │                 │                 │ Excelファイル保存│
    │             │                 │                 │               │
    │             │                 │◀────────────────│               │
    │             │                 │   filePath      │               │
    │             │                 │                 │               │
    │             │                 │ Process.Start(filePath)        │
    │             │                 │ (Excelを開く)   │               │
    │             │                 │                 │               │
    │             │◀────────────────│                 │               │
    │◀────────────│ ダイアログを閉じる│               │               │
    │             │                 │                 │               │
```

## 6. 起動時処理シーケンス

```
┌─────┐  ┌─────────────┐  ┌─────────────┐  ┌────────────┐  ┌──────────┐  ┌──────────┐
│ App │  │MainViewModel│  │BackupService│  │LedgerRepo  │  │CardRepo  │  │DbContext │
└──┬──┘  └──────┬──────┘  └──────┬──────┘  └─────┬──────┘  └────┬─────┘  └────┬─────┘
   │            │               │               │              │             │
   │ Initialize │               │               │              │             │
   │───────────▶│               │               │              │             │
   │            │               │               │              │             │
   │            │ CreateBackup  │               │              │             │
   │            │──────────────▶│               │              │             │
   │            │               │ (DBファイルコピー)            │             │
   │            │               │ CleanOldBackups(30)          │             │
   │            │◀──────────────│               │              │             │
   │            │               │               │              │             │
   │            │ DeleteOlderThan(6年前)        │              │             │
   │            │──────────────────────────────▶│              │             │
   │            │◀──────────────────────────────│              │             │
   │            │               │               │              │             │
   │            │ CheckVacuumNeeded             │              │             │
   │            │ (10日以降 && 今月未実施)       │              │             │
   │            │──────────────────────────────────────────────────────────▶│
   │            │               │               │              │   Vacuum() │
   │            │◀──────────────────────────────────────────────────────────│
   │            │               │               │              │             │
   │            │GetUnfilledBusStops            │              │             │
   │            │──────────────────────────────▶│              │             │
   │            │◀──────────────────────────────│              │             │
   │            │    List<Ledger>               │              │             │
   │            │               │               │              │             │
   │            │GetLowBalanceCards(threshold)  │              │             │
   │            │──────────────────────────────────────────────▶             │
   │            │◀──────────────────────────────────────────────             │
   │            │    List<IcCard>               │              │             │
   │            │               │               │              │             │
   │            │ Warnings.Add(...)             │              │             │
   │            │ (警告メッセージ設定)           │              │             │
   │            │               │              │              │             │
   │◀───────────│               │               │              │             │
   │ 初期化完了 │               │               │              │             │
   │            │               │               │              │             │
```

## 7. 未登録カード検出シーケンス

```
┌────────┐  ┌──────────┐  ┌─────────────┐  ┌──────────────────┐  ┌──────────┐
│ 職員   │  │CardReader│  │MainViewModel│  │UnknownCardDialog│  │Repo      │
└───┬────┘  └────┬─────┘  └──────┬──────┘  └────────┬─────────┘  └────┬─────┘
    │            │               │                  │                 │
    │ 未登録カード│               │                  │                 │
    │───────────▶│               │                  │                 │
    │            │OnCardDetected │                  │                 │
    │            │──────────────▶│                  │                 │
    │            │               │                  │                 │
    │            │               │ StaffRepo.Exists(idm)              │
    │            │               │────────────────────────────────────▶
    │            │               │◀────────────────────────────────────
    │            │               │     false        │                 │
    │            │               │                  │                 │
    │            │               │ CardRepo.Exists(idm)               │
    │            │               │────────────────────────────────────▶
    │            │               │◀────────────────────────────────────
    │            │               │     false        │                 │
    │            │               │                  │                 │
    │            │               │ PlayBeepError()  │                 │
    │            │               │                  │                 │
    │            │               │ ShowUnknownCardDialog(idm)         │
    │            │               │─────────────────▶│                 │
    │            │               │                  │                 │
    │◀──────────────────────────────────────────────│                 │
    │    「このカードは登録されていません」          │                 │
    │    [職員証として登録] [ICカードとして登録] [キャンセル]         │
    │            │               │                  │                 │
    │ 選択       │               │                  │                 │
    │───────────────────────────────────────────────▶                 │
    │            │               │                  │                 │
    │            │               │◀─────────────────│                 │
    │            │               │ (選択結果)       │                 │
    │            │               │                  │                 │
    │            │               │ [職員証として登録の場合]           │
    │            │               │ OpenStaffManageView(idm)           │
    │            │               │                  │                 │
    │            │               │ [ICカードとして登録の場合]         │
    │            │               │ OpenCardManageView(idm)            │
    │            │               │                  │                 │
```

## 8. 30秒ルール（貸出→返却連続）シーケンス

```
┌────────┐  ┌─────────────┐  ┌─────────────┐  ┌──────────┐
│ 職員   │  │MainViewModel│  │LendingServ │  │ Timer    │
└───┬────┘  └──────┬──────┘  └──────┬──────┘  └────┬─────┘
    │              │               │               │
    │ 職員証→ICカード (貸出処理)   │               │
    │─────────────▶│               │               │
    │              │ProcessLending │               │
    │              │──────────────▶│               │
    │              │◀──────────────│               │
    │              │               │               │
    │              │ "いってらっしゃい!" 表示       │
    │              │ LastTouchCardIdm = cardIdm    │
    │              │ LastTouchTime = now           │
    │              │               │               │
    │              │ StartTimer(30秒)              │
    │              │──────────────────────────────▶│
    │              │               │               │
    │ 同じICカード │               │               │
    │ (30秒以内)   │               │               │
    │─────────────▶│               │               │
    │              │               │               │
    │              │ CheckSameCardWithin30Sec()    │
    │              │ → true        │               │
    │              │               │               │
    │              │ StopTimer()   │               │
    │              │──────────────────────────────▶│
    │              │               │               │
    │              │ProcessReturn  │               │
    │              │──────────────▶│               │
    │              │◀──────────────│               │
    │              │               │               │
    │              │ "おかえりなさい!" 表示        │
    │              │               │               │
    │              │ LastTouchCardIdm = null       │
    │              │               │               │
```
