# システム概要設計書

## 1. システム概要

### 1.1 システム名
交通系ICカード出納管理システム

### 1.2 目的
複数の交通系ICカード（A枚：1〜5枚程度）を複数の職員（B人：5〜30人程度）でシェア利用する際の出納記録を管理し、月次帳票（物品出納簿）の作成を支援する。

### 1.3 現状の課題
- Excelへの手入力による記録管理は手間がかかる
- 入力漏れや入力ミスが発生しやすい
- 交通系ICカードの履歴（最大20件）の確認が煩雑

### 1.4 システム化による解決
- ICカードリーダーによる自動読み取り
- 貸出・返却処理の簡略化（職員証タッチ → ICカードタッチ）
- 履歴データの自動取得・記録
- 月次帳票の自動生成

## 2. システム構成

### 2.1 ハードウェア構成

```
┌─────────────────────────────────────────┐
│           Windows 11 PC                 │
│  ┌─────────────────────────────────┐   │
│  │   交通系ICカード出納管理システム    │   │
│  │         (.NET 8 WPF)             │   │
│  └──────────────┬──────────────────┘   │
│                 │                       │
│  ┌──────────────▼──────────────────┐   │
│  │         SQLite DB                │   │
│  │    (ローカルファイル)              │   │
│  └─────────────────────────────────┘   │
└─────────────────┬───────────────────────┘
                  │ USB
        ┌─────────▼─────────┐
        │   PaSoRi          │
        │ (ICカードリーダー)   │
        └───────────────────┘
```

### 2.2 ソフトウェア構成

| 項目 | 技術・製品 |
|------|-----------|
| 開発言語 | C# 12 |
| フレームワーク | .NET 8 + WPF |
| データベース | SQLite 3 |
| ICカード通信 | PC/SC API (winscard.dll) |
| 帳票出力 | ClosedXML |
| アーキテクチャ | MVVM |

### 2.3 動作環境

| 項目 | 要件 |
|------|------|
| OS | Windows 11 |
| .NET | .NET 8 Runtime（自己完結型ビルドの場合不要） |
| ICカードリーダー | PaSoRi (RC-S380等) |
| ディスプレイ | 1280x720以上推奨 |
| ネットワーク | 不要（オフライン動作） |

## 3. システム機能一覧

### 3.1 主要機能

| No | 機能名 | 概要 |
|----|--------|------|
| F01 | 貸出処理 | 職員証＋ICカードタッチで貸出記録 |
| F02 | 返却処理 | 職員証＋ICカードタッチで返却記録・履歴取得 |
| F03 | 履歴表示 | ICカードタッチで履歴一覧表示 |
| F04 | 履歴修正 | バス停名入力、記録内容の修正 |
| F05 | 月次帳票作成 | 物品出納簿のExcel出力 |
| F06 | 交通系ICカード管理 | カードの登録・修正・削除 |
| F07 | 職員証管理 | 職員証の登録・修正・削除 |
| F08 | 設定 | 警告金額、バックアップ先等の設定 |

### 3.2 補助機能

| No | 機能名 | 概要 |
|----|--------|------|
| F09 | 起動時チェック | バス停名未入力警告、残額警告 |
| F10 | 自動バックアップ | 起動時にDBをバックアップ（30世代） |
| F11 | 古いデータ削除 | 6年経過データの自動削除 |
| F12 | DB最適化 | 毎月10日以降の初回起動時にVACUUM |
| F13 | 操作ログ記録 | 全ての登録・修正・削除操作を記録 |

## 4. 外部インターフェース

### 4.1 入力インターフェース

| No | 種別 | 内容 |
|----|------|------|
| I01 | ICカードリーダー | 職員証・交通系ICカードのIDm、履歴データ |
| I02 | キーボード | バス停名、設定値等の入力 |
| I03 | マウス | メニュー操作、ボタン操作 |

### 4.2 出力インターフェース

| No | 種別 | 内容 |
|----|------|------|
| O01 | 画面表示 | 各種画面、メッセージ |
| O02 | 音声出力 | 操作音（ピッ、ピピッ、ピー） |
| O03 | Excelファイル | 月次帳票（物品出納簿） |

## 5. データフロー概要

```
┌──────────┐    IDm     ┌──────────────┐
│ 職員証    │ ─────────▶│              │
└──────────┘            │              │
                        │   アプリ      │     ┌──────────┐
┌──────────┐  IDm/履歴  │   ケーション   │────▶│ SQLite   │
│ 交通系    │ ─────────▶│              │     │ DB       │
│ ICカード  │            │              │     └──────────┘
└──────────┘            └──────┬───────┘
                               │
                               ▼
                        ┌──────────────┐
                        │ 月次帳票      │
                        │ (Excel)      │
                        └──────────────┘
```

## 6. セキュリティ設計

### 6.1 認証方式
- 職員証（FeliCa）の所持による本人確認
- パスワード認証は行わない（利便性とのバランス）

### 6.2 アクセス制御
- DB変更を伴う全操作に職員証タッチを要求
- 操作ログによる事後追跡を可能にする

### 6.3 データ保護
- 職員氏名・職員番号・IDmは機密情報として扱わない
- バックアップによるデータ保全（30世代）

## 7. 非機能要件

### 7.1 性能要件
| 項目 | 要件 |
|------|------|
| 応答時間 | 全操作2秒以内 |
| データ量 | 最大数千件（5年度分） |

### 7.2 可用性
| 項目 | 要件 |
|------|------|
| 稼働時間 | 業務時間中 |
| バックアップ | 起動時自動（30世代保持） |
| 復旧 | バックアップからの手動復旧 |

### 7.3 アクセシビリティ
| 項目 | 要件 |
|------|------|
| 文字サイズ | 4段階で変更可能（小/中/大/特大） |
| 色覚対応 | 色だけでなくテキストでも情報伝達 |
| 聴覚対応 | 音だけでなく視覚でも情報伝達 |

## 8. 制約事項

1. インターネット非接続環境で動作すること
2. Microsoft 365 E3のみ例外的に利用可能
3. Windows 11専用（他OSへの移植性は不要）
4. 交通系ICカードの履歴は最大20件まで取得可能
5. バス利用時の乗降区間は手入力が必要
