# 機能設計書

## 1. 機能一覧

| No | 機能ID | 機能名 | 優先度 |
|----|--------|--------|--------|
| 1 | F01 | 貸出処理 | 必須 |
| 2 | F02 | 返却処理 | 必須 |
| 3 | F03 | 履歴表示 | 必須 |
| 4 | F04 | 履歴修正 | 必須 |
| 5 | F05 | 月次帳票作成 | 必須 |
| 6 | F06 | 交通系ICカード管理 | 必須 |
| 7 | F07 | 職員証管理 | 必須 |
| 8 | F08 | 設定 | 必須 |
| 9 | F09 | 起動時チェック | 必須 |
| 10 | F10 | 自動バックアップ | 必須 |
| 11 | F11 | 古いデータ削除 | 必須 |
| 12 | F12 | DB最適化 | 任意 |
| 13 | F13 | 操作ログ記録 | 必須 |
| 14 | F14 | カードタッチ待ち受け | 必須 |

---

## 2. 機能詳細

---

### 2.1 F01: 貸出処理

#### 2.1.1 概要
職員証タッチ後に交通系ICカードをタッチすることで、貸出を記録する。

#### 2.1.2 事前条件
- 状態が「交通系ICカードタッチ待ち」であること
- タッチされたカードが登録済みの交通系ICカードであること
- 当該カードの状態が「未貸出」であること

#### 2.1.3 処理フロー

```
開始
  │
  ├─ 1. 現在時刻を貸出時刻として取得
  │
  ├─ 2. ledgerテーブルに新規レコード追加
  │     ├─ card_idm: 読み取ったIDm
  │     ├─ date: 貸出日（YYYY-MM-DD）
  │     ├─ summary: 「（貸出中）」
  │     ├─ income: 0
  │     ├─ expense: 0
  │     ├─ balance: 0
  │     ├─ staff_name: 職員氏名
  │     ├─ lent_at: 貸出日時
  │     └─ is_lent_record: 1
  │
  ├─ 3. ic_cardテーブル更新
  │     ├─ is_lent: 1
  │     ├─ last_lent_at: 貸出日時
  │     └─ last_lent_staff: 職員証IDm
  │
  ├─ 4. 効果音「ピッ」を再生
  │
  ├─ 5. 画面に「🚃→ いってらっしゃい！」を2秒間表示
  │     └─ 背景色: 薄いオレンジ (#FFE0B2)
  │
  ├─ 6. 残額チェック
  │     └─ 警告閾値未満の場合、警告メッセージを表示
  │
  └─ 7. 状態を「職員証タッチ待ち」に戻す
終了
```

#### 2.1.4 エラー処理

| エラー条件 | 処理 |
|------------|------|
| カードが貸出中 | 返却処理へ移行 |
| DB書き込み失敗 | エラー音、エラーメッセージ表示 |

---

### 2.2 F02: 返却処理

#### 2.2.1 概要
職員証タッチ後に貸出中の交通系ICカードをタッチすることで、返却を記録し、履歴を取得する。

#### 2.2.2 事前条件
- 状態が「交通系ICカードタッチ待ち」であること
- タッチされたカードが登録済みの交通系ICカードであること
- 当該カードの状態が「貸出中」であること

#### 2.2.3 処理フロー

```
開始
  │
  ├─ 1. 返却者IDmを記録（タッチされた職員証）
  │
  ├─ 2. 交通系ICカードから履歴を読み込む（最大20件）
  │
  ├─ 3. ledgerテーブルから貸出レコードを検索
  │     └─ card_idm一致、is_lent_record=1のレコード
  │
  ├─ 4. 貸出時刻以降の履歴を処理
  │     │
  │     ├─ 4.1 利用日ごとにグループ化
  │     │
  │     ├─ 4.2 各日の電車・バス利用について
  │     │     ├─ 摘要文字列を生成（往復判定等）
  │     │     ├─ 利用金額を算出
  │     │     └─ ledgerテーブルに新規レコード追加
  │     │
  │     └─ 4.3 各日のチャージについて
  │           ├─ 摘要: 「役務費によりチャージ」
  │           └─ ledgerテーブルに新規レコード追加
  │
  ├─ 5. ledger_detailテーブルに詳細履歴を登録
  │
  ├─ 6. 貸出レコードを削除または更新
  │     └─ is_lent_record: 0, returned_at: 返却日時
  │
  ├─ 7. ic_cardテーブル更新
  │     └─ is_lent: 0
  │
  ├─ 8. 効果音「ピピッ」を再生
  │
  ├─ 9. 画面に「🏠← おかえりなさい！」を2秒間表示
  │     └─ 背景色: 薄い水色 (#B3E5FC)
  │
  ├─ 10. バス利用がある場合
  │      └─ バス停入力画面を表示
  │
  ├─ 11. 残額チェック
  │      └─ 警告閾値未満の場合、警告メッセージを表示
  │
  └─ 12. 状態を「職員証タッチ待ち」に戻す
終了
```

#### 2.2.4 バス利用の判別ロジック

ICカード履歴読み取り時、以下の条件でバス利用を判別:

```
IF entry_station（乗車駅）が空欄 AND
   exit_station（降車駅）が空欄 AND
   is_charge = false（チャージではない）
THEN
   → バス利用と判定（is_bus = true）
```

※鉄道利用の場合は乗車駅・降車駅が記録されるが、バス利用の場合は駅名が記録されないため、この条件で判別可能。

#### 2.2.5 摘要文字列生成ルール

| パターン | 生成例 |
|----------|--------|
| A駅→B駅（1件） | 鉄道（A駅～B駅） |
| A駅→B駅、B駅→A駅（往復） | 鉄道（A駅～B駅 往復） |
| A駅→B駅→C駅、C駅→B駅→A駅 | 鉄道（A駅～C駅 往復） |
| A駅→B駅、B駅→C駅（乗継） | 鉄道（A駅～C駅） |
| A駅→B駅、C駅→D駅（複数区間） | 鉄道（A駅～B駅、C駅～D駅） |
| バス利用あり | 鉄道（A駅～B駅）、バス（★） |
| バスのみ | バス（★） |
| チャージ | 役務費によりチャージ |

#### 2.2.6 30秒ルール

返却処理完了後30秒以内に同じカードがタッチされた場合：
1. バス停入力画面を表示中であれば閉じる
2. 返却処理を完了扱いとする
3. 貸出処理へ移行する

---

### 2.3 F03: 履歴表示

#### 2.3.1 概要
交通系ICカードをタッチ（職員証なし）することで、当該カードの利用履歴を表示する。

#### 2.3.2 処理フロー

```
開始
  │
  ├─ 1. タッチされたカードのIDmを取得
  │
  ├─ 2. ic_cardテーブルからカード情報を取得
  │     └─ card_number（通し番号）
  │
  ├─ 3. ledgerテーブルから履歴を取得
  │     ├─ card_idm一致
  │     ├─ is_lent_record=0（貸出中レコードを除外）
  │     ├─ 日付降順
  │     └─ 100件ずつページング
  │
  ├─ 4. ヘッダ情報を設定
  │     ├─ 物品の分類: 「雑品（金券類）」
  │     ├─ 品名: カード種別（はやかけん等）
  │     ├─ 規格: 通し番号
  │     └─ 単位: 「円」
  │
  └─ 5. 履歴表示画面を表示
終了
```

#### 2.3.3 表示項目

| 項目 | 内容 |
|------|------|
| 出納年月日 | 和暦表示（R7.11.05等） |
| 摘要 | 乗降区間/チャージ/繰越等 |
| 受入金額 | チャージ額 |
| 払出金額 | 利用額 |
| 残額 | その時点の残額 |
| 氏名 | 利用者氏名 |
| 備考 | 備考 |

---

### 2.4 F04: 履歴修正

#### 2.4.1 概要
履歴の内容を修正する。特にバス停名の入力に使用される。

#### 2.4.2 処理フロー

```
開始
  │
  ├─ 1. 「修正」ボタンクリック
  │
  ├─ 2. 職員証タッチを促すダイアログ表示
  │
  ├─ 3. 職員証タッチ → 職員IDmを記録
  │
  ├─ 4. 当該行を編集モードに切り替え
  │     ├─ 背景色を薄い黄色に変更
  │     ├─ 各項目を編集可能に
  │     └─ ボタンを「完了」「キャンセル」に変更
  │
  ├─ 5. ユーザーによる編集を待機
  │
  ├─ 6.1 「完了」ボタンクリック時
  │     ├─ ledgerテーブルを更新
  │     ├─ operation_logに記録
  │     └─ 編集モードを解除
  │
  └─ 6.2 「キャンセル」ボタンクリック時
        └─ 変更を破棄して編集モードを解除
終了
```

---

### 2.5 F05: 月次帳票作成

#### 2.5.1 概要
指定月の物品出納簿をExcel形式で出力する。

#### 2.5.2 処理フロー

```
開始
  │
  ├─ 1. 月次帳票作成画面を表示
  │
  ├─ 2. ユーザーが対象月・対象カードを選択
  │
  ├─ 3. 「Excelファイル作成」ボタンクリック
  │
  ├─ 4. 対象カードごとに以下を実行
  │     │
  │     ├─ 4.1 ledgerテーブルから該当月のデータを取得
  │     │     └─ summary=「（貸出中）」を除外
  │     │
  │     ├─ 4.2 テンプレートファイルを読み込み
  │     │
  │     ├─ 4.3 ヘッダ情報を設定
  │     │     ├─ 物品の分類
  │     │     ├─ 品名
  │     │     ├─ 規格
  │     │     └─ 単位
  │     │
  │     ├─ 4.4 データ行を出力
  │     │     ├─ 4月の場合: 先頭に「前年度より繰越」行
  │     │     ├─ 各履歴行
  │     │     ├─ 月末に「○月計」行
  │     │     └─ 3月の場合: 「累計」行、「次年度へ繰越」行
  │     │
  │     └─ 4.5 ページ番号を設定
  │
  ├─ 5. Excelファイルを保存
  │
  └─ 6. 作成したファイルを開く
終了
```

#### 2.5.3 月末処理

| 項目 | 内容 |
|------|------|
| 出納年月日 | 空欄 |
| 摘要 | 「○月計」 |
| 受入金額 | 当月合計 |
| 払出金額 | 当月合計 |
| 残額 | 月末残額（3月は空欄） |
| 氏名 | 空欄 |
| 備考 | 空欄 |

#### 2.5.4 年度末処理（3月）

**累計行:**
| 項目 | 内容 |
|------|------|
| 摘要 | 「累計」 |
| 受入金額 | 年度合計 |
| 払出金額 | 年度合計 |
| 残額 | 年度末残額 |

**次年度繰越行:**
| 項目 | 内容 |
|------|------|
| 摘要 | 「次年度へ繰越」 |
| 払出金額 | 残額 |
| 残額 | 0 |

#### 2.5.5 年度初め処理（4月）

**前年度繰越行:**
| 項目 | 内容 |
|------|------|
| 出納年月日 | 4月1日 |
| 摘要 | 「前年度より繰越」 |
| 受入金額 | 繰越残額 |
| 残額 | 繰越残額 |

---

### 2.6 F06: 交通系ICカード管理

#### 2.6.1 概要
交通系ICカードの登録・修正・削除を行う。

#### 2.6.2 登録処理フロー

```
開始
  │
  ├─ 1. 職員証タッチを促す → 操作者IDmを記録
  │
  ├─ 2. 交通系ICカードのタッチを促す
  │
  ├─ 3. カードタッチ → IDm・カード種別を取得・表示
  │     └─ カード種別はIDmの発行者コード（先頭2バイト）から自動判別
  │
  ├─ 4. 通し番号・備考の入力を待機
  │     └─ カード種別が自動判別できなかった場合は手動選択
  │
  ├─ 5. 「登録」ボタンクリック
  │
  ├─ 6. ic_cardテーブルに新規レコード追加
  │     └─ card_type: 自動判別または手動選択したカード種別
  │
  ├─ 7. operation_logに記録
  │
  └─ 8. 登録完了メッセージ表示
終了
```

#### 2.6.3 カード種別の自動判別

IDmの発行者コード（先頭2バイト）でカード種別を判別:

| 発行者コード | カード種別 |
|-------------|-----------|
| 01 | Suica |
| 02 | PASMO |
| 03 | ICOCA |
| 04 | PiTaPa |
| 05 | nimoca |
| 06 | SUGOCA |
| 07 | はやかけん |
| 08 | Kitaca |
| 09 | TOICA |
| 0A | manaca |
| その他 | その他（手動選択） |

#### 2.6.4 削除時の注意
- 貸出中のカードは削除不可
- **論理削除を採用**（is_deleted=1, deleted_at=現在日時を設定）
- 削除確認ダイアログを表示
- 削除後も履歴参照時にカード情報は表示される

---

### 2.7 F07: 職員証管理

#### 2.7.1 概要
職員証の登録・修正・削除を行う。

#### 2.7.2 登録処理フロー

```
開始
  │
  ├─ 1. 操作者の職員証タッチを促す
  │     └─ 未登録の場合はその職員証を登録対象とする
  │
  ├─ 2. 登録する職員証のタッチを促す（必要な場合）
  │
  ├─ 3. カードタッチ → IDmを取得・表示
  │
  ├─ 4. 氏名・職員番号・備考の入力を待機
  │
  ├─ 5. 「登録」ボタンクリック
  │
  ├─ 6. staffテーブルに新規レコード追加
  │
  ├─ 7. operation_logに記録
  │
  └─ 8. 登録完了メッセージ表示
終了
```

#### 2.7.3 削除時の注意
- **論理削除を採用**（is_deleted=1, deleted_at=現在日時を設定）
- 削除確認ダイアログを表示
- 削除後も履歴参照時に職員名は正しく表示される（staff_nameにスナップショット保存）

---

### 2.8 F08: 設定

#### 2.8.1 設定項目

| 項目 | 説明 | デフォルト |
|------|------|-----------|
| 残額警告閾値 | この金額未満で警告 | 10,000円 |
| バックアップ先 | バックアップフォルダ | アプリフォルダ/backup |
| 文字サイズ | 小/中/大/特大 | 中 |

---

### 2.9 F09: 起動時チェック

#### 2.9.1 処理フロー

```
開始
  │
  ├─ 1. バス停名未入力チェック
  │     ├─ ledgerテーブルでsummaryに「★」を含むレコードを検索
  │     └─ 該当あれば警告メッセージを表示
  │
  ├─ 2. 残額警告チェック
  │     ├─ ic_cardテーブルとledgerテーブルを結合
  │     ├─ 各カードの最新残額を取得
  │     └─ 警告閾値未満のカードがあれば警告表示
  │
  └─ 3. 警告エリアに結果を表示
終了
```

---

### 2.10 F10: 自動バックアップ

#### 2.10.1 処理フロー

```
開始
  │
  ├─ 1. バックアップ先フォルダの存在確認
  │     └─ なければ作成
  │
  ├─ 2. DBファイルをコピー
  │     └─ ファイル名: backup_YYYYMMDD_HHMMSS.db
  │
  ├─ 3. バックアップファイル数をカウント
  │
  └─ 4. 30世代を超える古いファイルを削除
終了
```

---

### 2.11 F11: 古いデータ削除

#### 2.11.1 処理フロー

```
開始
  │
  ├─ 1. 6年前の日付を算出
  │
  ├─ 2. ledgerテーブルから古いレコードを削除
  │     └─ date < 6年前
  │
  └─ 3. ledger_detailは CASCADE で自動削除
終了
```

---

### 2.12 F12: DB最適化

#### 2.12.1 処理フロー

```
開始
  │
  ├─ 1. 現在日付を取得
  │
  ├─ 2. settingsテーブルからlast_vacuum_dateを取得
  │
  ├─ 3. 条件判定
  │     ├─ 現在日が10日以降
  │     └─ last_vacuum_dateが今月でない
  │
  ├─ 4. 条件を満たす場合
  │     ├─ VACUUM実行
  │     └─ last_vacuum_dateを更新
  │
  └─ 5. 条件を満たさない場合はスキップ
終了
```

---

### 2.13 F13: 操作ログ記録

#### 2.13.1 記録対象

| 操作 | target_table | action |
|------|--------------|--------|
| カード登録 | ic_card | INSERT |
| カード修正 | ic_card | UPDATE |
| カード削除 | ic_card | DELETE |
| 職員証登録 | staff | INSERT |
| 職員証修正 | staff | UPDATE |
| 職員証削除 | staff | DELETE |
| 履歴修正 | ledger | UPDATE |
| 履歴削除 | ledger | DELETE |

#### 2.13.2 記録内容

- 操作日時
- 操作者IDm・氏名
- 対象テーブル・レコードID
- 操作種別
- 操作前データ（JSON）
- 操作後データ（JSON）

---

### 2.14 F14: カードタッチ待ち受け

#### 2.14.1 状態遷移図

```
                    ┌─────────────────┐
         ┌─────────│ 職員証タッチ待ち │◀──────────┐
         │         └────────┬────────┘           │
         │                  │                    │
         │    職員証タッチ  │                    │ 完了/タイムアウト
         │                  ▼                    │
         │         ┌─────────────────┐           │
         │         │ ICカードタッチ待ち│───────────┘
         │         └────────┬────────┘
         │                  │
         │  交通系ICカード   │
         │  タッチ          │
         │                  ▼
         │         ┌─────────────────┐
         │         │    処理中       │
         │         └────────┬────────┘
         │                  │
         └──────────────────┘
```

#### 2.14.2 状態別の動作

| 現在状態 | タッチされたカード | 動作 |
|----------|-------------------|------|
| 職員証待ち | 登録済み職員証 | 状態を「ICカード待ち」に遷移 |
| 職員証待ち | 登録済みICカード | 履歴表示画面を開く |
| 職員証待ち | 未登録カード | 登録確認ダイアログを表示 |
| ICカード待ち | 登録済み職員証 | エラー音、メッセージ表示 |
| ICカード待ち | 登録済みICカード（未貸出） | 貸出処理 |
| ICカード待ち | 登録済みICカード（貸出中） | 返却処理 |
| ICカード待ち | 未登録カード | 登録確認ダイアログを表示 |

#### 2.14.3 タイムアウト

- 職員証タッチ後、60秒間ICカードがタッチされない場合
- エラー音を鳴らし、状態を「職員証タッチ待ち」に戻す

#### 2.14.4 キャンセル

- 「ICカードタッチ待ち」状態でEscキー押下
- 状態を「職員証タッチ待ち」に戻す
