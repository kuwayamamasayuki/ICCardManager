# データベース設計書

## 1. 概要

### 1.1 データベースエンジン
SQLite 3（ファイルベース、ローカル運用）

### 1.2 設計方針
- 第3正規形（3NF）以上を採用
- 日付はTEXT型（ISO 8601形式: YYYY-MM-DD HH:MM:SS）で保存
- 金額はINTEGER型（円単位）で保存
- IDmはTEXT型（16進数16文字）で保存
- 外部キー制約を有効化
- **論理削除を採用**（職員・交通系ICカードは`is_deleted`フラグで管理）

### 1.3 データ保存期間
- 監査対応のため5年度分を保存
- 登録から6年経過したデータは起動時に自動削除

## 2. ER図

```
┌─────────────────────┐       ┌─────────────────────────────┐
│       staff         │       │          ic_card            │
├─────────────────────┤       ├─────────────────────────────┤
│ PK staff_idm        │       │ PK card_idm                 │
│    name             │       │    card_type                │
│    number           │       │    card_number              │
│    note             │       │    note                     │
│    is_deleted       │       │    is_deleted               │
│    deleted_at       │       │    deleted_at               │
└────────┬────────────┘       │    is_lent                  │
         │                    │    last_lent_at             │
         │                    │ FK last_lent_staff          │
         │                    └──────────────┬──────────────┘
         │                                   │
         │    ┌──────────────────────────────┤
         │    │                              │
         ▼    ▼                              ▼
┌─────────────────────────────────────────────────────────────┐
│                        ledger                                │
├─────────────────────────────────────────────────────────────┤
│ PK id                                                        │
│ FK card_idm                                                  │
│ FK lender_idm  (貸出者)                                      │
│    date                                                      │
│    summary                                                   │
│    income                                                    │
│    expense                                                   │
│    balance                                                   │
│    staff_name  (貸出者氏名、スナップショット)                  │
│    note                                                      │
│ FK returner_idm                                              │
│    lent_at                                                   │
│    returned_at                                               │
│    is_lent_record                                            │
└────────────────────────────┬────────────────────────────────┘
                             │ 1:N
                             ▼
┌─────────────────────────────────────────────────────────────┐
│                    ledger_detail                             │
├─────────────────────────────────────────────────────────────┤
│ FK ledger_id                                                 │
│    use_date                                                  │
│    entry_station                                             │
│    exit_station                                              │
│    bus_stops                                                 │
│    amount                                                    │
│    balance                                                   │
│    is_charge                                                 │
│    is_bus                                                    │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                    operation_log                             │
├─────────────────────────────────────────────────────────────┤
│ PK id                                                        │
│    timestamp                                                 │
│ FK operator_idm                                              │
│    operator_name                                             │
│    target_table                                              │
│    target_id                                                 │
│    action                                                    │
│    before_data                                               │
│    after_data                                                │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                       settings                               │
├─────────────────────────────────────────────────────────────┤
│ PK key                                                       │
│    value                                                     │
└─────────────────────────────────────────────────────────────┘
```

## 3. テーブル定義

### 3.1 staff（職員マスタ）

職員証のIDmと職員情報を管理するテーブル。

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|----------|----------|------|------------|------|
| staff_idm | TEXT | NO | - | 職員証IDm（PK、16進数16文字） |
| name | TEXT | NO | - | 職員氏名 |
| number | TEXT | YES | NULL | 職員番号 |
| note | TEXT | YES | NULL | 備考 |
| is_deleted | INTEGER | NO | 0 | 削除フラグ（0:有効、1:削除済） |
| deleted_at | TEXT | YES | NULL | 削除日時 |

```sql
CREATE TABLE staff (
    staff_idm  TEXT PRIMARY KEY,
    name       TEXT NOT NULL,
    number     TEXT,
    note       TEXT,
    is_deleted INTEGER DEFAULT 0,
    deleted_at TEXT
);
```

#### 論理削除時の動作
- 削除時: `is_deleted = 1`、`deleted_at = 現在日時` を設定
- 一覧表示: `is_deleted = 0` のレコードのみ表示
- 履歴参照: `ledger.staff_name`（スナップショット）を使用するため、削除後も正しく表示される
- 同一IDmの再登録: 不可（PKの一意性制約）

### 3.2 ic_card（交通系ICカードマスタ）

交通系ICカードのIDmと管理情報を管理するテーブル。

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|----------|----------|------|------------|------|
| card_idm | TEXT | NO | - | 交通系ICカードIDm（PK） |
| card_type | TEXT | NO | - | カード種別（はやかけん/nimoca/SUGOCA等） |
| card_number | TEXT | NO | - | 通し番号（管理番号） |
| note | TEXT | YES | NULL | 備考 |
| is_deleted | INTEGER | NO | 0 | 削除フラグ（0:有効、1:削除済） |
| deleted_at | TEXT | YES | NULL | 削除日時 |
| is_lent | INTEGER | NO | 0 | 貸出状態（0:未貸出、1:貸出中） |
| last_lent_at | TEXT | YES | NULL | 最終貸出日時 |
| last_lent_staff | TEXT | YES | NULL | 最終貸出者IDm（FK→staff） |

```sql
CREATE TABLE ic_card (
    card_idm        TEXT PRIMARY KEY,
    card_type       TEXT NOT NULL,
    card_number     TEXT NOT NULL,
    note            TEXT,
    is_deleted      INTEGER DEFAULT 0,
    deleted_at      TEXT,
    is_lent         INTEGER DEFAULT 0,
    last_lent_at    TEXT,
    last_lent_staff TEXT REFERENCES staff(staff_idm)
);
```

#### カード種別の自動判別
カード種別はICカードのシステムコード（PMm）から自動判別する:

| システムコード | カード種別 |
|---------------|-----------|
| 0003 | Suica/PASMO/Kitaca/TOICA/manaca/ICOCA/PiTaPa/nimoca/SUGOCA/はやかけん |

※サイバネ規格のシステムコードは共通のため、IDmの発行者コード（先頭2バイト）で判別:

| 発行者コード | カード種別 |
|-------------|-----------|
| 01 | Suica |
| 02 | PASMO |
| 03 | ICOCA |
| 04 | PiTaPa |
| 05 | nimoca |
| 06 | SUGOCA |
| 07 | はやかけん |
| 08 | Kitaca |
| 09 | TOICA |
| 0A | manaca |

※判別できない場合は「その他」として登録し、手動で修正可能とする。

#### 論理削除時の動作
- 削除時: `is_deleted = 1`、`deleted_at = 現在日時` を設定
- 削除条件: `is_lent = 0`（貸出中は削除不可）
- 一覧表示: `is_deleted = 0` のレコードのみ表示
- 履歴参照: `ledger.card_idm` で紐づけ、`ic_card`から`card_number`を取得

### 3.3 ledger（利用履歴概要）

物品出納簿の1行に対応するテーブル。一回の貸し出しあたり複数レコードが作成される（利用日ごと、チャージごと）。

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|----------|----------|------|------------|------|
| id | INTEGER | NO | AUTO | レコードID（PK） |
| card_idm | TEXT | NO | - | 交通系ICカードIDm（FK→ic_card） |
| lender_idm | TEXT | YES | NULL | 貸出者IDm（FK→staff） |
| date | TEXT | NO | - | 出納年月日（YYYY-MM-DD） |
| summary | TEXT | NO | - | 摘要 |
| income | INTEGER | NO | 0 | 受入金額（チャージ額） |
| expense | INTEGER | NO | 0 | 払出金額（利用額） |
| balance | INTEGER | NO | - | 残額 |
| staff_name | TEXT | YES | NULL | 利用者氏名（登録時にスナップショット保存） |
| note | TEXT | YES | NULL | 備考 |
| returner_idm | TEXT | YES | NULL | 返却者IDm（FK→staff） |
| lent_at | TEXT | YES | NULL | 貸出日時 |
| returned_at | TEXT | YES | NULL | 返却日時 |
| is_lent_record | INTEGER | NO | 0 | 貸出中レコードフラグ（1:貸出中） |

```sql
CREATE TABLE ledger (
    id             INTEGER PRIMARY KEY AUTOINCREMENT,
    card_idm       TEXT    NOT NULL REFERENCES ic_card(card_idm),
    lender_idm     TEXT    REFERENCES staff(staff_idm),
    date           TEXT    NOT NULL,
    summary        TEXT    NOT NULL,
    income         INTEGER DEFAULT 0,
    expense        INTEGER DEFAULT 0,
    balance        INTEGER NOT NULL,
    staff_name     TEXT,
    note           TEXT,
    returner_idm   TEXT,
    lent_at        TEXT,
    returned_at    TEXT,
    is_lent_record INTEGER DEFAULT 0
);
```

#### staff_nameのスナップショット方式
- 貸出時に`lender_idm`から職員氏名を取得し、`staff_name`に保存
- 履歴表示時は`staff_name`を直接使用（JOINなし）
- これにより、職員が論理削除された後も履歴の氏名は正しく表示される

### 3.4 ledger_detail（利用履歴詳細）

一回の貸し出しにおける交通系ICカードの個別利用を記録するテーブル。

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|----------|----------|------|------------|------|
| ledger_id | INTEGER | NO | - | 親レコードID（FK→ledger） |
| use_date | TEXT | YES | NULL | 利用日時 |
| entry_station | TEXT | YES | NULL | 乗車駅（空欄の場合はバス利用） |
| exit_station | TEXT | YES | NULL | 降車駅（空欄の場合はバス利用） |
| bus_stops | TEXT | YES | NULL | バス停名（手入力） |
| amount | INTEGER | YES | NULL | 利用額／チャージ額 |
| balance | INTEGER | YES | NULL | 残額 |
| is_charge | INTEGER | NO | 0 | チャージフラグ（1:チャージ） |
| is_bus | INTEGER | NO | 0 | バス利用フラグ（1:バス） |

```sql
CREATE TABLE ledger_detail (
    ledger_id     INTEGER REFERENCES ledger(id) ON DELETE CASCADE,
    use_date      TEXT,
    entry_station TEXT,
    exit_station  TEXT,
    bus_stops     TEXT,
    amount        INTEGER,
    balance       INTEGER,
    is_charge     INTEGER DEFAULT 0,
    is_bus        INTEGER DEFAULT 0
);
```

#### バス利用の判別ロジック
ICカード履歴読み取り時、以下の条件でバス利用を判別:
- `entry_station`（乗車駅）が空欄 **かつ**
- `exit_station`（降車駅）が空欄 **かつ**
- `is_charge = 0`（チャージではない）

→ `is_bus = 1` を設定

### 3.5 operation_log（操作ログ）

全ての手動操作（登録/修正/削除）を記録するテーブル。

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|----------|----------|------|------------|------|
| id | INTEGER | NO | AUTO | ログID（PK） |
| timestamp | TEXT | NO | CURRENT_TIMESTAMP | 操作日時 |
| operator_idm | TEXT | NO | - | 操作者IDm（FK→staff） |
| operator_name | TEXT | NO | - | 操作者氏名（スナップショット） |
| target_table | TEXT | YES | NULL | 操作対象テーブル名 |
| target_id | TEXT | YES | NULL | 操作対象レコードID/IDm |
| action | TEXT | YES | NULL | 操作種別（INSERT/UPDATE/DELETE） |
| before_data | TEXT | YES | NULL | 操作前データ（JSON） |
| after_data | TEXT | YES | NULL | 操作後データ（JSON） |

```sql
CREATE TABLE operation_log (
    id            INTEGER PRIMARY KEY AUTOINCREMENT,
    timestamp     TEXT DEFAULT CURRENT_TIMESTAMP,
    operator_idm  TEXT NOT NULL,
    operator_name TEXT NOT NULL,
    target_table  TEXT,
    target_id     TEXT,
    action        TEXT,
    before_data   TEXT,
    after_data    TEXT
);
```

※`operator_idm`は外部キー制約を設けない（削除された職員の操作ログも保持するため）
※`operator_name`はスナップショット保存

### 3.6 settings（設定）

アプリケーション設定を保存するテーブル。

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|----------|----------|------|------------|------|
| key | TEXT | NO | - | 設定キー（PK） |
| value | TEXT | YES | NULL | 設定値 |

```sql
CREATE TABLE settings (
    key   TEXT PRIMARY KEY,
    value TEXT
);
```

#### 設定項目一覧

| key | 説明 | デフォルト値 |
|-----|------|-------------|
| warning_balance | 残額警告閾値（円） | 10000 |
| backup_path | バックアップ先フォルダ | (アプリフォルダ)/backup |
| font_size | 文字サイズ（small/medium/large/xlarge） | medium |
| last_vacuum_date | 最終VACUUM実行日 | (なし) |

## 4. インデックス定義

```sql
CREATE INDEX idx_staff_deleted      ON staff(is_deleted);
CREATE INDEX idx_card_deleted       ON ic_card(is_deleted);
CREATE INDEX idx_ledger_date        ON ledger(date);
CREATE INDEX idx_ledger_summary     ON ledger(summary);
CREATE INDEX idx_ledger_card_date   ON ledger(card_idm, date);
CREATE INDEX idx_ledger_lender      ON ledger(lender_idm);
CREATE INDEX idx_detail_ledger      ON ledger_detail(ledger_id);
CREATE INDEX idx_detail_bus         ON ledger_detail(is_bus);
CREATE INDEX idx_log_timestamp      ON operation_log(timestamp);
```

## 5. 初期データ

### 5.1 設定テーブル初期データ

```sql
INSERT INTO settings (key, value) VALUES ('warning_balance', '10000');
INSERT INTO settings (key, value) VALUES ('font_size', 'medium');
```

## 6. データ保守

### 6.1 古いデータの自動削除

起動時に以下のSQLを実行し、6年経過したデータを削除する。

```sql
-- 6年前の日付を算出
-- date列がYYYY-MM-DD形式であることを前提

DELETE FROM ledger
WHERE date < date('now', '-6 years');

-- ledger_detailはON DELETE CASCADEにより自動削除
```

**注意**: 職員・交通系ICカードは論理削除のため、6年経過しても自動削除されない。

### 6.2 バックアップ

起動時にDBファイルをバックアップフォルダにコピーする。

- ファイル名形式: `backup_YYYYMMDD_HHMMSS.db`
- 保持世代数: 30
- 30世代を超えた古いバックアップは削除

### 6.3 VACUUM

毎月10日以降の最初の起動時にVACUUMを実行し、DBファイルを最適化する。

```sql
VACUUM;
```

実行後、`settings`テーブルの`last_vacuum_date`を更新する。

## 7. トランザクション方針

- 貸出・返却処理は1トランザクションで実行
- 月次帳票作成は読み取り専用（トランザクション不要）
- 修正・削除は操作ログ記録を含めて1トランザクションで実行
- 論理削除も操作ログ記録を含めて1トランザクションで実行

## 8. 論理削除の方針まとめ

| テーブル | 削除方式 | 理由 |
|----------|----------|------|
| staff | 論理削除 | 履歴参照時に氏名を表示するため |
| ic_card | 論理削除 | 履歴参照時にカード情報を表示するため |
| ledger | 物理削除（6年後自動） | 監査対応の保存期間経過後は不要 |
| ledger_detail | 物理削除（CASCADE） | 親レコードに連動 |
| operation_log | 物理削除しない | 監査証跡として永続保存 |
| settings | 削除しない | 設定値のため |
