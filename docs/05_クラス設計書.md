# クラス設計書

## 1. アーキテクチャ概要

本システムはMVVM（Model-View-ViewModel）パターンを採用する。

```
┌─────────────────────────────────────────────────────────────────┐
│                            View                                  │
│  (XAML + Code-behind)                                           │
│  ├─ MainWindow                                                  │
│  ├─ HistoryView                                                 │
│  ├─ SettingsDialog                                              │
│  └─ ...                                                         │
└──────────────────────────────┬──────────────────────────────────┘
                               │ DataBinding
┌──────────────────────────────▼──────────────────────────────────┐
│                          ViewModel                               │
│  ├─ MainViewModel                                               │
│  ├─ HistoryViewModel                                            │
│  ├─ SettingsViewModel                                           │
│  └─ ...                                                         │
└──────────────────────────────┬──────────────────────────────────┘
                               │
┌──────────────────────────────▼──────────────────────────────────┐
│                           Model                                  │
│  ├─ Services (業務ロジック)                                      │
│  │   ├─ LendingService                                          │
│  │   ├─ ReportService                                           │
│  │   └─ ...                                                     │
│  ├─ Data (データアクセス)                                        │
│  │   ├─ DbContext                                               │
│  │   └─ Repositories                                            │
│  └─ Infrastructure (基盤)                                        │
│      ├─ CardReader                                              │
│      ├─ SoundPlayer                                             │
│      └─ ...                                                     │
└─────────────────────────────────────────────────────────────────┘
```

## 2. 名前空間構成

```
ICCardManager
├── ICCardManager.App                 # アプリケーションエントリポイント
├── ICCardManager.Views              # View (XAML)
├── ICCardManager.ViewModels         # ViewModel
├── ICCardManager.Models             # データモデル（エンティティ）
├── ICCardManager.Services           # ビジネスロジック
├── ICCardManager.Data               # データアクセス層
├── ICCardManager.Infrastructure     # インフラストラクチャ
└── ICCardManager.Common             # 共通ユーティリティ
```

## 3. クラス図

### 3.1 Models（エンティティ）

```
┌─────────────────────────┐
│        Staff            │
├─────────────────────────┤
│ + StaffIdm: string      │
│ + Name: string          │
│ + Number: string?       │
│ + Note: string?         │
│ + IsDeleted: bool       │  ← 論理削除フラグ
│ + DeletedAt: DateTime?  │  ← 削除日時
└─────────────────────────┘

┌─────────────────────────┐
│        IcCard           │
├─────────────────────────┤
│ + CardIdm: string       │
│ + CardType: string      │  ← カード種別（自動判別）
│ + CardNumber: string    │
│ + Note: string?         │
│ + IsDeleted: bool       │  ← 論理削除フラグ
│ + DeletedAt: DateTime?  │  ← 削除日時
│ + IsLent: bool          │
│ + LastLentAt: DateTime? │
│ + LastLentStaff: string?│
└─────────────────────────┘

┌─────────────────────────┐
│        Ledger           │
├─────────────────────────┤
│ + Id: int               │
│ + CardIdm: string       │
│ + LenderIdm: string?    │  ← 貸出者IDm
│ + Date: DateTime        │
│ + Summary: string       │
│ + Income: int           │
│ + Expense: int          │
│ + Balance: int          │
│ + StaffName: string?    │  ← スナップショット保存
│ + Note: string?         │
│ + ReturnerIdm: string?  │
│ + LentAt: DateTime?     │
│ + ReturnedAt: DateTime? │
│ + IsLentRecord: bool    │
├─────────────────────────┤
│ + Details: List<Detail> │
└─────────────────────────┘

┌─────────────────────────┐
│     LedgerDetail        │
├─────────────────────────┤
│ + LedgerId: int         │
│ + UseDate: DateTime?    │
│ + EntryStation: string? │
│ + ExitStation: string?  │
│ + BusStops: string?     │
│ + Amount: int?          │
│ + Balance: int?         │
│ + IsCharge: bool        │
│ + IsBus: bool           │  ← バス利用フラグ
└─────────────────────────┘

┌─────────────────────────┐
│     OperationLog        │
├─────────────────────────┤
│ + Id: int               │
│ + Timestamp: DateTime   │
│ + OperatorIdm: string   │
│ + OperatorName: string  │
│ + TargetTable: string?  │
│ + TargetId: int?        │
│ + Action: string?       │
│ + BeforeData: string?   │
│ + AfterData: string?    │
└─────────────────────────┘

┌─────────────────────────┐
│       AppSettings       │
├─────────────────────────┤
│ + WarningBalance: int   │
│ + BackupPath: string    │
│ + FontSize: FontSize    │
│ + LastVacuumDate: Date? │
└─────────────────────────┘
```

### 3.2 Services（ビジネスロジック）

```
┌─────────────────────────────────────┐
│         ILendingService             │
├─────────────────────────────────────┤
│ + ProcessLending(staffIdm, cardIdm) │
│ + ProcessReturn(staffIdm, cardIdm)  │
│ + GetCardStatus(cardIdm): CardStatus│
└─────────────────────────────────────┘
              △
              │
┌─────────────────────────────────────┐
│         LendingService              │
├─────────────────────────────────────┤
│ - _cardRepository: ICardRepository  │
│ - _ledgerRepository: ILedgerRepo    │
│ - _cardReader: ICardReader          │
│ - _summaryGenerator: SummaryGen     │
├─────────────────────────────────────┤
│ + ProcessLending(...)               │
│ + ProcessReturn(...)                │
│ - ReadCardHistory(): List<History>  │
│ - GenerateLedgerRecords(...)        │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│         IReportService              │
├─────────────────────────────────────┤
│ + GenerateMonthlyReport(year, month,│
│     cardIdms): string               │
└─────────────────────────────────────┘
              △
              │
┌─────────────────────────────────────┐
│         ReportService               │
├─────────────────────────────────────┤
│ - _ledgerRepository: ILedgerRepo    │
│ - _cardRepository: ICardRepository  │
│ - _templatePath: string             │
├─────────────────────────────────────┤
│ + GenerateMonthlyReport(...)        │
│ - CreateHeader(worksheet, card)     │
│ - CreateDataRows(worksheet, data)   │
│ - CreateMonthSummary(worksheet)     │
│ - CreateYearEndRows(worksheet)      │
│ - CreateYearStartRow(worksheet)     │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│       ISummaryGenerator             │
├─────────────────────────────────────┤
│ + Generate(histories): string       │
└─────────────────────────────────────┘
              △
              │
┌─────────────────────────────────────┐
│       SummaryGenerator              │
├─────────────────────────────────────┤
│ + Generate(histories): string       │
│ - DetectRoundTrip(trips): bool      │
│ - MergeConsecutiveTrips(trips)      │
│ - FormatTripString(trips): string   │
│ - DetectBusUsage(history): bool     │  ← バス判別
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│       ICardTypeDetector             │  ← カード種別判別
├─────────────────────────────────────┤
│ + Detect(idm): string               │
└─────────────────────────────────────┘
              △
              │
┌─────────────────────────────────────┐
│       CardTypeDetector              │
├─────────────────────────────────────┤
│ - _issuerCodeMap: Dictionary        │
├─────────────────────────────────────┤
│ + Detect(idm): string               │
│   IDmの先頭2バイトからカード種別を判別
│   01=Suica, 02=PASMO, 03=ICOCA,
│   04=PiTaPa, 05=nimoca, 06=SUGOCA,
│   07=はやかけん, 08=Kitaca,
│   09=TOICA, 0A=manaca, その他=その他
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│         IBackupService              │
├─────────────────────────────────────┤
│ + CreateBackup()                    │
│ + RestoreFromBackup(backupPath)     │
│ + GetBackupList(): List<BackupInfo> │
│ + CleanOldBackups(keepCount)        │
└─────────────────────────────────────┘
              △
              │
┌─────────────────────────────────────┐
│         BackupService               │
├─────────────────────────────────────┤
│ - _dbPath: string                   │
│ - _backupPath: string               │
├─────────────────────────────────────┤
│ + CreateBackup()                    │
│ + RestoreFromBackup(backupPath)     │
│ + GetBackupList(): List<BackupInfo> │
│ + CleanOldBackups(keepCount)        │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│       IOperationLogger              │
├─────────────────────────────────────┤
│ + Log(operatorIdm, table, id,       │
│       action, before, after)        │
└─────────────────────────────────────┘
```

### 3.3 Data（リポジトリ）

```
┌─────────────────────────────────────┐
│         IStaffRepository            │
├─────────────────────────────────────┤
│ + GetByIdm(idm): Staff?             │
│ + GetAll(): List<Staff>             │  ← is_deleted=0のみ
│ + GetAllIncludeDeleted(): List      │  ← 削除済み含む
│ + Add(staff)                        │
│ + Update(staff)                     │
│ + SoftDelete(idm)                   │  ← 論理削除
│ + Exists(idm): bool                 │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│         ICardRepository             │
├─────────────────────────────────────┤
│ + GetByIdm(idm): IcCard?            │
│ + GetAll(): List<IcCard>            │  ← is_deleted=0のみ
│ + GetAllIncludeDeleted(): List      │  ← 削除済み含む
│ + Add(card)                         │
│ + Update(card)                      │
│ + SoftDelete(idm)                   │  ← 論理削除
│ + Exists(idm): bool                 │
│ + GetLowBalanceCards(threshold)     │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│        ILedgerRepository            │
├─────────────────────────────────────┤
│ + GetByCardIdm(cardIdm, page, size) │
│ + GetByDateRange(cardIdm, from, to) │
│ + GetLentRecord(cardIdm): Ledger?   │
│ + Add(ledger)                       │
│ + Update(ledger)                    │
│ + Delete(id)                        │
│ + GetUnfilledBusStops(): List<Led>  │
│ + DeleteOlderThan(date)             │
│ + GetLatestBalance(cardIdm): int    │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│       ISettingsRepository           │
├─────────────────────────────────────┤
│ + Get(key): string?                 │
│ + Set(key, value)                   │
│ + GetAppSettings(): AppSettings     │
│ + SaveAppSettings(settings)         │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│          DbContext                  │
├─────────────────────────────────────┤
│ - _connectionString: string         │
├─────────────────────────────────────┤
│ + GetConnection(): SqliteConnection │
│ + InitializeDatabase()              │
│ + ExecuteInTransaction(action)      │
│ + Vacuum()                          │
└─────────────────────────────────────┘
```

### 3.4 Infrastructure（インフラ）

```
┌─────────────────────────────────────┐
│          ICardReader                │
├─────────────────────────────────────┤
│ + StartPolling()                    │
│ + StopPolling()                     │
│ + ReadHistory(): List<CardHistory>  │
│ + OnCardDetected: event             │
│ + OnCardRemoved: event              │
│ + OnError: event                    │
└─────────────────────────────────────┘
              △
              │
┌─────────────────────────────────────┐
│        PcScCardReader               │
├─────────────────────────────────────┤
│ - _context: SCardContext            │
│ - _reader: SCardReader              │
│ - _pollingTimer: Timer              │
├─────────────────────────────────────┤
│ + StartPolling()                    │
│ + StopPolling()                     │
│ + ReadHistory(): List<CardHistory>  │
│ - SendApdu(command): byte[]         │
│ - ParseHistory(data): CardHistory   │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│        CardHistory                  │
├─────────────────────────────────────┤
│ + UseDate: DateTime                 │
│ + EntryStation: StationInfo?        │
│ + ExitStation: StationInfo?         │
│ + Amount: int                       │
│ + Balance: int                      │
│ + IsCharge: bool                    │
│ + IsBus: bool                       │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│         StationInfo                 │
├─────────────────────────────────────┤
│ + AreaCode: int                     │
│ + LineCode: int                     │
│ + StationCode: int                  │
│ + Name: string                      │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│         ISoundPlayer                │
├─────────────────────────────────────┤
│ + PlayBeepShort()                   │
│ + PlayBeepDouble()                  │
│ + PlayBeepError()                   │
└─────────────────────────────────────┘
              △
              │
┌─────────────────────────────────────┐
│          SoundPlayer                │
├─────────────────────────────────────┤
│ - _beepShortPath: string            │
│ - _beepDoublePath: string           │
│ - _beepErrorPath: string            │
├─────────────────────────────────────┤
│ + PlayBeepShort()                   │
│ + PlayBeepDouble()                  │
│ + PlayBeepError()                   │
└─────────────────────────────────────┘
```

### 3.5 ViewModels

```
┌─────────────────────────────────────┐
│       ViewModelBase                 │
├─────────────────────────────────────┤
│ # OnPropertyChanged(name)           │
│ # SetProperty<T>(ref field, value)  │
└─────────────────────────────────────┘
              △
              │
┌─────────────────────────────────────┐
│        MainViewModel                │
├─────────────────────────────────────┤
│ + CurrentState: AppState            │
│ + StatusMessage: string             │
│ + NotificationMessage: string       │
│ + NotificationBackground: Brush     │
│ + Warnings: ObservableCollection    │
│ + CurrentStaffIdm: string?          │
├─────────────────────────────────────┤
│ + OpenSettingsCommand: ICommand     │
│ + OpenReportCommand: ICommand       │
│ + OpenSystemManageCommand: ICommand │
├─────────────────────────────────────┤
│ - OnCardDetected(idm, type)         │
│ - ProcessLending(cardIdm)           │
│ - ProcessReturn(cardIdm)            │
│ - ShowNotification(msg, color, sec) │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│       HistoryViewModel              │
├─────────────────────────────────────┤
│ + CardInfo: IcCard                  │
│ + Histories: ObservableCollection   │
│ + CurrentPage: int                  │
│ + TotalPages: int                   │
│ + SelectedHistory: Ledger?          │
│ + IsEditing: bool                   │
├─────────────────────────────────────┤
│ + ShowDetailCommand: ICommand       │
│ + EditCommand: ICommand             │
│ + SaveEditCommand: ICommand         │
│ + CancelEditCommand: ICommand       │
│ + NextPageCommand: ICommand         │
│ + PrevPageCommand: ICommand         │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│      SettingsViewModel              │
├─────────────────────────────────────┤
│ + WarningBalance: int               │
│ + BackupPath: string                │
│ + SelectedFontSize: FontSize        │
├─────────────────────────────────────┤
│ + BrowseFolderCommand: ICommand     │
│ + SaveCommand: ICommand             │
│ + CancelCommand: ICommand           │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│       ReportViewModel               │
├─────────────────────────────────────┤
│ + SelectedMonth: MonthOption        │
│ + CustomYear: int                   │
│ + CustomMonth: int                  │
│ + Cards: ObservableCollection       │
│ + SelectedCards: List<IcCard>       │
├─────────────────────────────────────┤
│ + GenerateCommand: ICommand         │
│ + CancelCommand: ICommand           │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│      CardManageViewModel            │
├─────────────────────────────────────┤
│ + Cards: ObservableCollection       │
│ + NewCardIdm: string                │
│ + NewCardNumber: string             │
│ + NewCardNote: string               │
├─────────────────────────────────────┤
│ + RegisterCommand: ICommand         │
│ + EditCommand: ICommand             │
│ + DeleteCommand: ICommand           │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│      StaffManageViewModel           │
├─────────────────────────────────────┤
│ + Staffs: ObservableCollection      │
│ + NewStaffIdm: string               │
│ + NewStaffName: string              │
│ + NewStaffNumber: string            │
│ + NewStaffNote: string              │
├─────────────────────────────────────┤
│ + RegisterCommand: ICommand         │
│ + EditCommand: ICommand             │
│ + DeleteCommand: ICommand           │
└─────────────────────────────────────┘
```

### 3.6 Common（共通）

```
┌─────────────────────────────────────┐
│        WarekiConverter              │
├─────────────────────────────────────┤
│ + ToWareki(date): string            │
│ + FromWareki(wareki): DateTime      │
│ + GetCurrentEra(): string           │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│          AppState                   │
├─────────────────────────────────────┤
│ WaitingForStaffCard                 │
│ WaitingForIcCard                    │
│ Processing                          │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│         CardType                    │
├─────────────────────────────────────┤
│ Staff                               │
│ IcCard                              │
│ Unknown                             │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│         FontSize                    │
├─────────────────────────────────────┤
│ Small                               │
│ Medium                              │
│ Large                               │
│ XLarge                              │
└─────────────────────────────────────┘
```

## 4. 依存性注入構成

```csharp
// Program.cs または App.xaml.cs
services.AddSingleton<DbContext>();
services.AddSingleton<ICardReader, PcScCardReader>();
services.AddSingleton<ISoundPlayer, SoundPlayer>();

services.AddScoped<IStaffRepository, StaffRepository>();
services.AddScoped<ICardRepository, CardRepository>();
services.AddScoped<ILedgerRepository, LedgerRepository>();
services.AddScoped<ISettingsRepository, SettingsRepository>();

services.AddScoped<ILendingService, LendingService>();
services.AddScoped<IReportService, ReportService>();
services.AddScoped<IBackupService, BackupService>();
services.AddScoped<IOperationLogger, OperationLogger>();
services.AddScoped<ISummaryGenerator, SummaryGenerator>();

services.AddTransient<MainViewModel>();
services.AddTransient<HistoryViewModel>();
services.AddTransient<SettingsViewModel>();
services.AddTransient<ReportViewModel>();
services.AddTransient<CardManageViewModel>();
services.AddTransient<StaffManageViewModel>();
```

## 5. プロジェクト構成

```
ICCardManager/
├── ICCardManager.sln
├── src/
│   ├── ICCardManager/
│   │   ├── App.xaml
│   │   ├── App.xaml.cs
│   │   ├── Views/
│   │   │   ├── MainWindow.xaml
│   │   │   ├── HistoryView.xaml
│   │   │   ├── Dialogs/
│   │   │   │   ├── SettingsDialog.xaml
│   │   │   │   ├── ReportDialog.xaml
│   │   │   │   └── ...
│   │   │   └── Controls/
│   │   │       └── NotificationPanel.xaml
│   │   ├── ViewModels/
│   │   │   ├── ViewModelBase.cs
│   │   │   ├── MainViewModel.cs
│   │   │   └── ...
│   │   ├── Models/
│   │   │   ├── Staff.cs
│   │   │   ├── IcCard.cs
│   │   │   ├── Ledger.cs
│   │   │   └── ...
│   │   ├── Services/
│   │   │   ├── LendingService.cs
│   │   │   ├── ReportService.cs
│   │   │   └── ...
│   │   ├── Data/
│   │   │   ├── DbContext.cs
│   │   │   ├── Repositories/
│   │   │   │   └── ...
│   │   │   └── schema.sql
│   │   ├── Infrastructure/
│   │   │   ├── CardReader/
│   │   │   │   ├── ICardReader.cs
│   │   │   │   └── PcScCardReader.cs
│   │   │   └── Sound/
│   │   │       └── SoundPlayer.cs
│   │   ├── Common/
│   │   │   ├── WarekiConverter.cs
│   │   │   └── Enums.cs
│   │   └── Resources/
│   │       ├── Sounds/
│   │       │   ├── beep_short.wav
│   │       │   ├── beep_double.wav
│   │       │   └── beep_error.wav
│   │       └── Templates/
│   │           └── 物品出納簿テンプレート.xlsx
│   └── ICCardManager.Tests/
│       └── ...
└── docs/
    └── ...
```
